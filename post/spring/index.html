<!DOCTYPE html>
<html  dir="ltr" lang="en" data-theme=""><head>
    <title> Riley Shen | spring learning code </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.83.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description"
        content="spring learning code">
    <meta name="google-site-verification" content="Nac1UrFTdr1E1F48JLe7XQhIbKn2_WtF4VnJI8KOtew" />
    

    
    
    
    <link rel="stylesheet" href="/css/main.min.a7c9793b97840076bef76d2743ee1c90b13bd21c18674076a0cccd5dd54c723b.css" integrity="sha256-p8l5O5eEAHa&#43;920nQ&#43;4ckLE70hwYZ0B2oMzNXdVMcjs="
        crossorigin="anonymous" type="text/css">
    
    
    <link rel="stylesheet" href="/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css"
        integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS&#43;yuWSR4=" crossorigin="anonymous" type="text/css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
        integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
        crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">

    <link rel="canonical" href="/post/spring/">

    <link rel="preconnect" href="https://fonts.gstatic.com">



    
    
    
    
    <script type="text/javascript" src="/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js"
        integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin="anonymous"></script>


    
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://rileyshen.github.io/images/site-feature-image.png"/>

<meta name="twitter:title" content="spring learning code"/>
<meta name="twitter:description" content="spring learning code"/>


    
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,500;1,600;1,700&display=swap"
        rel="stylesheet">

</head><body><div class="sidebar animated fadeInDown ">
    <div class="logo-title">
        <div class="title">
            <img src="/images/profileS.jpg" alt="profile picture">
            <h3 title=""><a href="/">I&#39;m Riley Shen</a></h3>
            <div class="description">
                <p><br>Riley likes to push her limits <br>and always keep learning new things. <br>She shares her weekly learnings <br>because "if you can't explain it simply,<br>it means you didn't understand it well enough".<br></p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="mailto:ripple.shen31@gmail.com" rel="me" aria-label="e-mail">
                    <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://github.com/rileyshen" rel="me" aria-label="GitHub">
                    <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy;  Riley Shen 2022 </div>
    </div>
</div>
<div class="main">
    <div class="page-top  animated fadeInDown ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Home</a></li>
        
            
            <li><a 
                   href="/post/"
                        
                   title="">Posts</a></li>
        
            
            <li><a 
                   href="/about/"
                        
                   title="">About Me</a></li>
        
            
            <li><a 
                   href="/contact/"
                        
                   title="">Contact</a></li>
        
        
        
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
<div class="post  animated fadeInDown ">
    <div class="post-content">
        
        <div class="post-title">
            <h2>spring learning code</h2>
            
            <div class="info">
                <em class="fas fa-calendar-day"></em>
                <span class="date">
                    Fri, Apr 16, 2021
                    </span>
                <em class="fas fa-stopwatch"></em>
                <span class="reading-time">44-minute read</span>
            </div>
            
        </div>

        <h1 id="spring-code-learning-notes-with-code-examples">Spring Code Learning Notes with Code Examples</h1>
<blockquote>
<p>This is my learning note about how Spring core features like IoC, AOP works, with Code Examples .</p>
</blockquote>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#Spring_V1.0_DispatcherServlet" >Spring V1.0 DispatcherServlet</a></li>
<li><a href="#from-servlet-to-applicatoinContext" >from Servlet to ApplicatoinContext</a></li>
<li><a href="#ioc" >IoC</a></li>
<li><a href="#screenshots" >Screenshots</a></li>
<li><a href="#setup" >Setup</a></li>
<li><a href="#usage" >Usage</a></li>
<li><a href="#project-status" >Project Status</a></li>
<li><a href="#room-for-improvement" >Room for Improvement</a></li>
<li><a href="#acknowledgements" >Acknowledgements</a></li>
<li><a href="#contact" >Contact</a></li>
</ul>
<!-- * [License](#license) -->
<h2 id="spring-introduce">spring introduce</h2>
<h3 id="download">download</h3>
<figure><img src="/images/spring0.png"
         alt="image"/><figcaption>
            <h4>spring</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring1.png"
         alt="image"/><figcaption>
            <h4>spring</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring2.png"
         alt="image"/><figcaption>
            <h4>spring</h4>
        </figcaption>
</figure>

<h3 id="inport-jar">inport jar</h3>
<ul>
<li>
<p><em><strong>Beans</strong></em></p>
</li>
<li>
<p><em><strong>Core</strong></em></p>
</li>
<li>
<p><em><strong>Context</strong></em></p>
</li>
<li>
<p><em><strong>Expression</strong></em></p>
</li>
</ul>
<figure><img src="/images/spring3.png"
         alt="image"/><figcaption>
            <h4>spring</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring4.png"
         alt="image"/><figcaption>
            <h4>spring jar</h4>
        </figcaption>
</figure>

<h3 id="create-class-and-mothod">create class and mothod</h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;add.............&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><h3 id="create-an-object-with-spring--properties">create an object with Spring  properties</h3>
<p><em><strong>1. xml file in Spring properties</strong></em></p>
<figure><img src="/images/spring5.png"
         alt="image"/><figcaption>
            <h4>spring jar</h4>
        </figcaption>
</figure>

<h3 id="test">test</h3>
<p><em><strong>1. load spring properties file</strong></em></p>
<p><em><strong>2. get object from properties (bean id)</strong></em></p>
<figure><img src="/images/spring6.png"
         alt="image"/><figcaption>
            <h4>spring jar</h4>
        </figcaption>
</figure>

<h2 id="spring-ioc">Spring IOC</h2>
<h3 id="1-spring-ioc-basic-concepts"><em><strong>1. spring ioc basic concepts</strong></em></h3>
<ul>
<li>
<p><em><strong>xml encoding, factory-based design pattern, reflect</strong></em></p>
</li>
<li>
<p><em><strong>original: tightly coupled</strong></em></p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">UserService</span><span class="o">{</span>
    <span class="n">execute</span><span class="o">();</span>
    <span class="n">UserDao</span> <span class="n">dao</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserDao</span><span class="o">();</span>
    <span class="n">dao</span><span class="o">.</span><span class="na">add</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">UserDao</span><span class="o">{</span>
    <span class="n">add</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><ul>
<li><em><strong>factory-based design pattern</strong></em></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">UserService</span><span class="o">{</span>
    <span class="n">execute</span><span class="o">();</span>
    <span class="n">UserDao</span> <span class="n">dao</span> <span class="o">=</span> <span class="n">UserFactory</span><span class="o">.</span><span class="na">getDao</span><span class="o">();</span>
    <span class="n">dao</span><span class="o">.</span><span class="na">add</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">UserDao</span><span class="o">{</span>
    <span class="n">add</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">UserFactory</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">UserDao</span> <span class="nf">getDao</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">UserDao</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><ul>
<li><em><strong>IOC</strong></em></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;user&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.learn.User&#34;</span><span class="o">&gt;&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">UserFactory</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">UserDao</span> <span class="nf">getDao</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 1. xml encoding
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">classValue</span> <span class="o">=</span> <span class="n">class属性</span><span class="o">;</span>
        <span class="c1">// 2. use reflect create an object
</span><span class="c1"></span>        <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">for</span><span class="o">(</span><span class="n">Name</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">UserDao</span><span class="o">)</span><span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="2-ioc-interfacebeanfactory"><em><strong>2. IOC interface(BeanFactory)</strong></em></h3>
<ul>
<li>
<p><em><strong>BeanFactory: for String, not for developer</strong></em></p>
<ul>
<li>won&rsquo;t creates object when loading properties file</li>
</ul>
</li>
<li>
<p><em><strong>ApplicationContext</strong></em></p>
<ul>
<li>creating objects when loading properties file</li>
</ul>
</li>
</ul>
<h3 id="3--ioc-opertation-bean-managementxml"><em><strong>3.  IOC opertation Bean management(xml)</strong></em></h3>
<ul>
<li><em><strong>creating objects in xml(bean)</strong></em></li>
</ul>
<blockquote>
<p><bean id="user" class="com.learn.User"></bean></p>
</blockquote>
<ul>
<li>
<p><em><strong>bean tag properties</strong></em></p>
<ul>
<li>id, class&hellip;</li>
<li>create objects by No-argument constructor</li>
</ul>
</li>
<li>
<p><em><strong>set properties in xml</strong></em></p>
<ul>
<li>DI: set properties</li>
</ul>
</li>
<li>
<p><em><strong>DI: set method</strong></em></p>
</li>
</ul>
<ul>
<li>1). create class, and set method</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBname</span><span class="o">(</span><span class="n">String</span> <span class="n">bname</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">bname</span> <span class="o">=</span> <span class="n">bname</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><ul>
<li>2). spring xml file, set properties</li>
</ul>
<blockquote>
<bean id="book" class="com.learn.Book">
</blockquote>
<!-- property -->
<blockquote>
<p><property name="bname" value="AAA"></property>
<property name="banthor" value="BBB"></property>
</bean></p>
</blockquote>
<ul>
<li><em><strong>DI: use annotation</strong></em></li>
</ul>
<ul>
<li>1). create class, and set method, and argument constructor</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Orders</span><span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">oname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Order</span><span class="o">(</span><span class="n">String</span> <span class="n">oname</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">oname</span> <span class="o">=</span> <span class="n">oname</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><ul>
<li>2). spring xml file, use argument constructor</li>
</ul>
<blockquote>
<bean id="orders" class="com.learn.Orders">
</blockquote>
<!-- property -->
<blockquote>
<p><constructor-arg name="oname" value="ABC"></constructor-arg>
<constructor-arg name="address" value="CCC"></constructor-arg>
</bean></p>
</blockquote>
<h3 id="4--bean-managementxml-external-beans"><em><strong>4.  Bean management(xml) external beans</strong></em></h3>
<ul>
<li>2 classes: service and dao</li>
<li>call methods in dao from service class</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// service and dao objects: 在service层创建UserDAO类，生成set方法
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;userService&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.learn.service.UserService&#34;</span><span class="o">&gt;</span>
<span class="c1">// inject userDao object
</span><span class="c1">// name attribute: class attribute name private UserDao userDao;
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;userDao&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;userDaoImpl&#34;</span><span class="o">&gt;&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;userDaoImpl&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.learn.dao.UserDaoImpl&#34;</span><span class="o">&gt;&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>
</code></pre></div><h3 id="5--bean-managementxml-inner-beans-and-cascade-assignment"><em><strong>5.  Bean management(xml) inner beans and Cascade assignment</strong></em></h3>
<ul>
<li>1 对多关系： 部门和员工</li>
<li>在实体类之间表示 1 对多关系</li>
</ul>
<p><strong>department</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dept</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">dname</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDname</span><span class="o">(</span><span class="n">String</span> <span class="n">dname</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dname</span> <span class="o">=</span> <span class="n">dname</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>employ</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Emp</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">ename</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Dept</span> <span class="n">dept</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDept</span><span class="o">(</span><span class="n">Dept</span> <span class="n">dept</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dept</span> <span class="o">=</span> <span class="n">dept</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><em><strong>xml</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// inner bean
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;emp&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.learn.bean.Emp&#34;</span><span class="o">&gt;</span>
<span class="c1">// inject userDao object
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;ename&#34;</span> <span class="n">value</span><span class="o">=</span><span class="s">&#34;lucy&#34;</span><span class="o">&gt;&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
<span class="c1">// method 1
</span><span class="c1">// &lt;property name=&#34;dept&#34; ref=&#34;dame&#34;&gt;&lt;/property&gt;
</span><span class="c1">// method 2
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;dept&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;dept&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.learn.bean.Dept&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;dname&#34;</span> <span class="n">value</span><span class="o">=</span><span class="s">&#34;IT&#34;</span><span class="o">&gt;&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

</code></pre></div><h3 id="6--bean-managementxml-array-list-map"><em><strong>6.  Bean management(xml) array, list, map</strong></em></h3>
<p><strong>6.1 class and set method</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Stu</span> <span class="o">{</span>
    <span class="c1">// array
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span><span class="o">[]</span> <span class="n">courses</span><span class="o">;</span>
    <span class="c1">// list
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">;</span>

    <span class="c1">// map
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">maps</span><span class="o">;</span>

    <span class="c1">// set
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">sets</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCourses</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">courses</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">courses</span> <span class="o">=</span> <span class="n">courses</span><span class="o">;</span>
    <span class="o">}</span>
      
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setList</span><span class="o">(</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">list</span> <span class="o">=</span>  <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMap</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">maps</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">maps</span> <span class="o">=</span>  <span class="n">maps</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSet</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">sets</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sets</span> <span class="o">=</span>  <span class="n">sets</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>6.2 xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;stu&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.learn.conllectiontype.Stu&#34;</span><span class="o">&gt;</span>

<span class="c1">// array
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;courses&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">array</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">java</span> <span class="kd">class</span> <span class="err">&lt;/</span><span class="nc">value</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">sql</span> <span class="kd">class</span> <span class="err">&lt;/</span><span class="nc">value</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">array</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">property</span><span class="o">&gt;</span>

<span class="c1">// list
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;list&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">list</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">AAA</span> <span class="o">&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">BBB</span> <span class="kd">class</span> <span class="err">&lt;/</span><span class="nc">value</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">list</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">property</span><span class="o">&gt;</span>

<span class="c1">// MAP
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;maps&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">map</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">entry</span><span class="o">&gt;</span><span class="n">key</span><span class="o">=</span><span class="s">&#34;JAVA&#34;</span> <span class="n">value</span><span class="o">=</span><span class="s">&#34;jva&#34;</span><span class="o">&lt;/</span><span class="n">entry</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">entry</span><span class="o">&gt;</span><span class="n">key</span><span class="o">=</span><span class="s">&#34;PHP&#34;</span> <span class="n">value</span><span class="o">=</span><span class="s">&#34;php&#34;</span><span class="o">&lt;/</span><span class="n">entry</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">map</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">property</span><span class="o">&gt;</span>

<span class="c1">// set
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;sets&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">set</span><span class="o">&gt;</span>
       <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">MySQL</span> <span class="o">&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">Redis</span> <span class="o">&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">set</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

</code></pre></div><h3 id="7--bean-managementset-object-type-in-collection"><em><strong>7.  Bean managementset object type in collection</strong></em></h3>
<p><strong>7.1 class and set method</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Course</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">cname</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCname</span><span class="o">(</span><span class="n">String</span> <span class="n">cname</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">cname</span> <span class="o">=</span> <span class="n">cname</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Stu</span> <span class="o">{</span>
    <span class="c1">// array
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span><span class="o">[]</span> <span class="n">courses</span><span class="o">;</span>
    <span class="c1">// list
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">;</span>

    <span class="c1">// map
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">maps</span><span class="o">;</span>

    <span class="c1">// set
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">sets</span><span class="o">;</span>

    <span class="c1">// ===============coursed students take===============
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Course</span><span class="o">&gt;</span> <span class="n">courseList</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCourseList</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Course</span><span class="o">&gt;</span> <span class="n">courseList</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">courseList</span> <span class="o">=</span> <span class="n">courseList</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// ===============coursed students take===============
</span><span class="c1"></span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCourses</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">courses</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">courses</span> <span class="o">=</span> <span class="n">courses</span><span class="o">;</span>
    <span class="o">}</span>
      
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setList</span><span class="o">(</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">list</span> <span class="o">=</span>  <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMap</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">maps</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">maps</span> <span class="o">=</span>  <span class="n">maps</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSet</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">sets</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sets</span> <span class="o">=</span>  <span class="n">sets</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>7.2 xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;stu&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.learn.conllectiontype.Stu&#34;</span><span class="o">&gt;</span>

<span class="c1">// array
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;courses&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">array</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">java</span> <span class="kd">class</span> <span class="err">&lt;/</span><span class="nc">value</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">sql</span> <span class="kd">class</span> <span class="err">&lt;/</span><span class="nc">value</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">array</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">property</span><span class="o">&gt;</span>

<span class="c1">// list
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;list&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">list</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">AAA</span> <span class="o">&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">BBB</span> <span class="kd">class</span> <span class="err">&lt;/</span><span class="nc">value</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">list</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">property</span><span class="o">&gt;</span>

<span class="c1">// MAP
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;maps&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">map</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">entry</span><span class="o">&gt;</span><span class="n">key</span><span class="o">=</span><span class="s">&#34;JAVA&#34;</span> <span class="n">value</span><span class="o">=</span><span class="s">&#34;jva&#34;</span><span class="o">&lt;/</span><span class="n">entry</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">entry</span><span class="o">&gt;</span><span class="n">key</span><span class="o">=</span><span class="s">&#34;PHP&#34;</span> <span class="n">value</span><span class="o">=</span><span class="s">&#34;php&#34;</span><span class="o">&lt;/</span><span class="n">entry</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">map</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">property</span><span class="o">&gt;</span>

<span class="c1">// set
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;sets&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">set</span><span class="o">&gt;</span>
       <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">MySQL</span> <span class="o">&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">Redis</span> <span class="o">&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">set</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

<span class="c1">// ===============inject list collection type, value is object===============
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;courseList&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">list</span><span class="o">&gt;</span>
       <span class="o">&lt;</span><span class="n">ref</span> <span class="n">bean</span><span class="o">=</span><span class="s">&#34;course1&#34;</span><span class="o">&gt;&lt;/</span><span class="n">ref</span><span class="o">&gt;</span>
       <span class="o">&lt;</span><span class="n">ref</span> <span class="n">bean</span><span class="o">=</span><span class="s">&#34;course2&#34;</span><span class="o">&gt;&lt;/</span><span class="n">ref</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">list</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
<span class="c1">// ===============create multiple course objects===============
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;course1&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.learn.collectiontype.Course&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;cname&#34;</span> <span class="n">value</span><span class="o">=</span><span class="s">&#34;Spring5&#34;</span><span class="o">&gt;&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;course2&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.learn.collectiontype.Course&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;cname&#34;</span> <span class="n">value</span><span class="o">=</span><span class="s">&#34;MyBatis&#34;</span><span class="o">&gt;&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>
</code></pre></div><h3 id="8--extract-injection-in-collection"><em><strong>8.  extract injection in collection</strong></em></h3>
<p><strong>8.1 Book class</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public class Book {
    private List&lt;String&gt; list;
    public void setList(List&lt;String&gt; list) {
        this.list = list;
    }

    public String toString() {
        
    }

    public void test() {
        System.out.println(list);
    }

}
</code></pre></div><p><strong>8.2 in xml import name space util</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="o">&lt;</span><span class="n">bean</span> <span class="n">xmlns</span><span class="o">=</span><span class="s">&#34;&#34;</span>
      <span class="n">xmlns</span><span class="o">:</span><span class="n">p</span><span class="o">=</span><span class="s">&#34;&#34;</span>
    <span class="c1">//   copy xmlns:p
</span><span class="c1"></span>      <span class="n">xmlns</span><span class="o">:</span><span class="n">util</span><span class="o">=</span><span class="s">&#34;http://www.springframework.org/schema/util&#34;</span>

    <span class="c1">//   change xsi:schemaLocation beans to util
</span><span class="c1"></span>    <span class="c1">//   xsi:schemaLocation=&#34;http://www.springframework.org/schema/beans&#34; &#34;http://www.springframework.org/schema/beans/spring-beans.xsd&#34;
</span><span class="c1"></span>      <span class="n">xsi</span><span class="o">:</span><span class="n">schemaLocation</span><span class="o">=</span><span class="s">&#34;http://www.springframework.org/schema/util&#34;</span> <span class="s">&#34;http://www.springframework.org/schema/util/spring-util.xsd&#34;</span><span class="o">&gt;</span>
</code></pre></div><p><strong>8.3 util tag</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 1. list=====================
</span><span class="c1"></span><span class="o">&lt;</span><span class="n">util</span><span class="o">:</span><span class="n">list</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;bookList&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">AAA</span> <span class="o">&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">BBB</span><span class="o">&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">CCC</span><span class="o">&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">util</span><span class="o">:</span><span class="n">list</span><span class="o">&gt;</span>
</code></pre></div><p><strong>8.4 test</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCollection</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">&#34;bean2.xml&#34;</span><span class="o">);</span>
<span class="n">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;book&#34;</span><span class="o">,</span> <span class="n">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">book</span><span class="o">.</span><span class="na">test</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div><h3 id="9--ioc-manage-bean-factory-beans"><em><strong>9.  IOC manage Bean (factory beans)</strong></em></h3>
<p><strong>9.1 ordinary beans 定义 bean 类型就是返回类型</strong></p>
<p><strong>9.2 factory beans 配置文件定义 bean 类型和返回类型不一样</strong></p>
<ul>
<li>
<p>9.2.1 创建类，作为工厂 bean， 实现接口 FactoryBean</p>
</li>
<li>
<p>9.2.2 实现接口里面的方法，在方法中定义返回的 bean 类型</p>
</li>
</ul>
<figure><img src="/images/spring7.png"
         alt="image"/><figcaption>
            <h4>spring factorybean</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring8.png"
         alt="image"/><figcaption>
            <h4>spring factorybean</h4>
        </figcaption>
</figure>

<h3 id="10-spring-bean-scopes"><em><strong>10. Spring Bean Scopes</strong></em></h3>
<p><strong>10.1 single or instances will be created 单实例多实例</strong>
<strong>10.2 default model is single instance 默认 spring bean 是单实例对象</strong>
<strong>10.3 scope is used to set single or multiple: singleton or protype</strong>
<strong>10.4 singleton vs protype</strong></p>
<ul>
<li>singleton: create instance when load spring xml file</li>
<li>prototype: create instances when <strong>getBean</strong> method</li>
</ul>
<h3 id="11-spring-bean-lifecycle"><em><strong>11. Spring Bean Lifecycle</strong></em></h3>
<p><strong>11.1 create instance by constructor(no-argument constructor)</strong>
<figure><img src="/images/spring9.png"
         alt="image"/><figcaption>
            <h4> Spring Bean Lifecycle</h4>
        </figcaption>
</figure>
</p>
<figure><img src="/images/spring10.png"
         alt="image"/><figcaption>
            <h4> Spring Bean Lifecycle</h4>
        </figcaption>
</figure>

<p><strong>11.2 set bean property and ref(set method)</strong>
<figure><img src="/images/spring11.png"
         alt="image"/><figcaption>
            <h4> Spring Bean Lifecycle</h4>
        </figcaption>
</figure>
</p>
<p><strong>11.3 call the init() method(init-method in the xml based configuration file)</strong>
<figure><img src="/images/spring12.png"
         alt="image"/><figcaption>
            <h4> Spring Bean Lifecycle</h4>
        </figcaption>
</figure>
</p>
<figure><img src="/images/spring13.png"
         alt="image"/><figcaption>
            <h4> Spring Bean Lifecycle</h4>
        </figcaption>
</figure>

<p><strong>11.4 use bean</strong></p>
<figure><img src="/images/spring14.png"
         alt="image"/><figcaption>
            <h4> Spring Bean Lifecycle</h4>
        </figcaption>
</figure>

<p><strong>11.5 destroy Spring Bean (destroy-method in the xml based configuration file)</strong></p>
<figure><img src="/images/spring15.png"
         alt="image"/><figcaption>
            <h4> Spring Bean Lifecycle</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring16.png"
         alt="image"/><figcaption>
            <h4> Spring Bean Lifecycle</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring17.png"
         alt="image"/><figcaption>
            <h4> Spring Bean Lifecycle</h4>
        </figcaption>
</figure>

<h3 id="12bean-post-processor-7-steps-of-life-cycle"><em><strong>12.bean post processor (7 steps of life cycle)</strong></em></h3>
<p><strong>12.1 create instance by constructor(no-argument constructor)</strong></p>
<ul>
<li>create class, implement interface BeanPostProcessor</li>
</ul>
<figure><img src="/images/spring18.png"
         alt="image"/><figcaption>
            <h4> Spring Bean Lifecycle</h4>
        </figcaption>
</figure>

<p><strong>12.2 set bean property and ref(set method)</strong></p>
<figure><img src="/images/spring19.png"
         alt="image"/><figcaption>
            <h4> Spring Bean Lifecycle</h4>
        </figcaption>
</figure>

<p><strong>12.3 pass bean instance to post processor</strong></p>
<p><strong>12.4 call the init() method(init-method in the xml based configuration file)</strong></p>
<p><strong>12.5 pass bean instance to post processor</strong></p>
<p><strong>12.6 use bean</strong></p>
<p><strong>12.7 destroy Spring Bean (destroy-method in the xml based configuration file)</strong></p>
<figure><img src="/images/spring20.png"
         alt="image"/><figcaption>
            <h4> Spring Bean Lifecycle</h4>
        </figcaption>
</figure>

<h3 id="13ioc-管理-bean-xml-autowire"><em><strong>13.ioc 管理 bean （xml autowire）</strong></em></h3>
<p><strong>13.1 autowire: byName: 注入值 bean 的 id 值和类里面属性名称要一样</strong></p>
<blockquote>
<bean id="emp" class="com.learn.autowire.Emp" autowire="byName">
</blockquote>
<p><strong>13.2 autowire: byName, byType</strong></p>
<blockquote>
<bean id="emp" class="com.learn.autowire.Emp" autowire="byType">
</blockquote>
<h3 id="14ioc-管理-bean-外部属性"><em><strong>14.ioc 管理 bean （外部属性）</strong></em></h3>
<p><strong>14.1 直接配置数据库信息（not recommend）</strong>
<figure><img src="/images/spring21.png"
         alt="image"/><figcaption>
            <h4>Spring ioc</h4>
        </figcaption>
</figure>
</p>
<p><strong>14.2 引入外部属性文件配置数据库连接池</strong>
<em><strong>create properties file</strong></em>
<figure><img src="/images/spring22.png"
         alt="image"/><figcaption>
            <h4>Spring ioc</h4>
        </figcaption>
</figure>
</p>
<p><em><strong>import context name space</strong></em>
<figure><img src="/images/spring23.png"
         alt="image"/><figcaption>
            <h4>Spring ioc</h4>
        </figcaption>
</figure>
</p>
<figure><img src="/images/spring24.png"
         alt="image"/><figcaption>
            <h4>Spring ioc</h4>
        </figcaption>
</figure>

<h2 id="spring-ioc-annotation">spring IOC annotation</h2>
<ul>
<li><em><strong>1. @Compoment</strong></em></li>
<li><em><strong>2. @Service</strong></em></li>
<li><em><strong>3. @Controller</strong></em></li>
<li><em><strong>4. @Repository</strong></em></li>
</ul>
<h3 id="dependency">dependency</h3>
<ul>
<li><em><strong>spring-aop</strong></em></li>
</ul>
<h3 id="start-component-scan">start component scan</h3>
<figure><img src="/images/spring25.png"
         alt="image"/><figcaption>
            <h4>annotation</h4>
        </figcaption>
</figure>

<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="o">&lt;</span><span class="n">context</span><span class="o">:</span><span class="n">component</span><span class="o">-</span><span class="n">scan</span> <span class="n">base</span><span class="o">-</span><span class="n">package</span><span class="o">=</span><span class="s">&#34;com.learn&#34;</span><span class="o">&gt;&lt;/</span><span class="n">context</span><span class="o">:</span><span class="n">component</span><span class="o">-</span><span class="n">scan</span><span class="o">&gt;</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="o">&lt;</span><span class="n">context</span><span class="o">:</span><span class="n">component</span><span class="o">-</span><span class="n">scan</span> <span class="n">base</span><span class="o">-</span><span class="n">package</span><span class="o">=</span><span class="s">&#34;com.learn&#34;</span> <span class="n">use</span><span class="o">-</span><span class="k">default</span><span class="o">-</span><span class="n">filter</span><span class="o">=</span><span class="s">&#34;false&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">context</span><span class="o">:</span><span class="n">include</span><span class="o">-</span><span class="n">filter</span> <span class="n">type</span><span class="o">=</span><span class="s">&#34;anotation&#34;</span> <span class="n">expreesion</span><span class="o">=</span><span class="s">&#34;org.springframework.steretype.Controller&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">context</span><span class="o">:</span><span class="n">component</span><span class="o">-</span><span class="n">scan</span><span class="o">&gt;</span>
</code></pre></div><h3 id="set-properties-annotation">set properties (annotation)</h3>
<p><strong>1.1 @AotuWired: 根据属性类型进行自动装配</strong></p>
<p><strong>1.2 @Qualifier：根据属性名称进行注入</strong></p>
<p><strong>1.3 @Resource： 可以根据类型注入，可以根据名称注入</strong></p>
<p><strong>1.4 @Value： 注入普通类型属性</strong></p>
<h3 id="steps-annotation">steps (annotation)</h3>
<p><strong>1.1 dao and service annotation</strong></p>
<ul>
<li>@Resource (UserDaoImpl)</li>
<li>@Service (UserService)</li>
</ul>
<figure><img src="/images/spring26.png"
         alt="image"/><figcaption>
            <h4>annotation</h4>
        </figcaption>
</figure>

<p><strong>Field injection is not recommended（不再推荐使用字段注入)但是国内的使用场景有时候比国外复杂很多，实际情况，就一个业务单元，国内的公司几轮需求加上来，注入的服务就会牵扯到十几个，用构造器注入，奇丑无比；用传统的分层结构，光数据库 dao 的注入，都是好几个</strong></p>
<p><strong>1.2 dao and service annotation</strong></p>
<ul>
<li>@Resource(name = &ldquo;userDaoImpl1&rdquo;)</li>
<li>@AutoWired + @Qualifier(value = &ldquo;userDaoImpl1&rdquo;)</li>
</ul>
<figure><img src="/images/spring27.png"
         alt="image"/><figcaption>
            <h4>annotation</h4>
        </figcaption>
</figure>

<h3 id="完全注解开发">完全注解开发</h3>
<p><strong>2.1 comfig class</strong></p>
<figure><img src="/images/spring28.png"
         alt="image"/><figcaption>
            <h4>annotation</h4>
        </figcaption>
</figure>

<p><strong>2.2 test</strong></p>
<figure><img src="/images/spring29.png"
         alt="image"/><figcaption>
            <h4>annotation</h4>
        </figcaption>
</figure>

<h2 id="spring-aop">spring AOP</h2>
<h3 id="spring-aop-1">spring AOP</h3>
<p><strong>1.0 面向切面</strong>
<strong>1.1 登录功能</strong></p>
<h3 id="aop-底层原理底层使用动态代理">AOP 底层原理：底层使用动态代理</h3>
<h3 id="20-有接口使用-jdk-动态代理"><strong>2.0 有接口，使用 JDK 动态代理</strong></h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">interface</span> <span class="nc">UserDao</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">login</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">UserDao</span> <span class="kd">implements</span> <span class="n">UserDao</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">login</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 登录实现过程
</span><span class="c1"></span>    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><ul>
<li>
<p><em><strong>JDK 动态代理</strong></em></p>
<ul>
<li>
<ol>
<li>创建 UserDao 接口实现类代理对象</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>2.1 没有接口，使用 CGLIB 动态代理</strong></p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">()</span> <span class="o">{</span>
        <span class="err">。。。。</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">Person</span> <span class="kd">extends</span> <span class="n">User</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">add</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><ul>
<li>
<p><em><strong>CGLIB 动态代理</strong></em></p>
<ul>
<li>
<ol>
<li>创建当前子类代理对象</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>2.3 AOP JDK 使用 Proxy 代理对象</strong></p>
</li>
<li>
<p><strong>2.4 使用 newProxyInstance 方法代理对象</strong></p>
<ul>
<li>3 个参数</li>
<li>ClassLoader 类加载器</li>
<li>类&lt;?&gt;[] interface 增加方法所在的类，这个类实现的接口，支持多个接口</li>
<li>InvocationHandler 实现这个接口 InvocationHandler， 创建代理对象，写增加的方法</li>
</ul>
</li>
<li>
<p><strong>2.5 使用 JDK 动态代理代码</strong></p>
</li>
</ul>
<ul>
<li>创建接口， 定义方法</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Userdao</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">);</span>

    <span class="n">String</span> <span class="nf">update</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">);</span>

<span class="o">}</span>
</code></pre></div><ul>
<li>创建接口实现类, 实现方法</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDaoImpl</span> <span class="kd">implements</span> <span class="n">Userdao</span><span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;add方法之前执行le&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">update</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;update方法之前执行le&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDaoImpl</span> <span class="kd">implements</span> <span class="n">Userdao</span><span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">update</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><ul>
<li>使用 Proxy 类创建接口代理对象</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JDKProxy</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">Class</span><span class="o">[]</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="o">{</span><span class="n">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">};</span>

        <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">JDKProxy</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="n">interfaces</span><span class="o">,</span> <span class="k">new</span> <span class="n">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>
           <span class="nd">@Override</span>
           <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
               <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
           <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
</code></pre></div><p>or</p>
<ol>
<li>创建代理对象代理</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JDKProxy</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">Class</span><span class="o">[]</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="o">{</span><span class="n">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">};</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">UserDaoProxy</span> <span class="kd">implements</span> <span class="n">InvocationHandler</span> <span class="o">{</span>
      <span class="c1">// 1. 把创建的是谁的代理对象，把谁传递过来
</span><span class="c1"></span>     <span class="c1">// 有参数构造传递
</span><span class="c1"></span>     <span class="kd">private</span> <span class="n">Object</span> <span class="n">obj</span><span class="o">;</span>
     <span class="kd">public</span> <span class="nf">UserDaoProxy</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">;</span>
     <span class="o">}</span>
     <span class="c1">// 增加的逻辑
</span><span class="c1"></span>         <span class="c1">// 增加的逻辑
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span> 
         <span class="c1">// 方法之前
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;方法之前执行..............&#34;</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; : 传递的参数&#34;</span> <span class="o">+</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">res</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;方法之后执行...........&#34;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>   
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JDKProxy</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">Class</span><span class="o">[]</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="o">{</span><span class="n">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">};</span>

        <span class="n">UserDaoImpl</span> <span class="n">userDao</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserDaoImpl</span><span class="o">();</span>

        <span class="n">UserDao</span> <span class="n">dao</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserDao</span><span class="o">)</span><span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">JDKProxy</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="n">interfaces</span><span class="o">,</span> <span class="k">new</span> <span class="n">UserDaoProxy</span><span class="o">(</span><span class="n">userDao</span><span class="o">));</span>

         <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">2</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="30-aop-操作"><strong>3.0 AOP 操作</strong></h3>
<ul>
<li>
<p>3.1 Spring 框架一般基于 AspectJ 实现 AOP 操作</p>
</li>
<li>
<p>3.2 AOP 相关依赖</p>
</li>
<li>
<p>3.3 切入点表达式</p>
</li>
</ul>
<p>execution([权限修饰符][返回类型][类全路径]<a href="[%e5%8f%82%e6%95%b0%e5%88%97%e8%a1%a8]" >方法名称</a>)</p>
<p>execution([public/private][返回类型/ 忽略][类全路径]<a href="[%e5%8f%82%e6%95%b0%e5%88%97%e8%a1%a8]" >方法名称</a>)</p>
<p><em><strong>ex1: com.learn.dao.BookDao 里面 add 进行增强</strong></em>
execution(*com.learn.dao.BookDao.add(..))</p>
<p><em><strong>ex2: com.learn.dao.BookDao 里面所有的方法进行增强</strong></em>
execution(<em>com.learn.dao.BookDao.</em>(..))</p>
<p><em><strong>ex3: 对 com.learn.dao 包里面所有类，类里面所有的方法进行增强</strong></em>
execution(<em>com.learn.dao.</em>.*(..))</p>
<h3 id="40-aop-aspectj-注解"><strong>4.0 AOP AspectJ 注解</strong></h3>
<ul>
<li>4.1 创建类， 在类里面定义方法</li>
</ul>
<p>被增强类</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;add...........&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><ul>
<li>4.2 创建增强类(编写增强逻辑)
<ul>
<li>在增强类里面，创建方法，让不同方法代表不同通知类型</li>
</ul>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 增强类
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserProxy</span> <span class="o">{</span>

    <span class="c1">// 前置通知
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before......................&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><ul>
<li>4.3 进行通知的配置
<ul>
<li>在 spring 配置文件中，开启注解扫描</li>
<li>使用注解创建 User 和 UserProxy 对象</li>
</ul>
</li>
</ul>
<figure><img src="/images/spring30.png"
         alt="image"/><figcaption>
            <h4>Spring aop</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring31.png"
         alt="image"/><figcaption>
            <h4>Spring aop</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring32.png"
         alt="image"/><figcaption>
            <h4>Spring aop</h4>
        </figcaption>
</figure>

<ul>
<li>4.4 在增强类上面添加注解 @Aspect</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 增强类
</span><span class="c1"></span><span class="nd">@Component</span>
<span class="nd">@Aspect</span> <span class="c1">// 生成代理对象
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserProxy</span> <span class="o">{</span>

    <span class="c1">// 前置通知
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before......................&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><ul>
<li>4.5 在 spring 配置文件中开启生成代理对象</li>
</ul>
<figure><img src="/images/spring33.png"
         alt="image"/><figcaption>
            <h4> Spring aop</h4>
        </figcaption>
</figure>

<ul>
<li>
<p>配置不同类型的通知</p>
<ul>
<li>在增强类的里面，在作为通知方法上面添加通知类型注解，使用切入点表达式配置</li>
</ul>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 增强类
</span><span class="c1"></span><span class="nd">@Component</span>
<span class="nd">@Aspect</span> <span class="c1">// 生成代理对象
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserProxy</span> <span class="o">{</span>

    <span class="c1">// 前置通知
</span><span class="c1"></span>    <span class="c1">// @Before 注解表示作为配置通知
</span><span class="c1"></span>    <span class="nd">@Before</span><span class="o">(</span><span class="s">&#34;execution(*com.learn.aop.User.add(..)&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before......................&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><figure><img src="/images/spring34.png"
         alt="image"/><figcaption>
            <h4>Spring aop</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring35.png"
         alt="image"/><figcaption>
            <h4>Spring aop</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring36.png"
         alt="image"/><figcaption>
            <h4>Spring aop</h4>
        </figcaption>
</figure>

<ul>
<li>4.6 公共切入点抽取</li>
</ul>
<figure><img src="/images/spring37.png"
         alt="image"/><figcaption>
            <h4>Spring aop</h4>
        </figcaption>
</figure>

<ul>
<li>4.7 有多个增强类多同一个方法进行增强， 设置增强类优先
<ul>
<li>在增强类上面添加注解 @Order(数字类型值)， 小优先级越高</li>
</ul>
</li>
</ul>
<figure><img src="/images/spring38.png"
         alt="image"/><figcaption>
            <h4>Spring aop</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring39.png"
         alt="image"/><figcaption>
            <h4>Spring aop</h4>
        </figcaption>
</figure>

<h3 id="50-aop-aspectj-配置文件"><strong>5.0 AOP AspectJ 配置文件</strong></h3>
<ul>
<li>
<p>5.1 两个类，增强类和被增强类， 创建方法</p>
</li>
<li>
<p>5.2 在 spring 配置文件中创建两个类对象</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;book&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.learn.aopxml.Book&#34;</span><span class="o">&gt;&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>
    
    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;bookProxy&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.learn.aopxml.BookProxy&#34;</span><span class="o">&gt;&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>
</code></pre></div><ul>
<li>5.3 在 spring 配置文件中配置切入点</li>
</ul>
<figure><img src="/images/spring40.png"
         alt="image"/><figcaption>
            <h4>Spring aop</h4>
        </figcaption>
</figure>

<h2 id="spring-data-access-jdbc">spring data access: JDBC</h2>
<h3 id="jdbctemplate">JdbcTemplate</h3>
<h3 id="10-dependency-jar"><strong>1.0 dependency jar</strong></h3>
<ul>
<li>
<p>mysql-connector-java (Java 连接 MySQL 需要驱动包，否则 JDBC 无法访问数据库)</p>
</li>
<li>
<p>druid (在 JDBC 访问数据库的时候是通过连接来完成的，但是连接的打开及关闭非常耗时，这时就是数据库连接池的作用了，他来管理这个数据库连接，不会用完立即关闭，可以缓存起来，供下次使用，为 JDBC 连接数据库提供锦上添花的作用，Druid 就是一个数据库连接池，用来管理数据库连接池的)</p>
</li>
<li>
<p>spring-jdbc (Spring JDBC 框架负责所有的低层细节，从开始打开连接，准备和执行
SQL 语句，处理异常，处理事务，到最后关闭连接)</p>
</li>
<li>
<p>spring-tx：为 JDBC、Hibernate、JDO、JPA 等提供的一致的声明式和编程式事务管理</p>
</li>
<li>
<p>spring-orm (ORM 的全称是 Object Relational Mapping，即对象关系映射。它的实现思想就是将关系数据库中表的数据映射成为对象，以对象的形式展现，这样开发人员就可以把对数据库的操作转化为对这些对象的操作。因此它的目的是为了方便开发人员以面向对象的思想来实现对数据库的操作)</p>
</li>
</ul>
<h3 id="20-在-spring-配置文件配置数据库连接池"><strong>2.0 在 spring 配置文件配置数据库连接池</strong></h3>
<h3 id="30-配置-jdbctemplate-对象-注入-datasource"><strong>3.0 配置 JdbcTemplate 对象， 注入 DataSource</strong></h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="o">&lt;!--</span><span class="n">JdbcTemplate</span> <span class="n">对象</span><span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;jdbcTemplate&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;org.springframework.jdbc.core.JdbcTemplate&#34;</span><span class="o">&gt;</span>

        <span class="o">&lt;!--</span><span class="n">set方法注入dataSource</span><span class="o">--&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;dataSource&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;dataSource&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

</code></pre></div><h3 id="40-创建-service-类创建-dao-类在-dao-注入-jdbctemplate-对象"><strong>4.0 创建 service 类，创建 dao 类，在 dao 注入 jdbcTemplate 对象</strong></h3>
<ul>
<li>4.1 开启组件扫描</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="o">&lt;!--</span><span class="n">4</span><span class="o">.</span><span class="na">1</span> <span class="n">开启组件扫描</span><span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="n">context</span><span class="o">:</span><span class="n">component</span><span class="o">-</span><span class="n">scan</span> <span class="n">base</span><span class="o">-</span><span class="n">package</span><span class="o">=</span><span class="s">&#34;com.learn&#34;</span><span class="o">/&gt;</span>
</code></pre></div><ul>
<li>4.2 Service 类</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookService</span> <span class="o">{</span>

    <span class="c1">// 注入dao
</span><span class="c1"></span>    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">BookDao</span> <span class="n">bookDao</span> <span class="o">;</span>
<span class="o">}</span>
</code></pre></div><ul>
<li>4.3 Dao 类</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookDaoImpl</span> <span class="kd">implements</span> <span class="n">BookDao</span><span class="o">{</span>

    <span class="c1">// 注入jdbcTemplate
</span><span class="c1"></span>    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>
<span class="o">}</span>

</code></pre></div><h3 id="jdbctemplate-操作数据库添加功能">JdbcTemplate 操作数据库，添加功能</h3>
<h3 id="10-对应数据库实体类"><strong>1.0 对应数据库实体类</strong></h3>
<h3 id="20-编写-service-和-dao"><strong>2.0 编写 service 和 dao</strong></h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookDaoImpl</span> <span class="kd">implements</span> <span class="n">BookDao</span><span class="o">{</span>

    <span class="c1">// 注入jdbcTemplate
</span><span class="c1"></span>    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

    <span class="c1">// 添加的方法
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Book</span> <span class="n">book</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 1. 创建 sql 语句
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;insert into t_book values(?, ?, ?)&#34;</span><span class="o">;</span>
        <span class="c1">// 2. 调用方法实现
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">update</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">book</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">book</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">book</span><span class="o">.</span><span class="na">getUstatus</span><span class="o">());</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
    <span class="o">}</span>
       
    <span class="c1">// 删除的方法
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">del</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 1. 创建 sql 语句
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;delete from t_book where user_id=?&#34;</span><span class="o">;</span>
        <span class="c1">// 2. 调用方法实现
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">update</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
    <span class="o">}</span>
           <span class="c1">// 更新的方法
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">Book</span> <span class="n">book</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 1. 创建 sql 语句
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;update t_book set username=?, ustatus=? where user_id=?&#34;</span><span class="o">;</span>
        <span class="c1">// 2. 调用方法实现
</span><span class="c1"></span>       <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="o">{</span><span class="n">book</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">book</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">book</span><span class="o">.</span><span class="na">getUstatus</span><span class="o">()};</span>
        <span class="kt">int</span> <span class="n">update</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>


</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAdd</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">&#34;bean1.xml&#34;</span><span class="o">);</span>
        <span class="n">BookService</span> <span class="n">bookService</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;bookService&#34;</span><span class="o">,</span> <span class="n">BookService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Book</span><span class="o">();</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="s">&#34;2&#34;</span><span class="o">);</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">&#34;bb&#34;</span><span class="o">);</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setUstatus</span><span class="o">(</span><span class="s">&#34;b&#34;</span><span class="o">);</span>
        <span class="n">bookService</span><span class="o">.</span><span class="na">addBook</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div><h3 id="jdbctemplate-操作数据库查询">JdbcTemplate 操作数据库，查询</h3>
<h3 id="查询表有多少条记录"><strong>查询表有多少条记录</strong></h3>
<ul>
<li>SELECT COUNT(*) FROM t_book</li>
</ul>
<h3 id="查询返回某个值"><strong>查询返回某个值</strong></h3>
<ul>
<li><em><strong>1. 查询表有多少条记录， 返回某个值</strong></em></li>
<li><em><strong>2. 使用 JdbcTemplate 查询表有多少条记录， 返回某个值</strong></em>
<ul>
<li><em><strong>queryForObject(String sql, Class<T> requireType)</strong></em></li>
<li><em><strong>第一个参数 sql 语句</strong></em></li>
<li><em><strong>第二个参数， 返回类性 Class（Integer.class, String.class)</strong></em></li>
</ul>
</li>
<li><em><strong>3. daoImpl</strong></em></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">selectCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select count(*) from t_book&#34;</span><span class="o">;</span>
        <span class="n">Integer</span> <span class="n">count</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">count</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><h3 id="查询返回对象"><strong>查询返回对象</strong></h3>
<ul>
<li><em><strong>1. 场景： 查询图书详情</strong></em></li>
<li><em><strong>2. 使用 JdbcTemplate 查询返回对象</strong></em>
<ul>
<li><em><strong>queryForObject(String sql, RowMappper<T> rowMapper, Object&hellip; args)</strong></em></li>
<li><em><strong>第一个参数 sql（select * from t_book where user_id=?）语句</strong></em></li>
<li><em><strong>第二个参数: RowMapper， 是接口， 返回不同类型数据，使用这个接口里面实现类完成数据封装 new BeanPropertyRowMapper<Book>(Book.class)</strong></em></li>
<li><em><strong>第三个参数: sql 语句值（问号里面的值 id）</strong></em></li>
</ul>
</li>
<li><em><strong>3. daoImpl</strong></em></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="kd">public</span> <span class="n">Book</span> <span class="nf">findBookInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select * from t_book where user_id=?&#34;</span><span class="o">;</span>
        <span class="n">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="k">new</span> <span class="n">BeanPropertyRowMapper</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;(</span><span class="n">Book</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">id</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">book</span><span class="o">;</span>
    <span class="o">}</span>

</code></pre></div><h3 id="查询返回集合"><strong>查询返回集合</strong></h3>
<ul>
<li><em><strong>1. 场景： 查询图书列表分页</strong></em></li>
<li><em><strong>2. 使用 JdbcTemplate 查询返回集合</strong></em>
<ul>
<li><em><strong>query(String sql, RowMappper<T> rowMapper, Object&hellip; args)</strong></em></li>
<li><em><strong>第一个参数 sql 语句</strong></em></li>
<li><em><strong>第二个参数: RowMapper， 是接口， 返回不同类型数据，使用这个接口里面实现类完成数据封装 new BeanPropertyRowMapper<Book>(Book.class)</strong></em></li>
<li><em><strong>第三个参数: 可以省略</strong></em></li>
</ul>
</li>
<li><em><strong>3. daoImpl</strong></em></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select * from t_book&#34;</span><span class="o">;</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;</span> <span class="n">bookList</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="k">new</span> <span class="n">BeanPropertyRowMapper</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;(</span><span class="n">Book</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">bookList</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><h3 id="批量增加操作"><strong>批量增加操作</strong></h3>
<ul>
<li><em><strong>1. 场景： 批量操作，比如操作表里面多条记录</strong></em></li>
<li><em><strong>2. 使用 JdbcTemplate 查询返回集合</strong></em>
<ul>
<li><em><strong>batchUpdate(String sql, List&lt;Object[]&gt; batchArgs)</strong></em></li>
<li><em><strong>第一个参数 sql 语句</strong></em></li>
<li><em><strong>第二个参数: List 集合</strong></em></li>
</ul>
</li>
<li><em><strong>3. daoImpl</strong></em></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">batchAddBook</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">[]&gt;</span> <span class="n">batchArgs</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;insert into t_book values(?, ?, ?)&#34;</span><span class="o">;</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">ints</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">batchUpdate</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">batchArgs</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ints</span><span class="o">);</span>
         <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">ints</span><span class="o">));</span>

    <span class="o">}</span>
</code></pre></div><ul>
<li><em><strong>4. test</strong></em></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">&#34;bean1.xml&#34;</span><span class="o">);</span>
        <span class="n">BookService</span> <span class="n">bookService</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;bookService&#34;</span><span class="o">,</span> <span class="n">BookService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">[]&gt;</span> <span class="n">batchArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">o1</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;6&#34;</span><span class="o">,</span> <span class="s">&#34;hava&#34;</span><span class="o">,</span> <span class="s">&#34;w&#34;</span><span class="o">};</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">o2</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;7&#34;</span><span class="o">,</span> <span class="s">&#34;gwe&#34;</span><span class="o">,</span> <span class="s">&#34;we&#34;</span><span class="o">};</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">o3</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;8&#34;</span><span class="o">,</span> <span class="s">&#34;cge&#34;</span><span class="o">,</span> <span class="s">&#34;h&#34;</span><span class="o">};</span>
        <span class="n">batchArgs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">o1</span><span class="o">);</span>
        <span class="n">batchArgs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">o2</span><span class="o">);</span>
        <span class="n">batchArgs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">o3</span><span class="o">);</span>
        <span class="n">bookService</span><span class="o">.</span><span class="na">batchAdd</span><span class="o">(</span><span class="n">batchArgs</span><span class="o">);</span>
</code></pre></div><h3 id="批量修改操作"><strong>批量修改操作</strong></h3>
<ul>
<li><em><strong>1. 场景： 批量操作，比如操作表里面多条记录</strong></em></li>
<li><em><strong>2. 使用 JdbcTemplate 查询返回集合</strong></em>
<ul>
<li><em><strong>batchUpdate(String sql, List&lt;Object[]&gt; batchArgs)</strong></em></li>
<li><em><strong>第一个参数 sql 语句</strong></em></li>
<li><em><strong>第二个参数: List 集合</strong></em></li>
</ul>
</li>
<li><em><strong>3. daoImpl</strong></em></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">batchUpdateBook</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">[]&gt;</span> <span class="n">batchArgs</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;update t_book set user_name=?, ustatus=? where user_id=?&#34;</span><span class="o">;</span>
         <span class="kt">int</span><span class="o">[]</span> <span class="n">ints</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">batchUpdate</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">batchArgs</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">ints</span><span class="o">));</span>

    <span class="o">}</span>
</code></pre></div><ul>
<li><em><strong>4. test</strong></em></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">&#34;bean1.xml&#34;</span><span class="o">);</span>
        <span class="n">BookService</span> <span class="n">bookService</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;bookService&#34;</span><span class="o">,</span> <span class="n">BookService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">[]&gt;</span> <span class="n">batchArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="c1">// Object[] o1 = {&#34;6&#34;, &#34;hava&#34;, &#34;w&#34;};
</span><span class="c1"></span>        <span class="c1">// Object[] o2 = {&#34;7&#34;, &#34;gwe&#34;, &#34;we&#34;};
</span><span class="c1"></span>        <span class="c1">// Object[] o3 = {&#34;8&#34;, &#34;cge&#34;, &#34;h&#34;};
</span><span class="c1"></span>        <span class="c1">// update t_book set user_name=?, ustatus=? where user_id=? id放最后
</span><span class="c1"></span>        <span class="n">Object</span><span class="o">[]</span> <span class="n">o1</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&#34;hava001&#34;</span><span class="o">,</span> <span class="s">&#34;w&#34;</span><span class="o">,</span><span class="s">&#34;6&#34;</span><span class="o">,};</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">o2</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&#34;hava002&#34;</span><span class="o">,</span> <span class="s">&#34;w&#34;</span><span class="o">,</span><span class="s">&#34;7&#34;</span><span class="o">,};</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">o3</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&#34;hava003&#34;</span><span class="o">,</span> <span class="s">&#34;w&#34;</span><span class="o">,</span><span class="s">&#34;8&#34;</span><span class="o">,};</span>
        <span class="n">batchArgs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">o1</span><span class="o">);</span>
        <span class="n">batchArgs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">o2</span><span class="o">);</span>
        <span class="n">batchArgs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">o3</span><span class="o">);</span>
        <span class="n">bookService</span><span class="o">.</span><span class="na">batchAdd</span><span class="o">(</span><span class="n">batchArgs</span><span class="o">);</span>
</code></pre></div><h3 id="批量删除操作"><strong>批量删除操作</strong></h3>
<ul>
<li><em><strong>1. 场景： 批量操作，比如操作表里面多条记录</strong></em></li>
<li><em><strong>2. 使用 JdbcTemplate 查询返回集合</strong></em>
<ul>
<li><em><strong>batchUpdate(String sql, List&lt;Object[]&gt; batchArgs)</strong></em></li>
<li><em><strong>第一个参数 sql 语句</strong></em></li>
<li><em><strong>第二个参数: List 集合</strong></em></li>
</ul>
</li>
<li><em><strong>3. daoImpl</strong></em></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">batchDeleteBook</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">[]&gt;</span> <span class="n">batchArgs</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;delete from t_book  where user_id=?&#34;</span><span class="o">;</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">ints</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">batchUpdate</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">batchArgs</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">ints</span><span class="o">));</span>
    <span class="o">}</span>
</code></pre></div><ul>
<li><em><strong>4. test</strong></em></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">&#34;bean1.xml&#34;</span><span class="o">);</span>
        <span class="n">BookService</span> <span class="n">bookService</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;bookService&#34;</span><span class="o">,</span> <span class="n">BookService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">[]&gt;</span> <span class="n">batchArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">o1</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&#34;6&#34;</span><span class="o">};</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">o2</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&#34;7&#34;</span><span class="o">};</span>
        <span class="n">batchArgs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">o1</span><span class="o">);</span>
        <span class="n">batchArgs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">o2</span><span class="o">);</span>
        <span class="n">bookService</span><span class="o">.</span><span class="na">batchDelate</span><span class="o">(</span><span class="n">batchArgs</span><span class="o">);</span>
</code></pre></div><h2 id="spring-transactionacid">spring Transaction（ACID)</h2>
<ul>
<li><em><strong>Atomicity 原子性(</strong></em></li>
<li><em><strong>Consistency 一致性</strong></em></li>
<li><em><strong>Isolateion 隔离性</strong></em></li>
<li><em><strong>Durability 持久性</strong></em></li>
</ul>
<h3 id="转账环境">转账环境</h3>
<h4 id="经典场景-银行转账">经典场景： 银行转账</h4>
<ul>
<li>
<p>lucy 转账 100 给 mary</p>
</li>
<li>
<p>lucy 少 100， mary 多 100</p>
</li>
<li>
<p><em><strong>Dao： 数据库操作，不写业务</strong></em></p>
<ul>
<li>多钱方法</li>
<li>少钱方法</li>
</ul>
</li>
<li>
<p><em><strong>Service： 业务操作</strong></em></p>
<ul>
<li>创建转账方法</li>
<li>调用 dao 两个方法</li>
</ul>
</li>
<li>
<p><em><strong>project step：</strong></em></p>
</li>
<li>
<ol>
<li>创建数据库表， 添加记录</li>
</ol>
</li>
</ul>
<figure><img src="/images/spring41.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>

<ul>
<li>
<ol start="2">
<li>创建 Service， 搭建 dao， 完成对象创建和注入关系</li>
</ol>
<ul>
<li>service 注入 dao， 在 dao 注入 jdbcTemplate， 在 JdbcTemplate 注入 DataSource</li>
</ul>
</li>
</ul>
<p><strong>service</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserDao</span> <span class="n">userDao</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p><strong>UserDaoImpl</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDaoImpl</span> <span class="kd">implements</span> <span class="n">UserDao</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p><strong>bean.xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="c">&lt;!--</span>    <span class="nx">引入外部属性文件</span><span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="nx">context</span><span class="o">:</span><span class="nx">property</span><span class="o">-</span><span class="nx">placeholder</span> <span class="nx">location</span><span class="o">=</span><span class="s2">&#34;jdbc.properties&#34;</span><span class="o">/&gt;</span>


<span class="c">&lt;!--</span><span class="mf">4.1</span> <span class="nx">开启组件扫描</span><span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="nx">context</span><span class="o">:</span><span class="nx">component</span><span class="o">-</span><span class="nx">scan</span> <span class="nx">base</span><span class="o">-</span><span class="kr">package</span><span class="o">=</span><span class="s2">&#34;com.learn&#34;</span><span class="o">/&gt;</span>


    <span class="c">&lt;!--</span><span class="nx">数据库连接池</span><span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="nx">bean</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;dataSource&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;com.alibaba.druid.pool.DruidDataSource&#34;</span> <span class="nx">destroy</span><span class="o">-</span><span class="nx">method</span><span class="o">=</span><span class="s2">&#34;close&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">property</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;url&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;${prop.url}&#34;</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="nx">property</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;username&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;${prop.userName}&#34;</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="nx">property</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;password&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;${prop.password}&#34;</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="nx">property</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;driverClassName&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;${prop.driverClass}&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="err">/bean&gt;</span>


    <span class="c">&lt;!--</span><span class="nx">JdbcTemplate</span> <span class="nx">对象</span><span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="nx">bean</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;jdbcTemplate&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;org.springframework.jdbc.core.JdbcTemplate&#34;</span><span class="o">&gt;</span>

        <span class="c">&lt;!--</span><span class="nx">set方法注入dataSource</span><span class="o">--&gt;</span>
        <span class="o">&lt;</span><span class="nx">property</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;dataSource&#34;</span> <span class="nx">ref</span><span class="o">=</span><span class="s2">&#34;dataSource&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="err">/bean&gt;</span>


<span class="o">&lt;</span><span class="err">/beans&gt;</span>
</code></pre></div><ul>
<li>
<ol start="3">
<li>在 dao 创建两个方法，多钱少钱， 在 service 创建方法 （转账的方法）</li>
</ol>
</li>
<li>
<ol start="4">
<li>发生错误， 比如转账到一半断电，产生 lucy 钱少了， mary 没到账</li>
</ol>
</li>
</ul>
<h4 id="事务解决问题"><em><strong>事务解决问题</strong></em></h4>
<ul>
<li>
<ol>
<li>开启事务： 业务层（javaEE 三层结构）</li>
</ol>
</li>
<li>
<ol start="2">
<li>Sping 进行事务管理操作</li>
</ol>
</li>
<li>2.1 编程式管理： 一般开发中不用</li>
</ul>
<figure><img src="/images/spring42.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>

<ul>
<li>
<p>2.2 声明式事务管理 （开发中使用）</p>
<ul>
<li>注解方式 （开发中）</li>
<li>xml 配置方式</li>
</ul>
</li>
<li>
<p>3.spring 进行声明式事务管理，底层使用 AOP 原理</p>
</li>
<li>
<p>4.spring 事务管理 API</p>
</li>
<li>
<p>4.1 提供一个接口，代表事务管理器，这个接口针对不同的框架提供不同的实体类</p>
</li>
</ul>
<p><strong>PlatformTransactionManager -&gt; DataSourceTransactionManager</strong>
<figure><img src="/images/spring43.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</p>
<figure><img src="/images/spring44.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>

<ul>
<li>
<p>4.2 开启事务注解
<figure><img src="/images/spring45.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</p>
</li>
<li>
<p>5.service 类上面 （获取 service 类里面方法上面） 添加事务注解</p>
</li>
<li>
<p>5.1 @Transactional 可以加到类或者某个方法上面
<figure><img src="/images/spring46.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</p>
</li>
</ul>
<h3 id="事务操作-声明式事务管理参数配置">事务操作 （声明式事务管理参数配置）</h3>
<ul>
<li>
<ol start="0">
<li>事务方法 ： 对数据库数据进行变化的操作</li>
</ol>
</li>
<li>
<ol>
<li>service 类上面添加注解 @Transactional</li>
</ol>
</li>
<li>
<ol start="2">
<li>propagation ： 事务传播行为：有事务的方法调用没事务的方法，或者反过来 或者两个方法都有事务 就是事务传播行为</li>
</ol>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">propogation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">,</span> <span class="n">isolation</span> <span class="o">=</span> <span class="n">Isolation</span><span class="o">.</span><span class="na">REPEATABLE_READ</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// call update method
</span><span class="c1"></span>    <span class="n">update</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">()</span> <span class="o">{</span>

<span class="o">}</span>
</code></pre></div><ul>
<li>
<ol start="3">
<li>isolation： 事务隔离级别 : 多事务操作直接不会产生影响，不考虑隔离性产生很多问题
解决三个读问题： 脏读，不可重复读，虚读</li>
</ol>
</li>
<li>
<p>3.1 脏读： 一个未提交事务读取到另一个未提交事务的数据</p>
</li>
<li>
<p>3.2 不可重复读： 一个未提交事务读取到另一个提交事务修改数据</p>
</li>
<li>
<p>3.3 虚读： 一个未提交事务读取到另一个提交事务添加数据</p>
</li>
<li>
<p>3.4 <strong>READ UNCOMMITTED</strong>(读未提交) ：无法解决 3 问题</p>
</li>
<li>
<p>3.5 <strong>READ COMMITTED</strong>(读已提交) ：解决 <strong>脏读</strong>问题</p>
</li>
<li>
<p>3.6 <strong>REPEATABLE READ</strong>(可重复度) ：解决 <strong>脏读</strong>  <strong>不可重复读</strong> 问题</p>
</li>
<li>
<p>3.7 <strong>SERIALIZABLE</strong>(串行化) ：解决<strong>脏读</strong>  <strong>不可重复读</strong> <strong>虚读</strong>问题</p>
</li>
<li>
<ol start="4">
<li>timeout： 超时</li>
</ol>
</li>
<li>
<ol start="5">
<li>readOnly ： 是否只读</li>
</ol>
</li>
<li>
<ol start="6">
<li>rollbackFor ： 回滚</li>
</ol>
</li>
<li>
<ol start="7">
<li>norollbackFor</li>
</ol>
</li>
</ul>
<h3 id="事务操作-完全注解声明式事务管理">事务操作 （完全注解声明式事务管理）</h3>
<ul>
<li>
<ol>
<li>创建配置类， 使用配置类替代 xml 配置文件
<figure><img src="/images/spring47.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</li>
</ol>
</li>
</ul>
<h2 id="spring5-新功能">spring5 新功能</h2>
<h3 id="自带通用的日志封装">自带通用的日志封装</h3>
<ul>
<li>
<ol>
<li>整合 Log4j2</li>
</ol>
</li>
<li>
<ol start="2">
<li>引入 jar 包</li>
</ol>
</li>
<li>
<p>2.1 <em><strong>log4j-api</strong></em></p>
</li>
<li>
<p>2.2 <em><strong>log4j-core</strong></em></p>
</li>
<li>
<p>2.3 <em><strong>log4j-slf4j-impl</strong></em></p>
</li>
<li>
<p>2.4 <em><strong>slf4j-api</strong></em></p>
</li>
<li>
<ol start="3">
<li>创建 log4j2.xml 配置
<figure><img src="/images/spring48.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</li>
</ol>
</li>
</ul>
<h3 id="junit5">JUnit5</h3>
<ul>
<li>
<ol>
<li>test</li>
</ol>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="s">&#34;classpath:bean1.xml&#34;</span><span class="o">)</span>
<span class="c1">//   ApplicationContext context = new ClassPathXmlApplicationContext(&#34;bean1.xml&#34;);
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JTest4</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><ul>
<li>
<ol start="2">
<li>整合 JUnit5</li>
</ol>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">SpringExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="s">&#34;classpath:bean1.xml&#34;</span><span class="o">)</span>
<span class="c1">//   ApplicationContext context = new ClassPathXmlApplicationContext(&#34;bean1.xml&#34;);
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JTest4</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>



<span class="o">+</span> <span class="n">2</span><span class="o">.</span> <span class="n">JUnit5</span> <span class="n">复合注解</span>

<span class="err">```</span><span class="n">java</span>

<span class="nd">@SpringJunitConfig</span><span class="o">(</span><span class="n">lacation</span><span class="o">=</span><span class="s">&#34;classpath:bean1.xml&#34;</span><span class="o">)</span>
<span class="c1">//   ApplicationContext context = new ClassPathXmlApplicationContext(&#34;bean1.xml&#34;);
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JTest4</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="webflux">Webflux</h3>
<figure><img src="/images/spring51.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>

<ul>
<li>
<ol>
<li>响应式编程： Reacter 实现</li>
</ol>
</li>
<li>
<p>1.1 Reacter 两个核心类， Mono 和 Flux， 实现接口 Publisher。 Flux 对象实现发布者，返回 N 个元素； Mono 实现发布者，返回 0 或者 1 个元素</p>
</li>
<li>
<p>1.2 Mono 和 Flux 都是数据流的发布者，都可以发出三种数据信号： <em><strong>元素值</strong></em>， <em><strong>错误信号</strong></em>， <em><strong>完成信号</strong></em>， <em><strong>错误信号</strong></em>， <em><strong>完成信号</strong></em> 都代表终止信号</p>
</li>
<li>
<p>1.3 引入依赖： Reactor-core</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">        <span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">io</span><span class="o">.</span><span class="na">projectreactor</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">reactor</span><span class="o">-</span><span class="n">core</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="n">3</span><span class="o">.</span><span class="na">4</span><span class="o">.</span><span class="na">13</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</code></pre></div><ul>
<li>
<p>1.3 调用 just 或
者其他方法只是声明数据流，数据流并没有发出，只有进行订阅之后才会触发数据流
<figure><img src="/images/spring49.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</p>
</li>
<li>
<p>1.4 操作符： map 元素映射为新元素； flatMap 元素映射为流</p>
</li>
<li>
<ol start="2">
<li>SpringWebflux 执行流程和核心 api
SpringWebflux 基于 Reactor， 默认容器是 Netty， Netty 是高性能 NIO 框架，异步非阻塞的框架</li>
</ol>
</li>
<li>
<p>2.1 Netty
阻塞状态 Socket -》 InputStream -》 read（） -》 Thread</p>
</li>
</ul>
<p>非阻塞 NIO 状态
<figure><img src="/images/spring50.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</p>
<ul>
<li>
<p>2.2 SpringWebflux 核心控制器 DispatchHandler， 实现接口 WebHandler, 负责请求的处理</p>
<ul>
<li><strong>HanddlerMapping : 请求查询处理的方法</strong></li>
<li><strong>HandlerAdapter： 真正负责请求处理</strong></li>
<li><strong>HandlerResultHandler： 响应结果处理</strong></li>
</ul>
</li>
<li>
<p>2.3 函数式编程，两个接口： RouterFunction 和 HandlerFunction</p>
</li>
<li>
<ol start="3">
<li>SpringWebflux (基于注解)</li>
</ol>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">webflux</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="n">2</span><span class="o">.</span><span class="na">4</span><span class="o">.</span><span class="na">1</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</code></pre></div><ul>
<li>3.1 配置启动端口号</li>
</ul>
<blockquote>
<p>resources -&gt; application.properties -&gt; server.port = 8081</p>
</blockquote>
<ul>
<li>3.2 创建包和相关类
<figure><img src="/images/spring52.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</li>
</ul>
<figure><img src="/images/spring53.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring52.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>

<ul>
<li>
<ol start="4">
<li>SpringWebflux (基于函数)</li>
</ol>
</li>
</ul>
<h2 id="general-information">General Information</h2>
<ul>
<li>Provide general information about your project here.</li>
<li>What problem does it (intend to) solve?</li>
<li>What is the purpose of your project?</li>
<li>Why did you undertake it?</li>
</ul>
<!-- You don't have to answer all the questions - just the ones relevant to your project. -->
<h2 id="technologies-used">Technologies Used</h2>
<ul>
<li>Tech 1 - version 1.0</li>
<li>Tech 2 - version 2.0</li>
<li>Tech 3 - version 3.0</li>
</ul>
<h2 id="features">Features</h2>
<p>List the ready features here:</p>
<ul>
<li>Awesome feature 1</li>
<li>Awesome feature 2</li>
<li>Awesome feature 3</li>
</ul>
<h2 id="screenshots">Screenshots</h2>
<p><img src="./img/screenshot.png" alt="Example screenshot"></p>
<!-- If you have screenshots you'd like to share, include them here. -->
<h2 id="setup">Setup</h2>
<p>What are the project requirements/dependencies? Where are they listed? A requirements.txt or a Pipfile.lock file perhaps? Where is it located?</p>
<p>Proceed to describe how to install / setup one&rsquo;s local environment / get started with the project.</p>
<h2 id="usage">Usage</h2>
<p>How does one go about using it?
Provide various use cases and code examples here.</p>
<p><code>write-your-code-here</code></p>
<h2 id="project-status">Project Status</h2>
<p>Project is: <em>in progress</em> / <em>complete</em> / <em>no longer being worked on</em>. If you are no longer working on it, provide reasons why.</p>
<h2 id="room-for-improvement">Room for Improvement</h2>
<p>Include areas you believe need improvement / could be improved. Also add TODOs for future development.</p>
<p>Room for improvement:</p>
<ul>
<li>Improvement to be done 1</li>
<li>Improvement to be done 2</li>
</ul>
<p>To do:</p>
<ul>
<li>Feature to be added 1</li>
<li>Feature to be added 2</li>
</ul>
<h2 id="acknowledgements">Acknowledgements</h2>
<p>Give credit here.</p>
<ul>
<li>This project was inspired by&hellip;</li>
<li>This project was based on <a href="https://www.example.com"  target="_blank" >this tutorial</a>.</li>
<li>Many thanks to yanliang <a href="https://gyl-coder.top/"  target="_blank" >yanliang</a></li>
</ul>
<h2 id="contact">Contact</h2>
<p>Created by <a href="https://www.flynerd.pl/"  target="_blank" >@flynerdpl</a> - feel free to contact me!</p>
<!-- Optional -->
<!-- ## License -->
<!-- This project is open source and available under the [... License](). -->
<!-- You don't have to include all sections - just the one's relevant to your project -->
<h2 id="spring-v10-dispatcherservlet">Spring V1.0 DispatcherServlet</h2>
<h2 id="spring-ioc-di-mvc的工作原理">Spring IoC， DI, MVC的工作原理</h2>
<h3 id="遵循单一职责原则">遵循单一职责原则</h3>
<h3 id="min版本spring基本实现思路">MIN版本Spring基本实现思路：</h3>
<ol>
<li>配置阶段
<ul>
<li>配置 web.xml |    <em>DispatcherServlet</em></li>
<li>设定 init-param | <em>contextConfigLocation = classpath:application.xml</em></li>
<li>设定 url-pattern | /*</li>
<li>配置Annotation | <em>@Controller @Service @Autowrited @RequestMapping</em></li>
</ul>
<hr>
</li>
<li>初始化阶段
<ul>
<li>调用init（）方法  | <em>加载配置文件</em></li>
<li>IOC容器初始化 | *Map&lt;String, Object&gt;</li>
<li>扫描相关的类  | scan-package=&ldquo;com.gupaoedu&rdquo;
IOC  + 创建实例化并保存至容器    | <em>通过反射机制将类实例化放入IOC容器中</em>
DI  + 进行DI操作    | <em>扫描IOC容器中的实例，给没有赋值的属性自动赋值</em>
MVC  + 初始化HandlerMapping  | <em>将一个URL和一个Method进行一对一的关联映射Map&lt;String, Method&gt;</em></li>
</ul>
</li>
</ol>
<hr>
<ol start="3">
<li>
<p>运行阶段</p>
<ul>
<li>调用doPost()/doGet() | <em>web容器调用doPost/doGet方法，获得request/response对象</em></li>
<li>匹配HandlerMapping | <em>从request对象中获得用户输入的url，找到对应的Method</em></li>
<li>反射调用method.invoker() | <em>利用反射调用方法并返回结果</em></li>
<li>response.getWrite().write() | <em>将返回结果输出到游览器</em></li>
</ul>
<hr>
</li>
</ol>
<h3 id="新建一个类实现三个方法">新建一个类，实现三个方法</h3>
<details>
<summary> 代码折叠 </summary>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">GPDispatchServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="err">，</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">doPost</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">resp</span><span class="o">);</span>
        <span class="o">}</span>

        
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="err">，</span> <span class="n">IOException</span> <span class="o">{</span>

            <span class="o">&lt;!--</span> <span class="n">6</span><span class="o">.</span><span class="na">根据URL委派给具体的调用的方法</span> <span class="o">--&gt;</span>
            <span class="n">doDispatch</span><span class="o">();</span>
           
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">ServletConfig</span> <span class="n">config</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>
          <span class="o">&lt;!--</span> <span class="n">1</span><span class="o">.</span><span class="na">初始化方法init</span> <span class="o">--&gt;</span>
          <span class="o">&lt;!--</span><span class="n">1</span><span class="o">.</span> <span class="n">加载配置文件</span> <span class="o">--&gt;</span>
          <span class="n">doLoadConfig</span><span class="o">();</span>


          <span class="o">&lt;!--</span> <span class="n">2</span><span class="o">.</span><span class="na">扫描相关的类</span> <span class="o">--&gt;</span>
          <span class="n">doScanner</span><span class="o">();</span>


          <span class="o">&lt;!--</span> <span class="n">Ioc功能</span> <span class="o">--&gt;</span>
          <span class="o">&lt;!--</span> <span class="n">3</span><span class="o">.</span><span class="na">初始化Ioc容器</span><span class="err">，</span><span class="n">将扫描的类进行实例化</span><span class="err">，</span><span class="n">缓存到Ioc容器中</span> <span class="o">--&gt;</span>
          <span class="n">doInstance</span><span class="o">();</span>


         <span class="o">&lt;!--</span> <span class="n">DI功能</span> <span class="o">--&gt;</span>
          <span class="o">&lt;!--</span><span class="n">4</span><span class="o">.</span><span class="na">完成依赖注入</span>  <span class="o">--&gt;</span>
          <span class="n">doAutowired</span><span class="o">();</span>

        <span class="o">&lt;!--</span> <span class="n">MVC功能</span> <span class="o">--&gt;</span>
          <span class="o">&lt;!--</span> <span class="n">5</span><span class="o">.</span><span class="na">初始化HandlerMapping</span> <span class="o">--&gt;</span>
          <span class="n">doInitHandlerMapping</span><span class="o">();</span>
           
           <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printLn</span><span class="o">(</span><span class="s">&#34;GP sTRING Framework is init.&#34;</span><span class="o">)</span>
     
        <span class="o">}</span>
        <span class="c1">//根据contextConfigLocation的classpath找到对应的配置文件
</span><span class="c1"></span>        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doLoadConfig</span><span class="o">(</span><span class="n">String</span> <span class="n">contextConfigLocatoin</span><span class="o">)</span>
            <span class="n">InputString</span> <span class="n">is</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">.</span>
    <span class="o">}</span>
</code></pre></div></details>
<h2 id="spring-ioc-1">Spring IoC</h2>
<p><strong>工厂模式，原型，单例（工厂怎么把对象创建出来，交给用户）</strong></p>
<h2 id="from-servlet-to-applicatoincontext">from Servlet to ApplicatoinContext</h2>
<p><img src="https://cdn.jsdelivr.net/gh/gyl-coder/blogImgs/images/spring/ioc-aop/image-20200411114146872.png" alt=""></p>
<h3 id="1-spring-ioc">1. Spring IOC</h3>
<p><strong>without IOC</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/gyl-coder/blogImgs/images/spring/ioc-aop/image-20200411115607696.png" alt=""></p>
<p><strong>when we need a new Impl, problem occurs</strong>
<img src="https://cdn.jsdelivr.net/gh/gyl-coder/blogImgs/images/spring/ioc-aop/image-20200411120144353.png" alt=""></p>
<p><strong>use IOC, we save lots of time for adjusting code</strong>
<img src="https://cdn.jsdelivr.net/gh/gyl-coder/blogImgs/images/spring/ioc-aop/image-20200411120751016.png" alt=""></p>
<h2 id="here-is-a-case">here is a case</h2>
<p>Transfer Funds to Other Bank&rsquo;s Account:  A sent money to B account</p>
<p><strong>without IOC</strong></p>
<p><strong>table</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">name    varcher     255 username
money   int         255 balance
cardNo  varcher     255 bank account
</code></pre></div><p><strong>call flow</strong></p>
<p><code>Transfer page</code>     <em>// page <code>transfer</code> botton, send ajax requirement to TransferServlet</em></p>
<p>⇕  ⇕</p>
<p><code>TransferServlet</code>    //  servlet instance is initialized, invokes its Service layer method： TransferService transferService = newTransferServiceImpl();</p>
<p>⇕  ⇕</p>
<p><code>TransferService</code> // service class create Dao instance as singleton, invokes its Dao layer method： AccountDao accountDao = new JdbcAccountDaoImpl();</p>
<p>⇕  ⇕</p>
<p><code>AccountDao</code>  // Dao provides multiple Impl</p>
<p>↓&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;  ↓ 
<code>JdbcAccountDaoImpl</code>   <code>MybatisAccountDaoImpl</code></p>
<p><strong>core code</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;transerServlet&#34;</span><span class="o">,</span> <span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">&#34;/transferServlet&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
    <span class="c1">// create service instance
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">TransferService</span> <span class="n">transferService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransferServiceImpl</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOE</span> <span class="o">{</span>
        <span class="n">doPost</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">resp</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOE</span> <span class="o">{</span>

        <span class="n">req</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">&#34;UTF-8&#34;</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">fromCardNo</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;fromCardNo&#34;</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">toCardNo</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;toCardNo&#34;</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">moneyStr</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;money&#34;</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">money</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">moneyStr</span><span class="o">);</span>

        <span class="n">Result</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Result</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// invoke service method
</span><span class="c1"></span>            <span class="n">transferService</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="n">fromCardNo</span><span class="o">,</span><span class="n">toCardNo</span><span class="o">,</span><span class="n">money</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;200&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;201&#34;</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">// response
</span><span class="c1"></span>        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&#34;application/json;charset=utf-8&#34;</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">print</span><span class="o">(</span><span class="n">JsonUtils</span><span class="o">.</span><span class="na">object2Json</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TransferService</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">String</span> <span class="n">fromCardNo</span><span class="o">,</span> <span class="n">String</span> <span class="n">toCardNo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServiceImpl</span> <span class="kd">implements</span> <span class="n">TransferService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">AccountDao</span> <span class="n">accountDao</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JdbcAccountDaoImpl</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">String</span> <span class="n">fromCardNo</span><span class="o">,</span> <span class="n">String</span> <span class="n">toCardNo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
            <span class="n">Account</span> <span class="n">from</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">queryAccountByCardNo</span><span class="o">(</span><span class="n">fromCardNo</span><span class="o">);</span>
            <span class="n">Account</span> <span class="n">to</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">queryAccountByCardNo</span><span class="o">(</span><span class="n">toCardNo</span><span class="o">);</span>

            <span class="n">from</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()-</span><span class="n">money</span><span class="o">);</span>
            <span class="n">to</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">to</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()+</span><span class="n">money</span><span class="o">);</span>

            <span class="n">accountDao</span><span class="o">.</span><span class="na">updateAccountByCardNo</span><span class="o">(</span><span class="n">to</span><span class="o">);</span>
            <span class="n">accountDao</span><span class="o">.</span><span class="na">updateAccountByCardNo</span><span class="o">(</span><span class="n">from</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountDao</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * get account by query accountNo
</span><span class="cm">     * @param cardNo
</span><span class="cm">     * @return
</span><span class="cm">     * @throws Exception
</span><span class="cm">     */</span>
    <span class="n">Account</span> <span class="nf">queryAccountByCardNo</span><span class="o">(</span><span class="n">String</span> <span class="n">cardNo</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * up aacount information
</span><span class="cm">     * @param account
</span><span class="cm">     * @return
</span><span class="cm">     * @throws Exception
</span><span class="cm">     */</span>
    <span class="kt">int</span> <span class="nf">updateAccountByCardNo</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcAccountDaoImpl</span> <span class="kd">implements</span> <span class="n">AccountDao</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">queryAccountByCardNo</span><span class="o">(</span><span class="n">String</span> <span class="n">cardNo</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        
        <span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">DruidUtils</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select * from account where cardNo=?&#34;</span><span class="o">;</span>
        <span class="n">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">1</span><span class="o">,</span><span class="n">cardNo</span><span class="o">);</span>
        <span class="n">ResultSet</span> <span class="n">resultSet</span> <span class="o">=</span> <span class="n">preparedStatement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>

        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Account</span><span class="o">();</span>
        <span class="k">while</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setCardNo</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;cardNo&#34;</span><span class="o">));</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;money&#34;</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="n">resultSet</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">updateAccountByCardNo</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        
        <span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">DruidUtils</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;update account set money=? where cardNo=?&#34;</span><span class="o">;</span>
        <span class="n">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">1</span><span class="o">,</span><span class="n">account</span><span class="o">.</span><span class="na">getMoney</span><span class="o">());</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">2</span><span class="o">,</span><span class="n">account</span><span class="o">.</span><span class="na">getCardNo</span><span class="o">());</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">preparedStatement</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>

        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>analysis:</strong></p>
<p><code>Transfer page</code></p>
<p>⇕  ⇕</p>
<p><code>TransferServlet</code>    //  public class TransferServlet extends HttpServlet { TransferService transferService = newTransferServiceImpl(); }</p>
<p>⇕  ⇕</p>
<p>interface: <code>TransferService</code> // public class TransferServiceImpl implements TransferService {
impl: <code>TransferServiceImpl</code>   // private AccountDao accountDao = new JdbcAccountDaoImpl();</p>
<p>⇕  ⇕</p>
<p>interface:<code>AccountDao</code><br>
impl: <code>JdbcAccountDaoImpl</code></p>
<p><strong>P1:in service level New define the references to DAO to the concrete implementations as that will make it tightly coupled, not easy in different implementation scenarios, which will lead to modify service code.</strong></p>
<p><strong>P2:serivice layer miss TransactionStatus. And data error may occur in transferring process, cause serious damage.</strong></p>
<hr>
<p><strong>solution</strong></p>
<p><em><strong>P1: new tight coupled problem</strong></em>
<em><strong>solution &ndash;Using Reflection to instantiate the object in factory pattern</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServiceImpl</span> <span class="kd">implements</span> <span class="n">TransferService</span> <span class="o">{</span>

    <span class="c1">// private AccountDao accountDao = new JdbcAccountDaoImpl();
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">AccountDao</span> <span class="n">accountDao</span><span class="err">；</span>

    <span class="c1">// @Override
</span><span class="c1"></span>    <span class="c1">// public void transfer(String fromCardNo, String toCardNo, int money) throws Exception {
</span><span class="c1"></span>    <span class="c1">//         Account from = accountDao.queryAccountByCardNo(fromCardNo);
</span><span class="c1"></span>    <span class="c1">//         Account to = accountDao.queryAccountByCardNo(toCardNo);
</span><span class="c1"></span>
    <span class="c1">//         from.setMoney(from.getMoney()-money);
</span><span class="c1"></span>    <span class="c1">//         to.setMoney(to.getMoney()+money);
</span><span class="c1"></span>
    <span class="c1">//         accountDao.updateAccountByCardNo(to);
</span><span class="c1"></span>    <span class="c1">//         accountDao.updateAccountByCardNo(from);
</span><span class="c1"></span>    <span class="c1">// }
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAccountDao</span><span class="o">(</span><span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accountDao</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><p>Method injection, allows to inject a dependency right at the point of use
when you have mutiple implementation, Method injection is a good choice</p>
<p><em><strong>before:</strong></em>
<code>TransferServiceImpl</code>
↓
new
↓
<code>JdbcAccountDaoImpl</code></p>
<hr>
<p><em><strong>now:</strong></em>
<code>TransferServiceImpl</code>
↓</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">factory read xml file, 
use reflection to instantiate the object,
defines an interface for creating objects
</code></pre></div><p>↑</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">xml:
com.test.dao.JdbcAccountDaoImpl
com.test.service.TransferServiceImpl
</code></pre></div><hr>
<p><em><strong>code</strong></em></p>
<p><em><strong>define bean.xml file</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">&#34;1.0&#34;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span> <span class="o">?&gt;</span>

<span class="o">&lt;!--</span><span class="n">each</span> <span class="n">bean</span> <span class="n">represent</span> <span class="n">a</span> <span class="n">class</span><span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">beans</span><span class="o">&gt;</span>
    
    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;accountDao&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.dao.impl.JdbcAccountDaoImpl&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;ConnectionUtils&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;connectionUtils&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;transferService&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.service.impl.TransferServiceImpl&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;!--</span><span class="n">set</span><span class="o">+</span> <span class="n">name</span><span class="o">,</span> <span class="n">Method</span> <span class="n">injectione</span> <span class="o">--&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;AccountDao&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;accountDao&#34;</span><span class="o">&gt;&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">beans</span><span class="o">&gt;</span>
</code></pre></div><p><em><strong>define BeanFactory</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/* 
</span><span class="cm">* factory class
</span><span class="cm">* task1: read xml, use reflection to instantiate the object, store in the map
</span><span class="cm">* task2: provide interfaces for creating objects (id)
</span><span class="cm">*/</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanFactory</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span> <span class="c1">// store object
</span><span class="c1"></span>

    <span class="cm">/* 
</span><span class="cm">    * read xml, use reflection to instantiate the object, store in the map
</span><span class="cm">    */</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="c1">// load xml
</span><span class="c1"></span>        <span class="n">InputStream</span> <span class="n">resourceAsStream</span> <span class="o">=</span> <span class="n">BeanFactory</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&#34;beans.xml&#34;</span><span class="o">)</span>
        <span class="c1">// read xml
</span><span class="c1"></span>        <span class="n">SAXReader</span> <span class="n">saxReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SAXReader</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Document</span> <span class="n">document</span> <span class="o">=</span> <span class="n">saxReader</span><span class="o">.</span><span class="na">getRootElement</span><span class="o">();</span>
            <span class="n">Element</span> <span class="n">rootElement</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="na">getRootElement</span><span class="o">();</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Element</span><span class="o">&gt;</span> <span class="n">beanList</span> <span class="o">=</span> <span class="n">rootElement</span><span class="o">.</span><span class="na">selectNodes</span><span class="o">(</span><span class="s">&#34;//bean&#34;</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">beanList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">Element</span> <span class="n">element</span> <span class="o">=</span>  <span class="n">beanList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="c1">// get bean id 和 class property
</span><span class="c1"></span>                <span class="n">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">attributeValue</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">);</span>        <span class="c1">// accountDao
</span><span class="c1"></span>                <span class="n">String</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">attributeValue</span><span class="o">(</span><span class="s">&#34;class&#34;</span><span class="o">);</span>  <span class="c1">// com.test.dao.impl.JdbcAccountDaoImpl
</span><span class="c1"></span>                <span class="c1">// use reflection to instantiate the object
</span><span class="c1"></span>                <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">aClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
                <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">aClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

                <span class="c1">// store in the map
</span><span class="c1"></span>                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">o</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// pass property of the bean into Oject
</span><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Element</span><span class="o">&gt;</span> <span class="n">propertyList</span> <span class="o">=</span> <span class="n">rootElement</span><span class="o">.</span><span class="na">selectNodes</span><span class="o">(</span><span class="s">&#34;//property&#34;</span><span class="o">);</span>
        <span class="c1">// read property, get super element
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">propertyList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">Element</span> <span class="n">element</span> <span class="o">=</span> <span class="n">propertyList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span> <span class="c1">//&lt;property name=&#34;AccountDao&#34; ref=&#34;accountDao&#34;&gt;&lt;/property&gt;
</span><span class="c1"></span>            <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">attributeValue</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">attributeValue</span><span class="o">(</span><span class="s">&#34;ref&#34;</span><span class="o">);</span>

            <span class="c1">// find parent
</span><span class="c1"></span>            <span class="n">Element</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getParent</span><span class="o">();</span>

            <span class="c1">// call parent element reflection
</span><span class="c1"></span>            <span class="n">String</span> <span class="n">parentId</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">attributeValue</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">);</span>
            <span class="n">Object</span> <span class="n">parentObject</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">parentId</span><span class="o">);</span>
            <span class="c1">// search all the methods
</span><span class="c1"></span>            <span class="n">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">parentObject</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethods</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">methods</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">methods</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&#34;set&#34;</span> <span class="o">+</span> <span class="n">name</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// setAccountDao(AccountDao accountDao)
</span><span class="c1"></span>                    <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">parentObject</span><span class="o">,</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ref</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="c1">// put parentObject back into map
</span><span class="c1"></span>            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">parentId</span><span class="o">,</span> <span class="n">parentObject</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">DocumentException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/* 
</span><span class="cm">    * provide interfaces for creating objects (id) 
</span><span class="cm">    * @param id
</span><span class="cm">    * @return
</span><span class="cm">    */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">getBean</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;transerServlet&#34;</span><span class="o">,</span> <span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">&#34;/transferServlet&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
    <span class="c1">// create service instance
</span><span class="c1"></span>    <span class="c1">// private TransferService transferService = new TransferServiceImpl();
</span><span class="c1"></span>
    <span class="c1">// get service object through BeanFactory
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">TransferService</span> <span class="n">transferService</span> <span class="o">=</span> <span class="o">(</span><span class="n">TransferService</span><span class="o">)</span> <span class="n">BeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;transferService&#34;</span><span class="o">);</span>

    
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServiceImpl</span> <span class="kd">implements</span> <span class="n">TransferService</span> <span class="o">{</span>
        <span class="c1">// get Dao object through BeanFactory
</span><span class="c1"></span>        <span class="c1">// private AccountDao accountDao = (AccountDao) BeanFactory.getBean(&#34;accountDao&#34;);
</span><span class="c1"></span>
        <span class="c1">// better way
</span><span class="c1"></span>        <span class="kd">private</span> <span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAccountDao</span><span class="o">(</span><span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accountDao</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="o">}</span>

</code></pre></div><p><em><strong>P2 TransactionStatus</strong></em>
make one wrong transaction</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">accountDao</span><span class="o">.</span><span class="na">updateAccountByCardNo</span><span class="o">(</span><span class="n">to</span><span class="o">);</span>
<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">/</span><span class="n">0</span><span class="o">;</span>
<span class="n">accountDao</span><span class="o">.</span><span class="na">updateAccountByCardNo</span><span class="o">(</span><span class="n">from</span><span class="o">);</span>

</code></pre></div><p>run the application, click transfer button(A sent $100 to B), get an error, however, when checking the database,</p>
<p><strong>B get $100, but A is still have the same amount of money!!!</strong></p>
<p><strong>solution</strong></p>
<ul>
<li>executing multiple UPDATE statement in one connection</li>
<li>put tranaction in service layer</li>
</ul>
<p><em><strong>TransactionStatus code</strong></em>
<em><strong>add ConnectionUtils</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="cm">/**
</span><span class="cm"> * get connection
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionUtils</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Connection</span><span class="o">&gt;</span> <span class="n">threadLocal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;&gt;();</span> <span class="c1">// store current threadlocal
</span><span class="c1"></span>
    <span class="cm">/**
</span><span class="cm">     * connection from thread
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Connection</span> <span class="nf">getCurrentThreadConn</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
       
        <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// get connection
</span><span class="c1"></span>            <span class="n">connection</span> <span class="o">=</span> <span class="n">DruidUtils</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getConnection</span><span class="o">();</span>
            <span class="c1">// put into threadlocal
</span><span class="c1"></span>            <span class="n">threadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">connection</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><em><strong>add TransactionManager</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionManager</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">ConnectionUtils</span> <span class="n">connectionUtils</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setConnectionUtils</span><span class="o">(</span><span class="n">ConnectionUtils</span> <span class="n">connectionUtils</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">connectionUtils</span> <span class="o">=</span> <span class="n">connectionUtils</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// begin transaction
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">beginTransaction</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getCurrentThreadConn</span><span class="o">().</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// commit transaction
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getCurrentThreadConn</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// rollback
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rollback</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getCurrentThreadConn</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><em><strong>add ProxyFactory</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyFactory</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">TransactionManager</span> <span class="n">transactionManager</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTransactionManager</span><span class="o">(</span><span class="n">TransactionManager</span> <span class="n">transactionManager</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">transactionManager</span> <span class="o">=</span> <span class="n">transactionManager</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/* 
</span><span class="cm">    Jdk Dynamic Proxy
</span><span class="cm">    @param obj
</span><span class="cm">    @return proxy object
</span><span class="cm">    */</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getJdkProxy</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// get proxy object
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">(),</span> <span class="k">new</span> <span class="n">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                     <span class="n">transactionManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
                     <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
                    <span class="c1">// 
</span><span class="c1"></span>                    <span class="n">transactionManager</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="c1">// 
</span><span class="c1"></span>                    <span class="n">transactionManager</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                    <span class="c1">// throw e can be caught by servlet
</span><span class="c1"></span>                    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">result</span><span class="o">;</span>

                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="cm">/* 
</span><span class="cm">    * cglib get Dynamic Proxy
</span><span class="cm">    @param obj
</span><span class="cm">    @return proxy object
</span><span class="cm">    */</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getCglibProxy</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// get proxy object
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">Enhancer</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span>  <span class="k">new</span> <span class="n">MethodInterceptor</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">intercept</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">objects</span><span class="o">,</span> <span class="n">MethodProxy</span> <span class="n">methodProxy</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                     <span class="n">transactionManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
                     <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span><span class="n">objects</span><span class="o">);</span>
                    <span class="c1">// 
</span><span class="c1"></span>                    <span class="n">transactionManager</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="c1">// 
</span><span class="c1"></span>                    <span class="n">transactionManager</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                    <span class="c1">// throw e can be caught by servlet
</span><span class="c1"></span>                    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">result</span><span class="o">;</span>

                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><em><strong>modify beans.xml</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">&#34;1.0&#34;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span> <span class="o">?&gt;</span>

<span class="o">&lt;!--</span><span class="n">each</span> <span class="n">bean</span> <span class="n">represent</span> <span class="n">a</span> <span class="n">class</span><span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">beans</span><span class="o">&gt;</span>
    
    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;accountDao&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.dao.impl.JdbcAccountDaoImpl&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;ConnectionUtils&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;connectionUtils&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;transferService&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.service.impl.TransferServiceImpl&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;!--</span><span class="n">set</span><span class="o">+</span> <span class="n">name</span><span class="o">,</span> <span class="n">Method</span> <span class="n">injectione</span> <span class="o">--&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;AccountDao&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;accountDao&#34;</span><span class="o">&gt;&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

<span class="o">&lt;!--</span><span class="n">add</span> <span class="n">three</span> <span class="k">new</span> <span class="n">bean</span><span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;connectionUtils&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.utils.ConnectionUtils&#34;</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

<span class="o">&lt;!--</span><span class="n">transactionManager</span> <span class="n">bean</span><span class="o">--&gt;</span>
 <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;transactionManager&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.utils.TransactionManager&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;ConnectionUtils&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;connectionUtils&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>
 <span class="o">&lt;!--</span><span class="n">ProxyFactory</span><span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;proxyFactory&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.factory.ProxyFactory&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;TransactionManager&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;transactionManager&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>   
<span class="o">&lt;/</span><span class="n">beans</span><span class="o">&gt;</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcAccountDaoImpl</span> <span class="kd">implements</span> <span class="n">AccountDao</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">ConnectionUtils</span> <span class="n">connectionUtils</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setConnecionUtils</span><span class="o">(</span><span class="n">ConnectionUtils</span> <span class="n">connecionUtils</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">connectionUtils</span> <span class="o">=</span> <span class="n">connectionUtils</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">queryAccountByCardNo</span><span class="o">(</span><span class="n">String</span> <span class="n">cardNo</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        
        <span class="c1">// Connection con = DruidUtils.getInstance().getConnection();
</span><span class="c1"></span>        <span class="c1">// get connection from threadlocal
</span><span class="c1"></span>        <span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getCurrentThreadConn</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select * from account where cardNo=?&#34;</span><span class="o">;</span>
        <span class="n">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">1</span><span class="o">,</span><span class="n">cardNo</span><span class="o">);</span>
        <span class="n">ResultSet</span> <span class="n">resultSet</span> <span class="o">=</span> <span class="n">preparedStatement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>

        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Account</span><span class="o">();</span>
        <span class="k">while</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setCardNo</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;cardNo&#34;</span><span class="o">));</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;money&#34;</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="n">resultSet</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">updateAccountByCardNo</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        
        <span class="c1">// Connection con = DruidUtils.getInstance().getConnection();
</span><span class="c1"></span>        <span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getCurrentThreadConn</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;update account set money=? where cardNo=?&#34;</span><span class="o">;</span>
        <span class="n">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">1</span><span class="o">,</span><span class="n">account</span><span class="o">.</span><span class="na">getMoney</span><span class="o">());</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">2</span><span class="o">,</span><span class="n">account</span><span class="o">.</span><span class="na">getCardNo</span><span class="o">());</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">preparedStatement</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>

        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="c1">// con.close();
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><em><strong>modify TransferServlet</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;transerServlet&#34;</span><span class="o">,</span> <span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">&#34;/transferServlet&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
    <span class="c1">// create service instance
</span><span class="c1"></span>    <span class="c1">// private TransferService transferService = new TransferServiceImpl();
</span><span class="c1"></span>
    <span class="c1">// get service object through BeanFactory
</span><span class="c1"></span>    <span class="c1">// private TransferService transferService = (TransferService) BeanFactory.getBean(&#34;transferService&#34;);
</span><span class="c1"></span>
    <span class="c1">// get proxy object from factory
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">ProxyFactory</span> <span class="n">proxyFactory</span> <span class="o">=</span> <span class="o">(</span><span class="n">ProxyFactory</span><span class="o">)</span> <span class="n">BeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;proxyFactory&#34;</span><span class="o">);</span>
    <span class="kd">private</span> <span class="n">TransferService</span> <span class="n">transferService</span> <span class="o">=</span> <span class="o">(</span><span class="n">TransferService</span><span class="o">)</span> <span class="n">proxyFactory</span><span class="o">.</span><span class="na">getProxy</span><span class="o">(</span><span class="n">BeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;transferService&#34;</span><span class="o">));</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">doPost</span><span class="o">(</span><span class="n">req</span><span class="o">,</span><span class="n">resp</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>

        
        <span class="n">req</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">&#34;UTF-8&#34;</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">fromCardNo</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;fromCardNo&#34;</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">toCardNo</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;toCardNo&#34;</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">moneyStr</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;money&#34;</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">money</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">moneyStr</span><span class="o">);</span>

        <span class="n">Result</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Result</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>

            <span class="c1">// 2. call service method
</span><span class="c1"></span>            <span class="n">transferService</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="n">fromCardNo</span><span class="o">,</span><span class="n">toCardNo</span><span class="o">,</span><span class="n">money</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;200&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;201&#34;</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">// 
</span><span class="c1"></span>        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&#34;application/json;charset=utf-8&#34;</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">print</span><span class="o">(</span><span class="n">JsonUtils</span><span class="o">.</span><span class="na">object2Json</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><em><strong>p2 problem solved</strong></em></p>
<p><em><strong>Q: why use proxy for transferServiceImpl?</strong></em></p>
<p>without proxy, all transtation relate code would be put in the TransferServiceImpl</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServiceImpl</span> <span class="kd">implements</span> <span class="n">TransferService</span> <span class="o">{</span>

   
    <span class="kd">private</span> <span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">;</span>

   

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAccountDao</span><span class="o">(</span><span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accountDao</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">String</span> <span class="n">fromCardNo</span><span class="o">,</span> <span class="n">String</span> <span class="n">toCardNo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="k">try</span><span class="o">{</span>
            
            <span class="n">TransactionManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">beginTransaction</span><span class="o">();*/</span>

            <span class="n">Account</span> <span class="n">from</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">queryAccountByCardNo</span><span class="o">(</span><span class="n">fromCardNo</span><span class="o">);</span>
            <span class="n">Account</span> <span class="n">to</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">queryAccountByCardNo</span><span class="o">(</span><span class="n">toCardNo</span><span class="o">);</span>

            <span class="n">from</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()-</span><span class="n">money</span><span class="o">);</span>
            <span class="n">to</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">to</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()+</span><span class="n">money</span><span class="o">);</span>

            <span class="n">accountDao</span><span class="o">.</span><span class="na">updateAccountByCardNo</span><span class="o">(</span><span class="n">to</span><span class="o">);</span>
            <span class="c1">// make a error to test
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">1</span><span class="o">/</span><span class="n">0</span><span class="o">;</span>
            <span class="n">accountDao</span><span class="o">.</span><span class="na">updateAccountByCardNo</span><span class="o">(</span><span class="n">from</span><span class="o">);</span>
            
            <span class="n">TransactionManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            
            <span class="n">TransactionManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
            
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>we can see the transaction and Impl have become a tight couple, if there are multiple Impl need transaction method, we need add the same codes on every single method. Using proxy way to realize transaction management is a AOP</p>
<h2 id="from-servlet-to-applicatoincontext-1">from Servlet to ApplicatoinContext</h2>
<h2 id="ioc">IoC</h2>
<ul>
<li>
<p><strong>Map</strong> 容器</p>
</li>
<li>
<p><strong>BeanFactory</strong> 工厂</p>
</li>
<li>
<p><strong>ApplicationContext</strong> 上下文：持有BeanFactory引用， 门面模式</p>
</li>
<li>
<p><strong>BeanDefinitionReader</strong>解析器：负责解析所有的配置文件</p>
</li>
<li>
<p><strong>BeanDefinition</strong>元信息，配置（保存各种配置信息）
xml, yml, annotation, properties</p>
</li>
<li>
<p><strong>Bean实例</strong>，反射实例化Object
原生Bean，代理Bean</p>
</li>
<li>
<p><strong>BeanWrapper</strong>包装器模式：缓存到了Ioc容器，缓存
持有Bean引用</p>
</li>
</ul>
<h2 id="ioc-顶层设计-listablebeanfactory为例">IOC 顶层设计， ListableBeanFactory为例</h2>
<p>用户通过 =&gt;  <strong>ApplicationContext</strong> =&gt; 调用 <strong>getBean()<strong>方法， 底层各种factory方法listable等，创建factory对象， 所以要调用</strong>BeanDefinitionReader</strong>, 读取bean配置文件，创建 <strong>BeanDefinition</strong> = &gt; 换存到容器里就是<strong>BeanWrapper</strong>对象， 所以getBean()实际拿到的就是<strong>BeanWrapper</strong>对象</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">init</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">ApplicationContext</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanDefinitionReader</span><span class="o">();</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">();</span>

        <span class="n">factory</span><span class="o">.</span><span class="na">doRegistryBeanDefinition</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">beanDefinitionMap</span><span class="o">.</span><span class="na">put</span><span class="o">()</span>
        <span class="o">}</span>

        <span class="n">doLoadInstance</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">getBean</span><span class="o">()</span> <span class="c1">//循环调用
</span><span class="c1"></span>        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">getBean</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">BeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">beanDefinitionMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>

    <span class="n">Object</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">instantiateBean</span><span class="o">();</span>

    <span class="n">BeanWrapper</span> <span class="n">beanWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanWrapper</span><span class="o">(</span><span class="n">instance</span><span class="o">);</span>

    <span class="n">factoryBeanInstanceCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanWrapper</span><span class="o">);</span>

    <span class="n">populateBean</span><span class="o">();</span> <span class="c1">//依赖注入
</span><span class="c1"></span><span class="o">}</span>
</code></pre></div><p><em><strong>1.1 the most basic bean container</strong></em>
define a simple bean container: BeanFactory, contains a map to store bean, owns registry and get Bean two methods.</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanFactory</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">beanMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBean</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">Object</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">beanMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">Object</span> <span class="nf">getBean</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">beanMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleBeanContainerTest</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">BeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanFactory</span><span class="o">();</span>
		<span class="n">beanFactory</span><span class="o">.</span><span class="na">registerBean</span><span class="o">(</span><span class="s">&#34;helloService&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">HelloService</span><span class="o">());</span>
		<span class="n">HelloService</span> <span class="n">helloService</span> <span class="o">=</span> <span class="o">(</span><span class="n">HelloService</span><span class="o">)</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;helloService&#34;</span><span class="o">);</span>
		<span class="n">assertThat</span><span class="o">(</span><span class="n">helloService</span><span class="o">).</span><span class="na">isNotNull</span><span class="o">();</span>
		<span class="n">assertThat</span><span class="o">(</span><span class="n">helloService</span><span class="o">.</span><span class="na">sayHello</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">class</span> <span class="nc">HelloService</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="n">String</span> <span class="nf">sayHello</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">);</span>
			<span class="k">return</span> <span class="s">&#34;hello&#34;</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div><p><em><strong>BeanDefinition &amp; BeanDefinitionRegistry</strong></em>
<img src="https://github.com/DerekYRC/mini-spring/blob/main/assets/bean-definition-and-bean-definition-registry.png?raw=true" alt="p"></p>
<p><img src="F%EF%BC%9A/blog/themes/anatole/images" alt="image"></p>
<p>click here <a href="https://github.com/RileyCode-hash/SpringNotes/tree/BeanDefinition-BeanDefinitionRegistry/minSpring"  target="_blank" >code download</a></p>
<blockquote>
<p>&hellip;beans.factory.config.SingletonBeanRegistry.java</p>
</blockquote>
<blockquote>
<p>&hellip;beans.factory.config.BeanDefinition.java</p>
</blockquote>
<blockquote>
<p>&hellip;beans.factory.support.DefaultSingletonBeanRegistry.java</p>
</blockquote>
<blockquote>
<p>&hellip;beans.factory.BeanFactory.java</p>
</blockquote>
<blockquote>
<p>&hellip;beans.factory.support.AbstractAutowireCapableBeanFactory.java</p>
</blockquote>
<blockquote>
<p>&hellip;beans.factory.support.AbstractBeanFactory.java</p>
</blockquote>
<blockquote>
<p>&hellip;beans.factory.support.BeanDefinitionRegistry.java</p>
</blockquote>
<blockquote>
<p>&hellip;beans.factory.support.DefaultListableBeanFactory.java</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.springframework.beans</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanDefinitionAndBeanDefinitionRegistryTest</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBeanFactory</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultListableBeanFactory</span><span class="o">();</span>
		<span class="n">BeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanDefinition</span><span class="o">(</span><span class="n">HelloService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">beanFactory</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="s">&#34;helloService&#34;</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>

		<span class="n">HelloService</span> <span class="n">helloService</span> <span class="o">=</span> <span class="o">(</span><span class="n">HelloService</span><span class="o">)</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;helloService&#34;</span><span class="o">);</span>
		<span class="n">helloService</span><span class="o">.</span><span class="na">sayHello</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">HelloService</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">sayHello</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">);</span>
		<span class="k">return</span> <span class="s">&#34;hello&#34;</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>


</code></pre></div><p><em><strong>InstantiationStrategy</strong></em></p>
<p>now we instantiat bean by method : <code>beanClass.newInstance()</code> in <code>AbstractAutowireCapableBeanFactory.doCreateBean</code>. And this only used in <strong>NoArgsConstructo</strong></p>
<p>now create InstantiationStrategy interface with implemented methods
<img src="" alt="image"></p>
<ul>
<li>SimpleInstantiationStrategy: use bean construction</li>
<li>CglibSubclassingInstantiationStrategy，use CGLIB</li>
</ul>
<h1 id="基础java知识">基础java知识</h1>
<h2 id="1-servlet模板模式">1. servlet(模板模式)</h2>
<ul>
<li>HttpServlet已经实现了service方法：HttpServlet是一个抽象类</li>
</ul>
<p>一个类声明成抽象方法，一般有两个原因：
<em>有抽象方法</em> OR
<em>没有抽象方法，但是不希望被实例化</em></p>
<p>HttpServlet做成抽象类，仅仅是为了不让new</p>
<p>如何写一个Servet？</p>
<p>不用实现javax.servlet接口</p>
<p>不用继承GenericServlet抽象类</p>
<p>只需继承HttpServlet并重写doGet()/doPost()</p>
<p>父类把能写的逻辑都写完，把不确定的业务代码抽成一个方法，调用它。当子类重写该方法，整个业务代码就活了。这就是模板方法模式</p>
<p>父类：                                                               子类</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">service() {                                                        service() {
    doXxx(); //具体业务代码，但是父类无法知道子类具体业务逻辑，  &lt;= 继承  doXxx();
    //所以后抽象惩罚让子类重写                                         }
}

protected void doXxx() {                                   &lt;= 覆盖 void doXxx() {
    //空实现，或者默认实现                                          //具体实现
}                                                                   }
</code></pre></div><h2 id="12-servletcontext">1.2 ServletContext</h2>
<p>map，服务器会为每个应用创建一个ServletContext对象</p>
<p>ServletContext对象的作用是在整个Web应用的动态资源（Servlet/JSP）之间共享数据</p>
<p>这种用来装载共享数据的对象，在JavaWeb中共有4个，而且更习惯被成为“域对象”：</p>
<p>ServletContext域（Servlet间共享数据）</p>
<p>Session域（一次会话间共享数据，也可以理解为多次请求间共享数据）</p>
<p>Request域（同一次请求共享数据）</p>
<p>Page域（JSP页面内共享数据）</p>
<p>它们都可以看做是map，都有getAttribute()/setAttribute()方法。</p>
<h2 id="2java泛型generics">2.Java泛型Generics</h2>
<ul>
<li>泛型类 <code>&lt;T&gt;</code>  Type Parameter</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public class ArrayList&lt;T&gt; {
    private T[] array;
    private int size;
    public void add(T e) {...}
    public void remove(int index) {...}
    public T get(int index) {...}
}
</code></pre></div><ul>
<li>对变量类型进行抽取</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public User getUser(T t){...}
</code></pre></div><ul>
<li>获取构造函数的参数</li>
</ul>
<p>获取到构造函数的对象之后，可以通过getParameterTypes()获取到构造函数的参数。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Constructor constructors = birdClass.getConstructor(new Class[]{String.class});
            Class[] parameterTypes = constructors.getParameterTypes();
</code></pre></div><h2 id="3反射">3.反射</h2>
<ul>
<li>JVM是如何构建一个实例的
A a = new A();</li>
</ul>
<blockquote>
<p>Step1: ClassLoader加载.class文件到内存（jvm内存;执行静态代码块和静态初始化语句</p>
</blockquote>
<blockquote>
<p>Step2: 执行new，申请一个内存空间</p>
</blockquote>
<blockquote>
<p>Step3:调用构造器，创建一个空白对象</p>
</blockquote>
<blockquote>
<p>step4：子类调用父类构造器</p>
</blockquote>
<blockquote>
<p>step5:构造器执行： 执行构造代码块和初始化语句； 构造器内容</p>
</blockquote>
<ul>
<li>Class</li>
</ul>
<p>Class类对象就相当于B超的探头，将一个类的方法、变量、接口、类名、类修饰符等信息告诉运行的程序。</p>
<ul>
<li>获取构造函数Constructor</li>
</ul>
<p>获取构造函数的方法：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Class birdClass = Bird.class;
Constructor[] constructors = birdClass.getConstructors();
</code></pre></div><p>一个类会有多个构造函数，getConstructors()返回的是Constructor[]数组，包含了所有声明的用public修饰的构造函数。</p>
<p>如果你已经知道了某个构造的参数，可以通过下面的方法获取到回应的构造函数对象：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public class Alunbar {
    public static void  main(String arts[]){

        Class birdClass = Bird.class;
        try{
            Constructor constructors = birdClass.getConstructor(new Class[]{String.class});
        }catch(NoSuchMethodException  e){

        }
    }

    private class Bird {
        public Bird(){

        }

        public Bird(String eat){

        }
    }
}
</code></pre></div><ul>
<li>类加载器</li>
</ul>
<p>loadClass()，告诉它需要加载的类名，它会帮你加载</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">    // 子类应该重写该方法
    protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException {
        throw new ClassNotFoundException(name);
    }
</code></pre></div><p>加载.class文件大致可以分为3个步骤：</p>
<p>检查是否已经加载，有就直接返回，避免重复加载
当前缓存中确实没有该类，那么遵循父优先加载机制，加载.class文件
上面两步都失败了，调用findClass()方法加载
需要注意的是，ClassLoader类本身是抽象类，而抽象类是无法通过new创建对象的。所以它的findClass()方法写的很随意，直接抛了异常，反正你无法通过ClassLoader对象调用。也就是说，父类ClassLoader中的findClass()方法根本不会去加载.class文件。</p>
<p>正确的做法是，子类重写覆盖findClass()，在里面写自定义的加载逻辑。比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">@Override
public Class&lt;?&gt; findClass(String name) throws ClassNotFoundException {
	try {
		/*自己另外写一个getClassData()
                  通过IO流从指定位置读取xxx.class文件得到字节数组*/
		byte[] datas = getClassData(name);
		if(datas == null) {
			throw new ClassNotFoundException(&#34;类没有找到：&#34; + name);
		}
		//调用类加载器本身的defineClass()方法，由字节码得到Class对象
		return defineClass(name, datas, 0, datas.length);
	} catch (IOException e) {
		e.printStackTrace();
		throw new ClassNotFoundException(&#34;类找不到：&#34; + name);
	}
}
</code></pre></div><p>defineClass()是ClassLoader定义的方法，目的是根据.class文件的字节数组byte[] b造出一个对应的Class对象。我们无法得知具体是如何实现的，因为最终它会调用一个native方法：</p>
<ul>
<li>反射API</li>
</ul>
<blockquote>
<p>创建实例</p>
</blockquote>
<p>clazz.newInstance()底层还是调用Contructor对象的newInstance()。所以，要想调用clazz.newInstance()，必须保证编写类的时候有个无参构造。</p>
<h2 id="为什么根据class对象获取method时需要传入方法名参数的class类型">为什么根据Class对象获取Method时，需要传入方法名+参数的Class类型？</h2>
<p>调用Class对象的getMethod()方法时，内部会循环遍历所有Method，然后根据方法名和参数类型匹配唯一的Method返回。</p>
<h2 id="调用methodinvokeobj-args时为什么要传入一个目标对象">调用method.invoke(obj, args);时为什么要传入一个目标对象？</h2>
<p>把Method理解为方法执行指令吧，它更像是一个方法执行器，必须告诉它要执行的对象（数据）。</p>
<blockquote>
<p>反射调用方法</p>
</blockquote>
<h2 id="4java-动态代理">4.Java 动态代理</h2>
<ul>
<li>问题： 原有代码：</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public class Calculator {

	//加
	public int add(int a, int b) {
		int result = a + b;
		return result;
	}

	//减
	public int subtract(int a, int b) {
		int result = a - b;
		return result;
	}

	//乘法、除法...
}

</code></pre></div><p>现有一个需求：在每个方法执行前后打印日志.</p>
<p>直接修改</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">
public class Calculator {

	//加
	public int add(int a, int b) {
		System.out.println(&#34;add方法开始...&#34;);
		int result = a + b;
		System.out.println(&#34;add方法结束...&#34;);
		return result;
	}

	//减
	public int subtract(int a, int b) {
		System.out.println(&#34;subtract方法开始...&#34;);
		int result = a - b;
		System.out.println(&#34;subtract方法结束...&#34;);
		return result;
	}

	//乘法、除法...
}

</code></pre></div><p>上面的方案是有问题的：</p>
<p>直接修改源程序，不符合开闭原则。应该对扩展开放，对修改关闭
如果Calculator有几十个、上百个方法，修改量太大
存在重复代码（都是在核心代码前后打印日志）
日志打印硬编码在代理类中，不利于后期维护：比如你花了一上午终于写完了，组长告诉你这个功能取消，于是你又要打开Calculator花十分钟删除日志打印的代码！</p>
<ul>
<li>静态代理,通过代理访问目标对象</li>
</ul>
<p>静态代理的实现比较简单：编写一个代理类，实现与目标对象相同的接口，并在内部维护一个目标对象的引用。通过构造器塞入目标对象，在代理对象中调用目标对象的同名方法，并添加前拦截，后拦截等所需的业务功能。</p>
<ul>
<li>将Calculator抽取为接口</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">
/**
 * 目标对象实现类，实现Calculator接口
 */
public class CalculatorImpl implements Calculator {

	//加
	public int add(int a, int b) {
		int result = a + b;
		return result;
	}

	//减
	public int subtract(int a, int b) {
		int result = a - b;
		return result;
	}

	//乘法、除法...
}

</code></pre></div><ul>
<li>创建代理类CalculatorProxy实现Calculator</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">
/**
 * 代理对象实现类，实现Calculator接口
 */
public class CalculatorProxy implements Calculator {
        //代理对象内部维护一个目标对象引用
	private Calculator target;
        
        //构造方法，传入目标对象
	public CalculatorProxy(Calculator target) {
		this.target = target;
	}

        //调用目标对象的add，并在前后打印日志
	@Override
	public int add(int a, int b) {
		System.out.println(&#34;add方法开始...&#34;);
		int result = target.add(a, b);
		System.out.println(&#34;add方法结束...&#34;);
		return result;
	}

        //调用目标对象的subtract，并在前后打印日志
	@Override
	public int subtract(int a, int b) {
		System.out.println(&#34;subtract方法开始...&#34;);
		int result = target.subtract(a, b);
		System.out.println(&#34;subtract方法结束...&#34;);
		return result;
	}

	//乘法、除法...
}

</code></pre></div><ul>
<li>使用代理对象完成加减乘除，并且打印日志</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">
public class Test {
	public static void main(String[] args) {
		//把目标对象通过构造器塞入代理对象
		Calculator calculator = new CalculatorProxy(new CalculatorImpl());
		//代理对象调用目标对象方法完成计算，并在前后打印日志
		calculator.add(1, 2);
		calculator.subtract(2, 1);
	}
}

</code></pre></div><p>没解决重复代码，如果有很多类，没解决修改量太大的问题，
<strong>所以我们要代理的不是代理类，而是代理对象，根据接口自动生成代理对象</strong></p>
<ul>
<li>动态代理</li>
</ul>
<p>Proxy有个静态方法：getProxyClass(ClassLoader, interfaces)，只要你给它传入类加载器和一组接口，它就给你返回代理Class对象。</p>
<ul>
<li>使用代理对象完成加减乘除，并且打印日志</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">
public class ProxyTest {
	public static void main(String[] args) throws Throwable {
		//Calculator的类加载器
		Class calculatorProxyClazz = Proxy.getProxyClass(Calculator.class.getClassLoader(), Calculator.class);
		//得到有参构造器
        Constructor constructor =  calculatorProxyClazz.getConstructor(InvocationHandler.class);
        //反射创建代理实例
        Calculator CalculatorProxyImpl = (Calculator)constructor.newInstance(new InvocationHandler() {
            @Override
            public Object invoke(Object proxy, Method, method, Object[] args) throws Exception {
                //手动new一个目标对象
                CalculatorImpl calculatorImpl = new CalculatorImpl();
                //反射执行目标对象的方法
                Object result = method.invoke(calculatorImpl, args);
                //返回目标对象执行结果
                return result;
            }
        })
		CalculatorProxyImpl.add(1, 2);
		
	}
}

</code></pre></div><p>代理对象改变，invoke方法要改，所以把目标对象当参数传进来</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">
public class ProxyTest {
	public static void main(String[] args) throws Throwable {
        //传入目标对象
        CalculatorImpl target = new CalculatorImpl();
        //根据它实现的接口生成代理对象， 代理对象调用目标对象方法
		Calculator calculatorProxy = (Calculator)getProxy(target);
        calculatorProxy.add(1, 2);
        calculatorProxy.substract(2, 1);
    }

    private static Object getProxy(final Object target) throws Exception {
		Class ProxyClazz = Proxy.getProxyClass(target.getclass().getClassLoader(), target.getclass().getInterfaces());
		//得到有参构造器
        Constructor constructor =  ProxyClazz.getConstructor(InvocationHandler.class);
        //反射创建代理实例
        Object proxy = constructor.newInstance(new InvocationHandler() {
            @Override
            public Object invoke(Object proxy, Method, method, Object[] args) throws Exception {
                System.out.println(method.getName() + &#34;方法开始执行。。&#34;);
                Object result = method.invoke(target, args);
                //反射执行目标对象的方法
                
                return result;
            }
        });
		return proxy;
		
	}
}

</code></pre></div><p>无论现在系统有多少类，只要你把实例传进来，getProxy()都能给你返回对应的代理对象。就这样，我们完美地跳过了代理类，直接创建了代理对象！</p>
<p>不过实际编程中，一般不用getProxyClass()，而是使用Proxy类的另一个静态方法：Proxy.newProxyInstance()，直接返回代理实例，连中间得到代理Class对象的过程都帮你隐藏：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">
public class ProxyTest {
	public static void main(String[] args) throws Throwable {
        //传入目标对象
        CalculatorImpl target = new CalculatorImpl();
        //根据它实现的接口生成代理对象， 代理对象调用目标对象方法
		Calculator calculatorProxy = (Calculator)getProxy(target);
        calculatorProxy.add(1, 2);
        calculatorProxy.substract(2, 1);
    }

    private static Object getProxy(final Object target) throws Exception {
		Object proxy = Proxy.newProxyInstance(target.getclass().getClassLoader(), target.getclass().getInterfaces(),
		new InvocationHandler() {
            
            public Object invoke(Object proxy, Method, method, Object[] args) throws Exception {
                System.out.println(method.getName() + &#34;方法开始执行。。&#34;);
                Object result = method.invoke(target, args);
                //反射执行目标对象的方法
                
                return result;
            }
        }
        );
		return proxy;
		
	}
}

</code></pre></div><h1 id="spring-di">Spring DI</h1>
<p>组合复合原则（怎么给对象自动赋值，循环依赖注入）</p>
<h1 id="spring-mvc">Spring MVC</h1>
<p>委派，策略，解释器原则（用户输入URL怎么样和java代码关联）</p>
<h1 id="spring-aop-2">Spring AOP</h1>
<p>责任，动态代理</p>
<p>我们需要一个通知类（TransactionManager）执行事务，一个代理工厂帮助生成代理对象，然后利用动态代理将事务代码织入代理对象的各个方法中。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">UserService {
    public void test() {
        //开启事务
        userDao.add();
    }
}
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">BrandService {
    public void test() {
        //开启事务
        brandDao.add();
    }
}
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">CategoryService {
    public void test() {
        //开启事务
        categoryDao.add();
    }
}
</code></pre></div><p>希望最终达到的效果是，我加了个@MyTransactional后，代理工厂给我返回一个代理对象：</p>
<p>UserService &ndash;》 入参  |代理工厂| 出参 &ndash;》 UserServiceProxy</p>
<p>细节分析：</p>
<p>UserServiceProxy.test() &ndash;&gt; //+1 +8</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">|代理工厂| 
  代理对象 {
    //1.开启事务
    txManager.beginTransaction(); //+2
    //2.执行事务
    rtValue = method.invoke(target, args) --&gt; 调用代理对象同名方法+3 +5
       //3.提交事务
    txManager.commit(); //+6
    //3.返回结果
    return rtValue; //+7
}
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">UserService {
    public void test() { //+4
        //开启事务
        userDao.add();
    }
}
</code></pre></div><p>代理对象方法 = 事务 + 目标对象方法。</p>
<p>事务操作，必须使用同一个Connection对象。如何保证？第一次从数据源获取Connection对象并开启事务后，将它存入当前线程的ThreadLocal中，等到了DAO层，还是从ThreadLocal中取，这样就能保证开启事务和操作数据库使用的Connection对象是同一个。</p>
<p>开启事务后，Controller并不是直接调用Service，而是Spring提供的代理对象</p>
<p>Service和Dao关系也是i如此</p>
<h1 id="aop事务具体代码实现">AOP事务具体代码实现</h1>
<h2 id="connectionutils工具类">ConnectionUtils工具类</h2>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">com</span><span class="p">.</span><span class="nx">demo</span><span class="p">.</span><span class="nx">myaopframework</span><span class="p">.</span><span class="nx">utils</span><span class="p">;</span>

<span class="kn">import</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">commons</span><span class="p">.</span><span class="nx">dbcp</span><span class="p">.</span><span class="nx">BasicDataSource</span><span class="p">;</span>

<span class="kn">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">sql</span><span class="p">.</span><span class="nx">Connection</span><span class="p">;</span>

<span class="cm">/**
</span><span class="cm"> * 连接的工具类，它用于从数据源中获取一个连接，并且实现和线程的绑定
</span><span class="cm"> */</span>
<span class="nx">public</span> <span class="nx">class</span> <span class="nx">ConnectionUtils</span> <span class="p">{</span>

    <span class="nx">private</span> <span class="nx">ThreadLocal</span><span class="p">&lt;</span><span class="nx">Connection</span><span class="p">&gt;</span> <span class="nx">tl</span> <span class="p">=</span> <span class="nx">new</span> <span class="nx">ThreadLocal</span><span class="p">&lt;</span><span class="nx">Connection</span><span class="p">&gt;();</span>

    <span class="nx">private</span> <span class="nx">static</span> <span class="nx">BasicDataSource</span> <span class="nx">dataSource</span> <span class="p">=</span> <span class="nx">new</span> <span class="nf">BasicDataSource</span><span class="p">();</span>

    <span class="c1">//静态代码块,设置连接数据库的参数
</span><span class="c1"></span>    <span class="nx">static</span><span class="p">{</span>
        <span class="nx">dataSource</span><span class="p">.</span><span class="nf">setDriverClassName</span><span class="p">(</span><span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="p">);</span>
        <span class="nx">dataSource</span><span class="p">.</span><span class="nf">setUrl</span><span class="p">(</span><span class="s">&#34;jdbc:mysql://localhost:3306/test&#34;</span><span class="p">);</span>
        <span class="nx">dataSource</span><span class="p">.</span><span class="nf">setUsername</span><span class="p">(</span><span class="s">&#34;root&#34;</span><span class="p">);</span>
        <span class="nx">dataSource</span><span class="p">.</span><span class="nf">setPassword</span><span class="p">(</span><span class="s">&#34;123456&#34;</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="cm">/**
</span><span class="cm">     * 获取当前线程上的连接
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="nx">public</span> <span class="nx">Connection</span> <span class="nf">getThreadConnection</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">try</span><span class="p">{</span>
            <span class="c1">//1.先从ThreadLocal上获取
</span><span class="c1"></span>            <span class="nx">Connection</span> <span class="nx">conn</span> <span class="p">=</span> <span class="nx">tl</span><span class="p">.</span><span class="nf">get</span><span class="p">();</span>
            <span class="c1">//2.判断当前线程上是否有连接
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">conn</span> <span class="o">==</span> <span class="nx">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//3.从数据源中获取一个连接，并且存入ThreadLocal中
</span><span class="c1"></span>                <span class="nx">conn</span> <span class="p">=</span> <span class="nx">dataSource</span><span class="p">.</span><span class="nf">getConnection</span><span class="p">();</span>
                <span class="nx">tl</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">conn</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">//4.返回当前线程上的连接
</span><span class="c1"></span>            <span class="k">return</span> <span class="nx">conn</span><span class="p">;</span>
        <span class="p">}</span><span class="nf">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">){</span>
            <span class="nx">throw</span> <span class="nx">new</span> <span class="nf">RuntimeException</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**
</span><span class="cm">     * 把连接和线程解绑
</span><span class="cm">     */</span>
    <span class="nx">public</span> <span class="nx">void</span> <span class="nf">removeConnection</span><span class="p">(){</span>
        <span class="nx">tl</span><span class="p">.</span><span class="nf">remove</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="aop通知事务管理器">AOP通知（事务管理器）</h2>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">com</span><span class="p">.</span><span class="nx">demo</span><span class="p">.</span><span class="nx">myaopframework</span><span class="p">.</span><span class="nx">utils</span><span class="p">;</span>

<span class="cm">/**
</span><span class="cm"> * 和事务管理相关的工具类，它包含了，开启事务，提交事务，回滚事务和释放连接
</span><span class="cm"> */</span>
<span class="nx">public</span> <span class="nx">class</span> <span class="nx">TransactionManager</span> <span class="p">{</span>

    <span class="nx">private</span> <span class="nx">ConnectionUtils</span> <span class="nx">connectionUtils</span><span class="p">;</span>

    <span class="nx">public</span> <span class="nx">void</span> <span class="nf">setConnectionUtils</span><span class="p">(</span><span class="nx">ConnectionUtils</span> <span class="nx">connectionUtils</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">this</span><span class="p">.</span><span class="nx">connectionUtils</span> <span class="p">=</span> <span class="nx">connectionUtils</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**
</span><span class="cm">     * 开启事务
</span><span class="cm">     */</span>
    <span class="nx">public</span>  <span class="nx">void</span> <span class="nf">beginTransaction</span><span class="p">(){</span>
        <span class="nx">try</span> <span class="p">{</span>
            <span class="nx">connectionUtils</span><span class="p">.</span><span class="nf">getThreadConnection</span><span class="p">().</span><span class="nf">setAutoCommit</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span><span class="nf">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">){</span>
            <span class="nx">e</span><span class="p">.</span><span class="nf">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**
</span><span class="cm">     * 提交事务
</span><span class="cm">     */</span>
    <span class="nx">public</span>  <span class="nx">void</span> <span class="nf">commit</span><span class="p">(){</span>
        <span class="nx">try</span> <span class="p">{</span>
            <span class="nx">connectionUtils</span><span class="p">.</span><span class="nf">getThreadConnection</span><span class="p">().</span><span class="nf">commit</span><span class="p">();</span>
        <span class="p">}</span><span class="nf">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">){</span>
            <span class="nx">e</span><span class="p">.</span><span class="nf">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**
</span><span class="cm">     * 回滚事务
</span><span class="cm">     */</span>
    <span class="nx">public</span>  <span class="nx">void</span> <span class="nf">rollback</span><span class="p">(){</span>
        <span class="nx">try</span> <span class="p">{</span>
            <span class="nx">connectionUtils</span><span class="p">.</span><span class="nf">getThreadConnection</span><span class="p">().</span><span class="nf">rollback</span><span class="p">();</span>
        <span class="p">}</span><span class="nf">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">){</span>
            <span class="nx">e</span><span class="p">.</span><span class="nf">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="cm">/**
</span><span class="cm">     * 释放连接
</span><span class="cm">     */</span>
    <span class="nx">public</span>  <span class="nx">void</span> <span class="nf">release</span><span class="p">(){</span>
        <span class="nx">try</span> <span class="p">{</span>
            <span class="nx">connectionUtils</span><span class="p">.</span><span class="nf">getThreadConnection</span><span class="p">().</span><span class="nb">close</span><span class="p">();</span><span class="c1">//还回连接池中
</span><span class="c1"></span>            <span class="nx">connectionUtils</span><span class="p">.</span><span class="nf">removeConnection</span><span class="p">();</span>
        <span class="p">}</span><span class="nf">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">){</span>
            <span class="nx">e</span><span class="p">.</span><span class="nf">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="自定义注解">自定义注解</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface MyTransactional {
}
</code></pre></div><h2 id="service">Service</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public interface UserService {
	void getUser();
}

 
public class UserServiceImpl implements UserService {
	@Override
	public void getUser() {
		System.out.println(&#34;service执行...&#34;);
	}
}
</code></pre></div><h2 id="实例工厂">实例工厂</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public class BeanFactory {

	public Object getBean(String name) throws Exception {
		//得到目标类的Class对象
		Class&lt;?&gt; clazz = Class.forName(name);
		//得到目标对象
		Object bean = clazz.newInstance();
		//得到目标类上的@MyTransactional注解
		MyTransactional myTransactional = clazz.getAnnotation(MyTransactional.class);
		//如果打了@MyTransactional注解，返回代理对象，否则返回目标对象
		if (null != myTransactional) {
			ProxyFactoryBean proxyFactoryBean = new ProxyFactoryBean();
			TransactionManager txManager = new TransactionManager();
			txManager.setConnectionUtils(new ConnectionUtils());
			//装配通知和目标对象
			proxyFactoryBean.setTxManager(txManager);
			proxyFactoryBean.setTarget(bean);
			Object proxyBean = proxyFactoryBean.getProxy();
			//返回代理对象
			return proxyBean;
		}
		//返回目标对象
		return bean;
	}
}
</code></pre></div><h2 id="代理工厂">代理工厂</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">public class ProxyFactoryBean {
	//通知
	private TransactionManager txManager;
	//目标对象
	private Object target;

	public void setTxManager(TransactionManager txManager) {
		this.txManager = txManager;
	}

	public void setTarget(Object target) {
		this.target = target;
	}

	//传入目标对象target，为它装配好通知，返回代理对象
	public Object getProxy() {
		Object proxy = Proxy.newProxyInstance(
				target.getClass().getClassLoader(),/*1.类加载器*/
				target.getClass().getInterfaces(), /*2.目标对象实现的接口*/
				new InvocationHandler() {/*3.InvocationHandler*/
					@Override
					public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
						try {
							//1.开启事务
							txManager.beginTransaction();
							//2.执行操作
							Object retVal = method.invoke(target, args);
							//3.提交事务
							txManager.commit();
							//4.返回结果
							return retVal;
						} catch (Exception e) {
							//5.回滚事务
							txManager.rollback();
							throw new RuntimeException(e);
						} finally {
							//6.释放连接
							txManager.release();
						}

					}
				}
		);
		return proxy;
	}

}
</code></pre></div><p>AOPTest,</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">BeanFactory beanFactory = new BeanFactory();
try {
    Object bean = beanFactory.getBean(&#34;com.demo.mya.service.UserServiceImpl&#34;);
    Sout(bean.getClass().getName());
}
</code></pre></div><blockquote>
<p>com.demo.mya.service.UserServiceImpl</p>
</blockquote>
<p>给UserServiceImpl添加@MyTransactional注解，得到代理对象：</p>
<blockquote>
<p>com.sun.proxy.$Proxy2</p>
</blockquote>
<h1 id="jdbc">JDBC</h1>
<h1 id="jdbc的演化版本10">JDBC的演化版本1.0</h1>
<p>通过DriveManager得到Connection，得到PreparedStatement, PreparedStatement执行sql返回结果</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Basic</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testJdbc</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
        <span class="c1">// 1.注册驱动
</span><span class="c1"></span>        <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="o">);</span>

        <span class="c1">// 2.建立练连接
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&#34;jdbc:mysql://192.168.56.10:3306/test&#34;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">user</span> <span class="o">=</span> <span class="s">&#34;root&#34;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="s">&#34;root&#34;</span><span class="o">;</span>
        <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>

        <span class="c1">// 3. 创建sql模板
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select * from t_user where id = ?&#34;</span><span class="o">;</span>
        <span class="n">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">preparedStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>

        <span class="c1">// 4. 设置模板参考
</span><span class="c1"></span>        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">5</span><span class="o">);</span>

        <span class="c1">// 5. 执行语句
</span><span class="c1"></span>        <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">preparedStatement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>

        <span class="c1">// 6. 处理结果
</span><span class="c1"></span>        <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">1</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">rs</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">2</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">rs</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">3</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">rs</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">4</span><span class="o">))</span><span class="err">；</span>
            
        <span class="o">}</span>

        <span class="c1">// 7. 释放资源
</span><span class="c1"></span>        <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">preparedStement</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">conn</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="获取connection的步骤太复杂需要封装-资源释放太随意不够规范数据库的连接数是有限的如果不及时释放会导致其他请求无法访问应该把释放资源的操作放在finally中保证资源一定会被关闭">获取Connection的步骤太复杂，需要封装； 资源释放太随意，不够规范，数据库的连接数是有限的，如果不及时释放，会导致其他请求无法访问。应该把释放资源的操作放在finally中，保证资源一定会被关闭。</h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Basic</span> <span class="o">{</span>
    <span class="c1">// 抛异常
</span><span class="c1"></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testJdbc</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 1. 获得连接
</span><span class="c1"></span>            <span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select * from t_user where id = ?&#34;</span><span class="o">;</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">preparedStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>

            <span class="c1">// 4. 设置模板参考
</span><span class="c1"></span>            <span class="n">ps</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">5</span><span class="o">);</span>

            <span class="c1">// 5. 执行语句
</span><span class="c1"></span>            <span class="n">rs</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>

            <span class="c1">// 6. 处理结果
</span><span class="c1"></span>            <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">1</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">rs</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">2</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">rs</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">3</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">rs</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">4</span><span class="o">))</span><span class="err">；</span>
                
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>JdbcUtils 1.0版本</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcUtils</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="n">Properties</span> <span class="n">pros</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="c1">// 只在JdbcUtils类都加载执行一次
</span><span class="c1"></span>        <span class="kd">static</span> <span class="o">{</span>
            <span class="c1">// 1. 给pros进行初始化，加载jdbc.properties文件到props对象中
</span><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
                <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&#34;jdbc.properties&#34;</span><span class="o">);</span>
                <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
                <span class="n">props</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>  
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">//加载驱动类
</span><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
                <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;driver&#34;</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// 获取连接
</span><span class="c1"></span>        <span class="kd">public</span> <span class="kd">static</span> <span class="n">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
            <span class="c1">// 得到Connection
</span><span class="c1"></span>            <span class="k">return</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;url&#34;</span><span class="o">),</span>
                            <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">),</span>
                            <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;password&#34;</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="c1">// 释放连接
</span><span class="c1"></span>        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">free</span> <span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="n">Statement</span> <span class="n">st</span><span class="o">,</span> <span class="n">Connection</span> <span class="n">conn</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrack</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrack</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">conn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="n">conn</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
					<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
					<span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="crud">CRUD</h2>
<p>crud</p>
<ul>
<li>dao
<ul>
<li>UserDao(interface)</li>
<li>UserDaoJdbcImpl</li>
</ul>
</li>
<li>pojo
<ul>
<li>User</li>
</ul>
</li>
<li>DAOTest</li>
<li>JdbcUtils</li>
</ul>
<p>UserDao</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDao</span> <span class="o">{</span>
	<span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span><span class="o">;</span>
	<span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span><span class="o">;</span>
	<span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span><span class="o">;</span>
	<span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">Id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span><span class="o">;</span>
	<span class="n">User</span> <span class="nf">findUser</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>UserDaoJdbcImpl</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDaoJdbcImpl</span> <span class="kd">implements</span> <span class="n">UserDao</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
		<span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
			<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;insert into t_user(name,age, birthday) values (?,?,?) &#34;</span><span class="o">;</span>
			<span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
			<span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
			<span class="n">ps</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">());</span>
			<span class="n">ps</span><span class="o">.</span><span class="na">setDate</span><span class="o">(</span><span class="n">3</span><span class="o">,</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">Date</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getBirthday</span><span class="o">().</span><span class="na">getTime</span><span class="o">()));</span>
			<span class="k">return</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
<span class="cm">/* 		} catch (SQLExceptoin e) {
</span><span class="cm">            //转为DaoException（运行时异常）抛出，Service层可以不处理                         
</span><span class="cm">			throw new DaoException(e.getMessage(), e); */</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
		<span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
			<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;delete from t_user where id=?&#34;</span><span class="o">;</span>
			<span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
			<span class="n">ps</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
		 
        <span class="cm">/* 		} catch (SQLExceptoin e) {
</span><span class="cm">            //转为DaoException（运行时异常）抛出，Service层可以不处理                         
</span><span class="cm">			throw new DaoException(e.getMessage(), e); */</span>
        <span class="o">}</span>   <span class="k">finally</span> <span class="o">{</span>
			<span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
		<span class="o">}</span>

	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
		<span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
			<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;update t_user set name=?, age=?, birthday=? where id=? &#34;</span><span class="o">;</span>
			<span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
			<span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
			<span class="n">ps</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">());</span>
			<span class="n">ps</span><span class="o">.</span><span class="na">setDate</span><span class="o">(</span><span class="n">3</span><span class="o">,</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">Date</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getBirthday</span><span class="o">().</span><span class="na">getTime</span><span class="o">()));</span>
			<span class="n">ps</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">4</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
			<span class="k">return</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
            <span class="cm">/* 		} catch (SQLExceptoin e) {
</span><span class="cm">            //转为DaoException（运行时异常）抛出，Service层可以不处理                         
</span><span class="cm">			throw new DaoException(e.getMessage(), e); */</span>
		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">User</span> <span class="nf">findUser</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
		<span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
			<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select id, name, birthday  from t_user where name=? and age=?&#34;</span><span class="o">;</span>
			<span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
			<span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
			<span class="n">ps</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">age</span><span class="o">);</span>
			<span class="n">rs</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
			<span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">));</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;age&#34;</span><span class="o">));</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getDate</span><span class="o">(</span><span class="s">&#34;birthday&#34;</span><span class="o">));</span>
			<span class="cm">/* 		} catch (SQLExceptoin e) {
</span><span class="cm">            //转为DaoException（运行时异常）抛出，Service层可以不处理                         
</span><span class="cm">			throw new DaoException(e.getMessage(), e); */</span>
		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">user</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
		<span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
			<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select id, name, age, birthday from t_user where id=?&#34;</span><span class="o">;</span>
			<span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
			<span class="n">ps</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
			<span class="n">rs</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
			<span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">));</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;age&#34;</span><span class="o">));</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getDate</span><span class="o">(</span><span class="s">&#34;birthday&#34;</span><span class="o">));</span>
			<span class="cm">/* 		} catch (SQLExceptoin e) {
</span><span class="cm">            //转为DaoException（运行时异常）抛出，Service层可以不处理                         
</span><span class="cm">			throw new DaoException(e.getMessage(), e); */</span>
		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">user</span><span class="o">;</span>
	<span class="o">}</span>

</code></pre></div><p>DAOTest</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DAOTest</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
		<span class="n">UserDao</span> <span class="n">userDao</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserDaoJdbcImpl</span><span class="o">();</span>
		<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
		<span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="n">19</span><span class="o">);</span>
		<span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;little ming&#34;</span><span class="o">);</span>
		<span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
		<span class="n">userDao</span><span class="o">.</span><span class="na">addUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>异常处理
上面的CRUD并没有捕获异常，而是直接往外抛。这会带来两个后果：</p>
<p>SQLException是编译时异常，Service在调用DAO时必须处理异常，否则编译不通过。如何处理？要么继续抛，交给Controller处理（意义不大），要么try catch（Service层代码很臃肿，不美观）。
DAO接口有声明异常SQLException，这等于向外界暴露DAO层是JDBC实现。而且针对该接口只能用关系型数据库，耦合度太高了。后期无法切换DAO实现。
比较好的做法是，将SQLException转为运行时异常抛出，Service层可处理也可不处理。</p>
<p>DaoException</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DaoException</span> <span class="kd">extends</span> <span class="n">RuntimeException</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="nf">DaoException</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">DaoException</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">DaoException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">DaoException</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="模板方法模式重构">模板方法模式重构</h2>
<p>繁琐， 如果还有StudentDaoJdbcImpl、TeacherDaoJdbcImpl，那么同样的代码要写好多遍。所以，必须要重构。大体思路是：相同的代码抽取到父类AbstractDao。观察UserDao， 不论是UserDaoLmpl还是StudentDaoJdbcImpl，TeacherDaoJdbcImp，
只有sql模板和设置模板参数的代码不同。可以把sql和参数抽取成父类方法的形参</p>
<blockquote>
<p>String sql = &ldquo;select id, name, age, birthday from t_user where id=?&quot;;</p>
</blockquote>
<blockquote>
<p>ps.setInt(1, userId);</p>
</blockquote>
<p>AbstractDao</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractDao</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">String</span> <span class="n">sql</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span><span class="na">args</span><span class="o">)</span>  <span class="o">{</span>
		<span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
			<span class="c1">// String sql = &#34;insert into t_user(name,age, birthday) values (?,?,?) &#34;;
</span><span class="c1"></span>
            <span class="c1">// sql由调用者传入
</span><span class="c1"></span>			<span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
			<span class="c1">// ps.setString(1, user.getName());
</span><span class="c1"></span>			<span class="c1">// ps.setInt(2, user.getAge());
</span><span class="c1"></span>			<span class="c1">// ps.setDate(3, new java.sql.Date(user.getBirthday().getTime()));
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">ps</span><span class="o">.</span><span class="na">setObject</span><span class="o">(</span><span class="n">i</span><span class="o">+</span> <span class="n">1</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
			<span class="k">return</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLExceptoin</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>                      
			<span class="k">throw</span> <span class="k">new</span> <span class="n">DaoException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>UserDaoImpl</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDaoImpl</span> <span class="kd">extends</span> <span class="n">AbstractDao</span> <span class="kd">implements</span> <span class="n">UserDao</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;insert into t_user(name, age, birthday) values (?,?,?) &#34;</span><span class="o">;</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getBirthday</span><span class="o">()};</span>
        
        <span class="c1">// 调用父类AbstractDao方法
</span><span class="c1"></span>        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;update t_user set name=?, age=?, birthday=? where id=? &#34;</span><span class="o">;</span>
		<span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">(),</span>
				<span class="n">user</span><span class="o">.</span><span class="na">getBirthday</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()};</span>
		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="c1">//改
</span><span class="c1"></span>	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;delete from t_user where id=?&#34;</span><span class="o">;</span>
		<span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()};</span>
		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>如何抽取查询方法?</p>
<p>user， student都需要用map来装</p>
<p>父类无法制定一个通用代码满足所有子类的结果集映射，因为只有子类自己知道映射规则。所以，我们只能把结果集映射的权利交还给子类去实现。子类如果需要查询，就必须自己实现AbstractDao的rowMapper方法。</p>
<p>AbstractDao</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractDao</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">String</span> <span class="n">sql</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span><span class="na">args</span><span class="o">)</span>  <span class="o">{</span>
		<span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
			<span class="c1">// String sql = &#34;insert into t_user(name,age, birthday) values (?,?,?) &#34;;
</span><span class="c1"></span>
            <span class="c1">// sql由调用者传入
</span><span class="c1"></span>			<span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
			<span class="c1">// ps.setString(1, user.getName());
</span><span class="c1"></span>			<span class="c1">// ps.setInt(2, user.getAge());
</span><span class="c1"></span>			<span class="c1">// ps.setDate(3, new java.sql.Date(user.getBirthday().getTime()));
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">ps</span><span class="o">.</span><span class="na">setObject</span><span class="o">(</span><span class="n">i</span><span class="o">+</span> <span class="n">1</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
			<span class="k">return</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLExceptoin</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>                      
			<span class="k">throw</span> <span class="k">new</span> <span class="n">DaoException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
    <span class="c1">//查询
</span><span class="c1"></span>    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">query</span><span class="o">(</span><span class="n">String</span> <span class="n">sql</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">RowMapper</span><span class="o">,</span> <span class="n">rowMapper</span><span class="o">)</span>  <span class="o">{</span>
    <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">List</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="c1">// sql由调用者传入
</span><span class="c1"></span>        <span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
 
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">ps</span><span class="o">.</span><span class="na">setObject</span><span class="o">(</span><span class="n">i</span><span class="o">+</span> <span class="n">1</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">rowMapper</span><span class="o">.</span><span class="na">mapRow</span><span class="o">(</span><span class="n">rs</span><span class="o">);</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLExceptoin</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>                      
        <span class="k">throw</span> <span class="k">new</span> <span class="n">DaoException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 定义成抽象方法，让子类去实现
</span><span class="c1"></span>	<span class="kd">abstract</span> <span class="kd">protected</span> <span class="n">Object</span> <span class="nf">rowMapper</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">);</span>
       
</code></pre></div><p>UserDaoImpl</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">User</span> <span class="nf">findUser</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span>  <span class="s">&#34;select id, name, age, birthday from t_user where id=?&#34;</span><span class="o">;</span>
    <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span><span class="n">name</span><span class="o">,</span> <span class="n">age</span><span class="o">};</span>
    <span class="n">Object</span> <span class="n">user</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">user</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span>  <span class="s">&#34;select id, name, age, birthday from t_user where name=? and age=?&#34;</span><span class="o">;</span>
    <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span><span class="n">id</span><span class="o">};</span>
    <span class="n">Object</span> <span class="n">user</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">user</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">//UserDaoImpl的结果map
</span><span class="c1"></span><span class="kd">protected</span> <span class="n">Object</span> <span class="nf">rowMapper</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
           <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">));</span>
			<span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;age&#34;</span><span class="o">));</span>
			<span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
			<span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getDate</span><span class="o">(</span><span class="s">&#34;birthday&#34;</span><span class="o">));</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="n">DaoException</span><span class="o">(</span><span class="s">&#34;mapping error&#34;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">user</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="假设现在userdao增加了一个新方法">假设现在UserDao增加了一个新方法?</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDao</span> <span class="o">{</span>
	<span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
	<span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
	<span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
	<span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">Id</span><span class="o">);</span>
	<span class="n">User</span> <span class="nf">findUser</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
	<span class="c1">//新增查询方法：根据年龄查询
</span><span class="c1"></span>	<span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">selectUsers</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h3 id="返回值是listuser而userdaoimpl中实现的映射方法rowmapper只能封装user对象">返回值是List<User>，而UserDaoImpl中实现的映射方法rowMapper()只能封装User对象：</h3>
<p>直接传方法不行？那我就把这个方法塞进一个对象里，通过对象去调用方法（把需要代理对象执行的代码写在InvocationHandler对象的invoke方法中，再把invocationHandler塞进代理对象供它调用）。</p>
<p>这种模式其实叫策略模式，而且一般是传入接口的实现类。</p>
<p>现在子类已经不需要实现父类的抽象方法了（一个规则无法满足不同返回值映射），改为由子类实现RowMapper接口传入匿名对象的方式，所以AbstractDao中的抽象方法可以删除。也就是说AbstractDao已经没有抽象方法了。于是我把它声明为普通类（可以new），并改名为MyJDBCTemplate。而且，使用MyJDBCTemplate时，我决定不再使用继承，而是选择组合方式（组合比继承灵活）。
RowMapper</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">interfae</span> <span class="n">RowMapper</span> <span class="o">{</span>
    <span class="c1">// map result 
</span><span class="c1"></span>    <span class="n">Object</span> <span class="nf">mapRow</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>MyJDBCTemplate</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyJDBCTmplate</span> <span class="o">{</span>
    <span class="c1">//增删改
</span><span class="c1"></span>	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">String</span> <span class="n">sql</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span><span class="na">args</span><span class="o">)</span>  <span class="o">{</span>
		<span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
			<span class="c1">// String sql = &#34;insert into t_user(name,age, birthday) values (?,?,?) &#34;;
</span><span class="c1"></span>
            <span class="c1">// sql由调用者传入
</span><span class="c1"></span>			<span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
			<span class="c1">// ps.setString(1, user.getName());
</span><span class="c1"></span>			<span class="c1">// ps.setInt(2, user.getAge());
</span><span class="c1"></span>			<span class="c1">// ps.setDate(3, new java.sql.Date(user.getBirthday().getTime()));
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">ps</span><span class="o">.</span><span class="na">setObject</span><span class="o">(</span><span class="n">i</span><span class="o">+</span> <span class="n">1</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
			<span class="k">return</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLExceptoin</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>                      
			<span class="k">throw</span> <span class="k">new</span> <span class="n">DaoException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
    <span class="c1">//查询
</span><span class="c1"></span>    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">query</span><span class="o">(</span><span class="n">String</span> <span class="n">sql</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">RowMapper</span> <span class="n">rowMapper</span><span class="o">)</span>  <span class="o">{</span>
    <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">List</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="c1">// sql由调用者传入
</span><span class="c1"></span>        <span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
 
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">ps</span><span class="o">.</span><span class="na">setObject</span><span class="o">(</span><span class="n">i</span><span class="o">+</span> <span class="n">1</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">rowMapper</span><span class="o">.</span><span class="na">mapRow</span><span class="o">(</span><span class="n">rs</span><span class="o">);</span>
				<span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLExceptoin</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>                      
        <span class="k">throw</span> <span class="k">new</span> <span class="n">DaoException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

       
</code></pre></div><p>UserDaoImpl</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDaoImpl</span> <span class="kd">implements</span> <span class="n">UserDao</span> <span class="o">{</span>
    <span class="n">MyDBCTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyJDBCTemplate</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;insert into t_user(name, age, birthday) values (?,?,?) &#34;</span><span class="o">;</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getBirthday</span><span class="o">()};</span>
        
        <span class="c1">// 调用父类AbstractDao方法
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;update t_user set name=?, age=?, birthday=? where id=? &#34;</span><span class="o">;</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getBirthday</span><span class="o">(),</span>  <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()};</span>
        
        <span class="c1">// 调用父类AbstractDao方法
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">User</span> <span class="nf">findUser</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span>  <span class="s">&#34;select id, name, age, birthday from t_user where id=?&#34;</span><span class="o">;</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span><span class="n">name</span><span class="o">,</span> <span class="n">age</span><span class="o">};</span>
        <span class="n">Object</span> <span class="n">user</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;delete from t_user where id=?&#34;</span><span class="o">;</span>
    <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()};</span>
    <span class="c1">//调用jdbcTemplate的update方法
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span>  <span class="s">&#34;select id, name, age, birthday from t_user where id=?&#34;</span><span class="o">;</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span><span class="n">id</span><span class="o">};</span>
        <span class="c1">//调用jdbcTemplate的query方法，传入sql，args， RowMapper匿名对象
</span><span class="c1"></span>        <span class="n">List</span> <span class="n">list</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="k">new</span> <span class="n">RowMapper</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">mapRow</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
                <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
               <span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;age&#34;</span><span class="o">));</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getDate</span><span class="o">(</span><span class="s">&#34;birthday&#34;</span><span class="o">));</span>
				<span class="k">return</span> <span class="n">user</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>
        
        <span class="k">return</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="o">}</span>

     <span class="kd">public</span> <span class="n">User</span> <span class="nf">findUser</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span>  <span class="s">&#34;select id, name, age, birthday from t_user where name=? and age=?&#34;</span><span class="o">;</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span><span class="n">name</span><span class="o">,</span> <span class="n">age</span><span class="o">};</span>
        <span class="c1">//调用jdbcTemplate的query方法，传入sql，args， RowMapper匿名对象
</span><span class="c1"></span>        <span class="n">List</span> <span class="n">list</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="k">new</span> <span class="n">RowMapper</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">mapRow</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
                <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
                <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">));</span>
               <span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;age&#34;</span><span class="o">));</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getDate</span><span class="o">(</span><span class="s">&#34;birthday&#34;</span><span class="o">));</span>
				<span class="k">return</span> <span class="n">user</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>
        
        <span class="k">return</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="o">}</span>

     <span class="kd">public</span> <span class="n">List</span> <span class="nf">selectUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span>  <span class="s">&#34;select id, name, age, birthday from t_user where age=?&#34;</span><span class="o">;</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span><span class="n">age</span><span class="o">};</span>
        <span class="c1">//调用jdbcTemplate的query方法，传入sql，args， RowMapper匿名对象
</span><span class="c1"></span>        <span class="n">List</span> <span class="n">list</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="k">new</span> <span class="n">RowMapper</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">mapRow</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
                <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
                <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">));</span>
               <span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;age&#34;</span><span class="o">));</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
				<span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getDate</span><span class="o">(</span><span class="s">&#34;birthday&#34;</span><span class="o">));</span>
				<span class="k">return</span> <span class="n">user</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>
        
        <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>

 
</code></pre></div><p>jdbcUtils 2.0</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcUtils</span> <span class="o">{</span>

        <span class="c1">//初始化一个数据库
</span><span class="c1"></span>        <span class="kd">private</span> <span class="kd">static</span> <span class="n">MyDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyDataSource</span><span class="o">();</span>

        <span class="c1">// 获取连接
</span><span class="c1"></span>        <span class="kd">public</span> <span class="kd">static</span> <span class="n">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
            <span class="c1">// 从数据源获取Connection并返回
</span><span class="c1"></span>            <span class="k">return</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="o">}</span>

          <span class="c1">// 获取数据源
</span><span class="c1"></span>        <span class="kd">public</span> <span class="kd">static</span> <span class="n">MyDataSource</span> <span class="nf">getDataSource</span><span class="o">()</span> <span class="o">{</span>   
            <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// 释放连接
</span><span class="c1"></span>        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">free</span> <span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="n">Statement</span> <span class="n">st</span><span class="o">,</span> <span class="n">Connection</span> <span class="n">conn</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrack</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrack</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">conn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="n">conn</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
					<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
					<span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>MyDataSource</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyDataSource</span> <span class="o">{</span>

        <span class="c1">//数据库信息，用于连接数据库，放进properties里面
</span><span class="c1"></span>       <span class="cm">/*  private static String url = &#34;jdbc:mysql://192.168.56.10:3306/test?userSSL-false&#34;;
</span><span class="cm">        private static String user = &#34;root&#34;;
</span><span class="cm">        private static String password = &#34;root&#34;; */</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="n">Properties</span> <span class="n">pros</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="c1">// 数据库信息 
</span><span class="c1"></span>        <span class="kd">static</span> <span class="o">{</span>
            <span class="c1">// 1. 给pros进行初始化，加载jdbc.properties文件到props对象中
</span><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
                <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&#34;jdbc.properties&#34;</span><span class="o">);</span>
                <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
                <span class="n">props</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>  
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
<span class="c1">//连接池数据，省略
</span><span class="c1"></span>        <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">initCount</span> <span class="o">=</span> <span class="n">5</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">currentIdleCount</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

<span class="c1">//LinkedList充当连接池，removeFirst取出连接，addLast归还连接
</span><span class="c1"></span>        <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">Connection</span><span class="o">&gt;</span> <span class="n">connectionpool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
    
        <span class="kd">public</span> <span class="nf">MyDataSource</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">initCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="c1">// 创建RealConnection
</span><span class="c1"></span>                    <span class="n">Connection</span> <span class="n">realConnection</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;url&#34;</span><span class="o">),</span>
                                <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">),</span>
                                <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;password&#34;</span><span class="o">));</span>
                                <span class="c1">// 将RealConnection传入createProxyConnection(),得到代理连接并加入池中， currentIdleCount++
</span><span class="c1"></span>                    <span class="n">connectionPool</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">createProxyConnection</span><span class="o">(</span><span class="n">realConnection</span><span class="o">));</span>
                    <span class="n">currentIdleCount</span><span class="o">++;</span>
                <span class="o">}</span>
                <span class="n">Sout</span><span class="o">(</span><span class="s">&#34;...连接池初始化结束&#34;</span> <span class="o">+</span> <span class="n">currentIdleCount</span> <span class="o">+</span> <span class="s">&#34;个Connection...&#34;</span><span class="o">)</span>
            <span class="o">}</span> <span class="k">catch</span>
        <span class="o">}</span>

        <span class="c1">// 获取连接
</span><span class="c1"></span>        <span class="kd">public</span> <span class="n">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
            <span class="c1">// 同步代码
</span><span class="c1"></span>            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">connectionPool</span><span class="o">)</span> <span class="o">{</span>

                <span class="c1">// 连接池中还有空闲连接，从池中取出，currentIdleCount--
</span><span class="c1"></span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">connectionPool</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
        <span class="o">}</span>


        <span class="c1">// 释放连接
</span><span class="c1"></span>        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">free</span> <span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="n">Statement</span> <span class="n">st</span><span class="o">,</span> <span class="n">Connection</span> <span class="n">conn</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrack</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrack</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">conn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="n">conn</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
					<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
					<span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h1 id="工厂模式重构">工厂模式重构</h1>
<p>User</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Date</span> <span class="n">birthday</span><span class="o">;</span>

        <span class="c1">//省略getter、setter...
</span><span class="c1"></span><span class="o">}</span>
</code></pre></div><p>DaoFactory</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DaoFactory</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">UserDao</span> <span class="n">userDao</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">DaoFactory</span> <span class="n">daoFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DaoFactory</span><span class="o">();</span>

	<span class="kd">private</span> <span class="nf">DaoFactory</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">Properties</span> <span class="n">prop</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
			<span class="n">InputStream</span> <span class="n">inStream</span> <span class="o">=</span> <span class="n">DaoFactory</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">()</span>
					<span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&#34;daoconfig.properties&#34;</span><span class="o">);</span>
			<span class="n">prop</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">inStream</span><span class="o">);</span>
			<span class="c1">//从配置文件中读取UserDao的实现类全类名
</span><span class="c1"></span>			<span class="n">String</span> <span class="n">userDaoClass</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;userDao&#34;</span><span class="o">);</span>
			<span class="n">Class</span> <span class="n">userDaoImplClazz</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">userDaoClass</span><span class="o">);</span>
			<span class="c1">//反射创建对象
</span><span class="c1"></span>			<span class="n">userDao</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserDao</span><span class="o">)</span> <span class="n">userDaoImplClazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="n">ExceptionInInitializerError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="n">DaoFactory</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">daoFactory</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">UserDao</span> <span class="nf">getUserDao</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">userDao</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>daoconfig.properties</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">userDao</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">crudrefactorfinal</span><span class="o">.</span><span class="na">dao</span><span class="o">.</span><span class="na">UserDaoImpl2</span>
</code></pre></div><p>DAOTest</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DAOTest</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">//通过工厂得到DAO实现类，如果想换成UserDaoImpl2，修改配置即可
</span><span class="c1"></span>		<span class="n">UserDao</span> <span class="n">userDao</span> <span class="o">=</span> <span class="n">DaoFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getUserDao</span><span class="o">();</span>
		<span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">selectUsers</span><span class="o">(</span><span class="n">18</span><span class="o">);</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>UserDao</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDao</span> <span class="o">{</span>
	<span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
	<span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
	<span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
	<span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">Id</span><span class="o">);</span>
	<span class="n">User</span> <span class="nf">findUser</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">);</span>
	<span class="c1">//新增查询方法：根据年龄查询
</span><span class="c1"></span>
    <span class="c1">//MyJDBCTemplate中query的返回值设置成List存在局限性。如果用户想映射出Map呢？所以用Object最好
</span><span class="c1"></span>	<span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">selectUsers</span><span class="o">(</span><span class="n">Integer</span> <span class="n">age</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>UserDaoImpl2</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDaoImpl2</span> <span class="kd">implements</span> <span class="n">UserDao</span> <span class="o">{</span>

	<span class="n">MyJDBCTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyJDBCTemplate</span><span class="o">();</span>

	<span class="c1">//增
</span><span class="c1"></span>	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;insert into t_user(name, age, birthday) values (?,?,?) &#34;</span><span class="o">;</span>
		<span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">(),</span>
				<span class="n">user</span><span class="o">.</span><span class="na">getBirthday</span><span class="o">()};</span>
		<span class="c1">//调用jdbcTemplate的update方法
</span><span class="c1"></span>		<span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="c1">//删
</span><span class="c1"></span>	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;update t_user set name=?, age=?, birthday=? where id=? &#34;</span><span class="o">;</span>
		<span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">(),</span>
				<span class="n">user</span><span class="o">.</span><span class="na">getBirthday</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()};</span>
		<span class="c1">//调用jdbcTemplate的update方法
</span><span class="c1"></span>		<span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="c1">//改
</span><span class="c1"></span>	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;delete from t_user where id=?&#34;</span><span class="o">;</span>
		<span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()};</span>
		<span class="c1">//调用jdbcTemplate的update方法
</span><span class="c1"></span>		<span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select id, name, age, birthday from t_user where id=?&#34;</span><span class="o">;</span>
		<span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">id</span><span class="o">};</span>
		<span class="c1">//调用jdbcTemplate的query方法
</span><span class="c1"></span>	<span class="c1">// 	List list = jdbcTemplate.query(sql, args, new RowMapper() {
</span><span class="c1"></span>	<span class="c1">// 		public Object mapRow(ResultSet rs) throws SQLException {
</span><span class="c1"></span>	<span class="c1">// 			User user = new User();
</span><span class="c1"></span>	<span class="c1">// 			user.setId(rs.getInt(&#34;id&#34;));
</span><span class="c1"></span>	<span class="c1">// 			user.setAge(rs.getInt(&#34;age&#34;));
</span><span class="c1"></span>	<span class="c1">// 			user.setName(rs.getString(&#34;name&#34;));
</span><span class="c1"></span>	<span class="c1">// 			user.setBirthday(rs.getDate(&#34;birthday&#34;));
</span><span class="c1"></span>	<span class="c1">// 			return user;
</span><span class="c1"></span>	<span class="c1">// 		}
</span><span class="c1"></span>	<span class="c1">// 	});
</span><span class="c1"></span>	<span class="c1">// 	return (User)list.get(0);
</span><span class="c1"></span>	<span class="c1">// }
</span><span class="c1"></span>    <span class="c1">//调用jdbcTemplate的query方法
</span><span class="c1"></span>        <span class="n">Object</span> <span class="n">query</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="k">new</span> <span class="n">BeanHandler</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span><span class="n">query</span><span class="o">;</span>

	<span class="kd">public</span> <span class="n">User</span> <span class="nf">findUser</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select id, name, age, birthday from t_user where name=? and age=?&#34;</span><span class="o">;</span>
		<span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">name</span><span class="o">,</span> <span class="n">age</span><span class="o">};</span>
		<span class="c1">//调用jdbcTemplate的query方法
</span><span class="c1"></span>	<span class="c1">// 	List list = jdbcTemplate.query(sql, args, new RowMapper() {
</span><span class="c1"></span>	<span class="c1">// 		public Object mapRow(ResultSet rs) throws SQLException {
</span><span class="c1"></span>	<span class="c1">// 			User user = new User();
</span><span class="c1"></span>	<span class="c1">// 			user.setId(rs.getInt(&#34;id&#34;));
</span><span class="c1"></span>	<span class="c1">// 			user.setAge(rs.getInt(&#34;age&#34;));
</span><span class="c1"></span>	<span class="c1">// 			user.setName(rs.getString(&#34;name&#34;));
</span><span class="c1"></span>	<span class="c1">// 			user.setBirthday(rs.getDate(&#34;birthday&#34;));
</span><span class="c1"></span>	<span class="c1">// 			return user;
</span><span class="c1"></span>	<span class="c1">// 		}
</span><span class="c1"></span>	<span class="c1">// 	});
</span><span class="c1"></span>	<span class="c1">// 	return (User)list.get(0);
</span><span class="c1"></span>	<span class="c1">// }
</span><span class="c1"></span>       <span class="n">Object</span> <span class="n">query</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="k">new</span> <span class="n">BeanHandler</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span><span class="n">query</span><span class="o">;</span>


	<span class="kd">public</span> <span class="n">List</span> <span class="nf">selectUsers</span><span class="o">(</span><span class="n">Integer</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select id, name, age, birthday from t_user where age=?&#34;</span><span class="o">;</span>
		<span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">age</span><span class="o">};</span>
        <span class="c1">// new BeanHandler,每次都让用户自己写一个匿名内部类实在太烦了，而且findUser和getUser方法返回值都是User，会重复。返回值类型其实是可以穷举的，比如单个Bean，List&lt;Bean&gt;、Map、List&lt;Map&gt;等。我们预先定义几个映射器供用户使用.
</span><span class="c1"></span>        <span class="n">Object</span> <span class="n">query</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="k">new</span> <span class="n">BeanHandler</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">)</span><span class="n">query</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>RowMapper</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ResultSetHandler</span> <span class="o">{</span>
	<span class="c1">//映射结果集
</span><span class="c1"></span>	<span class="n">Object</span> <span class="nf">handler</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="o">;</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyJDBCTemplate</span> <span class="o">{</span>
	<span class="c1">// 增删改
</span><span class="c1"></span>	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">String</span> <span class="n">sql</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span><span class="na">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
			<span class="c1">// sql由调用者传入
</span><span class="c1"></span>			<span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
			<span class="c1">// 遍历设置模板参数
</span><span class="c1"></span>			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
				<span class="n">ps</span><span class="o">.</span><span class="na">setObject</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">1</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="n">DaoException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">//查询
</span><span class="c1"></span>	<span class="kd">public</span> <span class="n">Object</span> <span class="nf">query</span><span class="o">(</span><span class="n">String</span> <span class="n">sql</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">ResultSetHandler</span> <span class="n">resultSetHandler</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
			<span class="c1">// sql由调用者传入
</span><span class="c1"></span>			<span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
			<span class="c1">// 遍历设置模板参数
</span><span class="c1"></span>			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
				<span class="n">ps</span><span class="o">.</span><span class="na">setObject</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">1</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
			<span class="n">rs</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
			<span class="c1">// 映射规则由子类传入
</span><span class="c1"></span>
            <span class="c1">//MyJDBCTemplate中query的返回值设置成List存在局限性。如果用户想映射出Map呢？所以用Object最好
</span><span class="c1"></span>			<span class="k">return</span> <span class="n">resultSetHandler</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="n">rs</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="n">DaoException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="n">JdbcUtils</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">ps</span><span class="o">,</span> <span class="n">conn</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>


</code></pre></div><h1 id="listener">Listener</h1>
<h1 id="注解">注解</h1>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">注解名称</span><span class="o">{</span>
    <span class="n">属性列表</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">注解名称</span> <span class="kd">extends</span> <span class="n">Annotation</span><span class="o">{</span>
    <span class="n">属性列表</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h1 id="threadlocal">ThreadLocal</h1>
<h2 id="threadlocal其实不存东西threadlocalmap的key也不是thread是threadlocal">ThreadLocal其实不存东西，ThreadLocalMap的key也不是Thread，是ThreadLocal。</h2>
<h2 id="disablecomments-false">title: &ldquo;Spring note&rdquo;
date: 2021-06-12T15:56:39+08:00
Description: &ldquo;learning note of Spring 5&rdquo;
Tags: [
&ldquo;IOC&rdquo;,&ldquo;AoP&rdquo;,&ldquo;JdbcTemplate&rdquo;,&ldquo;事务管理&rdquo;, &ldquo;Spring5 framework&rdquo;
]
Categories: []
DisableComments: false</h2>
<h1 id="spring-jdbc-orm">Spring JDBC ORM</h1>
<p>模板方法，建造者模式</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">st=&gt;start: Start:&gt;http://www.google.com[blank]
e=&gt;end:&gt;http://www.google.com
op1=&gt;operation: My Operation
sub1=&gt;subroutine: My Subroutine
cond=&gt;condition: Yes
or No?:&gt;http://www.google.com
io=&gt;inputoutput: catch something...
para=&gt;parallel: parallel tasks

st-&gt;op1-&gt;cond
cond(yes)-&gt;io-&gt;e
cond(no)-&gt;para
para(path1, bottom)-&gt;sub1(right)-&gt;op1
para(path2, top)-&gt;op1
</code></pre></div><h2 id="本地branch和远程branch挂钩错误">本地branch和远程branch挂钩错误</h2>
<p>PS F:\笔记\Spring\minSpring&gt; git status
On branch InstanStrtg
Your branch is up to date with &lsquo;origin/BeanDefinition-BeanDefinitionRegistry&rsquo;</p>
<h4 id="ok-its-time-for-spring-mvchahahugoshortcode-s55-hbhb">Ok, It&rsquo;s time for <a href="https://rileyshen.github.io/post/springmvc/" >spring mvc</a></h4>
</div>
    <div class="post-footer">
        <div class="info">
            
            <span class="separator"><a class="tag" href="/tags/crud/">CRUD</a><a class="tag" href="/tags/ioc/">IOC</a><a class="tag" href="/tags/aop/">AOP</a><a class="tag" href="/tags/spring5/">Spring5</a></span>
        </div>
    </div>

    
</div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="/js/medium-zoom.min.83cb1dd5fea8d42d87d1e601a07faa73089ad0ef9ccfe5daf6041289ebcc4e46.js"
        integrity="sha256-g8sd1f6o1C2H0eYBoH&#43;qcwia0O&#43;cz&#43;Xa9gQSievMTkY="
        crossorigin="anonymous"></script>
<script async defer src="//latest.js"></script>
<noscript><img src="//noscript.gif" alt=""/></noscript>

</body>

</html>
