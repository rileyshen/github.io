<!DOCTYPE html>
<html  dir="ltr" lang="en" data-theme=""><head>
    <title> Riley Shen | learning System design as a landscape architect 8 </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.83.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description"
        content="
Riley likes to push her limits 
and always keep learning new things. 
She shares her weekly learnings 
because &#34;if you can&#39;t explain it simply,
it means you didn&#39;t understand it well enough&#34;.
">
    <meta name="google-site-verification" content="Nac1UrFTdr1E1F48JLe7XQhIbKn2_WtF4VnJI8KOtew" />
    

    
    
    
    <link rel="stylesheet" href="/css/main.min.a7c9793b97840076bef76d2743ee1c90b13bd21c18674076a0cccd5dd54c723b.css" integrity="sha256-p8l5O5eEAHa&#43;920nQ&#43;4ckLE70hwYZ0B2oMzNXdVMcjs="
        crossorigin="anonymous" type="text/css">
    
    
    <link rel="stylesheet" href="/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css"
        integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS&#43;yuWSR4=" crossorigin="anonymous" type="text/css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
        integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
        crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">

    <link rel="canonical" href="/post/sys8/">

    <link rel="preconnect" href="https://fonts.gstatic.com">



    
    
    
    
    <script type="text/javascript" src="/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js"
        integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin="anonymous"></script>


    
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://rileyshen.github.io/images/site-feature-image.png"/>

<meta name="twitter:title" content="learning System design as a landscape architect 8"/>
<meta name="twitter:description" content="Rethink system design in a much fun way, as a former urban planner/landscape planner."/>


    
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,500;1,600;1,700&display=swap"
        rel="stylesheet">

</head><body><div class="sidebar animated fadeInDown ">
    <div class="logo-title">
        <div class="title">
            <img src="/images/profileS.jpg" alt="profile picture">
            <h3 title=""><a href="/">I&#39;m Riley Shen</a></h3>
            <div class="description">
                <p><br>Riley likes to push her limits <br>and always keep learning new things. <br>She shares her weekly learnings <br>because "if you can't explain it simply,<br>it means you didn't understand it well enough".<br></p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="mailto:ripple.shen31@gmail.com" rel="me" aria-label="e-mail">
                    <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://github.com/rileyshen" rel="me" aria-label="GitHub">
                    <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy;  Riley Shen 2022 </div>
    </div>
</div>
<div class="main">
    <div class="page-top  animated fadeInDown ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Home</a></li>
        
            
            <li><a 
                   href="/post/"
                        
                   title="">Posts</a></li>
        
            
            <li><a 
                   href="/about/"
                        
                   title="">About Me</a></li>
        
            
            <li><a 
                   href="/contact/"
                        
                   title="">Contact</a></li>
        
        
        
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
<div class="post  animated fadeInDown ">
    <div class="post-content">
        
        <div class="post-title">
            <h2>learning System design as a landscape architect 8</h2>
            
            <div class="info">
                <em class="fas fa-calendar-day"></em>
                <span class="date">
                    Tue, Mar 1, 2022
                    </span>
                <em class="fas fa-stopwatch"></em>
                <span class="reading-time">5-minute read</span>
            </div>
            
        </div>

        <p>Rethink system design in a much fun way, as a former urban planner/landscape planner. Take Bigtable as example</p>
<!-- more -->
<!-- TOC -->
<ul>
<li><a href="#bigtable" >Bigtable</a>
<ul>
<li><a href="#scenario-analysis" >Scenario analysis</a></li>
<li><a href="#storage" >Storage</a></li>
<li><a href="#write-process" >Write process</a>
<ul>
<li><a href="#make-the-last-file-from-unordered-to-ordered" >make the last file from unOrdered to Ordered</a></li>
<li><a href="#recover-data-of-different-file-formats-from-crashed-memory" >Recover data of different file formats from crashed memory</a></li>
</ul>
</li>
<li><a href="#read-process" >Read process</a></li>
<li><a href="#query-in-ordered-file" >query in ordered file</a>
<ul>
<li><a href="#one-easy-way-to-build-index" >One easy way to build index</a></li>
<li><a href="#one-better-way-to-read-file" >One better way to read file</a></li>
</ul>
</li>
<li><a href="#compelete-read-process-with-index-bf" >Compelete Read process with Index, BF</a></li>
<li><a href="#complete-write-process" >Complete Write process</a></li>
<li><a href="#sharding" >Sharding</a></li>
<li><a href="#write-a-key" >write a key</a></li>
<li><a href="#save-data-in-gfs" >save data in GFS</a></li>
<li><a href="#distributed-lock" >distributed lock</a>
<ul>
<li><a href="#write-a-key-with-distributed-lock" >write a key with distributed lock</a></li>
<li><a href="#advantage-distribute-lock" >Advantage Distribute Lock</a></li>
</ul>
</li>
<li><a href="#write-with-lock" >Write with lock</a></li>
<li><a href="#read-with-lock" >Read with lock</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<hr>
<h2 id="bigtable">Bigtable</h2>
<p><a id="markdown-bigtable" name="bigtable"></a></p>
<p>NoSQL, how to scale</p>
<p>SQL and Complex Queries Are Needed for Real life, which is base on file system.</p>
<p>DB systems store data as files on the device&rsquo;s local filesystem, provide interface to operate.</p>
<p>Better understand why we need DB system. You open a closet, find the drawer, get the socks you wanna wear today.</p>
<p>In this case, DB system is the drawer, the file is the sock.</p>
<h3 id="scenario-analysis">Scenario analysis</h3>
<p><a id="markdown-scenario-analysis" name="scenario-analysis"></a></p>
<p>search, return</p>
<h3 id="storage">Storage</h3>
<p><a id="markdown-storage" name="storage"></a></p>
<p>how about save all data in memory? Bad idea, in District File System File sizes are always measured in PB.</p>
<p>how about save in Disk (sorting and binary search).</p>
<p>But how to Edit the file which is saved in Disk?</p>
<p>method1 :Edit the file directly. (original is 4 bites, now edit to 8 bytes, then the following need move)</p>
<p>method2: read the file, edit, delete the original one, rewrite the file</p>
<p>method3: without edit, but append a record at the end of a file (fast)</p>
<p>BigTable is method 3, use APPEND to improve write performance.</p>
<p><strong>cons:</strong></p>
<ul>
<li>when reading data, how to recognize the newest record
<ul>
<li>timestamp</li>
</ul>
</li>
<li>how to Binary Search on unsorted data.
<ul>
<li>Block order</li>
</ul>
</li>
<li>repeat blocks affect query performance
<ul>
<li>merge K sorted</li>
</ul>
</li>
</ul>
<h3 id="write-process">Write process</h3>
<p><a id="markdown-write-process" name="write-process"></a></p>
<p>Client 1 &ndash; Write key: Aa + appearance value: 3 &ndash;&gt; Memory (file 0, file 1..) &ndash;Append key: Aa + appearance value: 3 &ndash;&gt; file 1 (unordered)</p>
<p>when the file 1 reach to 256(or  512 bytes) &ndash;merge/sort&ndash;&gt; Order Block &ndash;&gt; open a new unorder block</p>
<h4 id="make-the-last-file-from-unordered-to-ordered">make the last file from unOrdered to Ordered</h4>
<p><a id="markdown-make-the-last-file-from-unordered-to-ordered" name="make-the-last-file-from-unordered-to-ordered"></a></p>
<ul>
<li>
<p>method 1: sort in memory (Write once(disk), read once(disk), sorted in memory, Write once(disk))</p>
</li>
<li>
<p><strong>method 2: saved in memory from beginning ( sorted in memory, Write once(disk))</strong></p>
</li>
</ul>
<blockquote>
<p>Client 1 &ndash; Write key: Aa + appearance value: 3 &ndash;&gt; Memory (file 0, file 1..unOrdered block, when read to full size) &ndash;Append key: Aa + appearance value: 3 &ndash;&gt;Sorted List &ndash;Serialize to disk&ndash;&gt; file 1 (ordered)</p>
</blockquote>
<h4 id="recover-data-of-different-file-formats-from-crashed-memory">Recover data of different file formats from crashed memory</h4>
<p><a id="markdown-recover-data-of-different-file-formats-from-crashed-memory" name="recover-data-of-different-file-formats-from-crashed-memory"></a></p>
<p><strong>Write Ahead Log</strong></p>
<h3 id="read-process">Read process</h3>
<p><a id="markdown-read-process" name="read-process"></a></p>
<blockquote>
<p>Client 1 &ndash; 1. Read key: Aa + appearance &ndash;&gt; Memory &ndash;2. Read key: Aa + appearance &ndash;&gt;Sorted List(Aa + appearance value: 3)</p>
</blockquote>
<p>no result &ndash; Memory &ndash;3. Read key: Aa + appearance &ndash;&gt; <strong>file 1 (ordered)</strong></p>
<h3 id="query-in-ordered-file">query in ordered file</h3>
<p><a id="markdown-query-in-ordered-file" name="query-in-ordered-file"></a></p>
<ul>
<li>Index</li>
<li>BloomFilter</li>
</ul>
<h4 id="one-easy-way-to-build-index">One easy way to build index</h4>
<p><a id="markdown-one-easy-way-to-build-index" name="one-easy-way-to-build-index"></a></p>
<p>Memory Index</p>
<ul>
<li>A: address</li>
<li>D:</li>
<li>S:</li>
</ul>
<p>GFS Sstable 0</p>
<ul>
<li>Apple: 10</li>
<li>Cxxx: 3</li>
<li><strong>Daaaa:8</strong></li>
<li><strong>Xuuu: 19</strong></li>
<li><strong>Sxxx: 9</strong></li>
</ul>
<p>Look up key Xuuu, just need binary search from D to S</p>
<p>In real life, B tree index is good choice.</p>
<h4 id="one-better-way-to-read-file">One better way to read file</h4>
<p><a id="markdown-one-better-way-to-read-file" name="one-better-way-to-read-file"></a></p>
<ul>
<li>BloomFilter
<ul>
<li>use 2 hash keys</li>
</ul>
</li>
</ul>
<h3 id="compelete-read-process-with-index-bf">Compelete Read process with Index, BF</h3>
<p><a id="markdown-compelete-read-process-with-index%2C-bf" name="compelete-read-process-with-index%2C-bf"></a></p>
<p>Memory:</p>
<ul>
<li>file0, Address0</li>
<li>Index0, bloomfilter 0</li>
<li>file1, Address1</li>
<li>Index1, bloomfilter 1</li>
</ul>
<p>Sorted List:</p>
<ul>
<li>xx + appearance: 9</li>
</ul>
<p>Disk:
File 0 Ordered:</p>
<ul>
<li>aa + appearance: 3</li>
<li>bb+ appearance: 8</li>
<li>Index 0</li>
<li>bloomfilter 0</li>
</ul>
<p>Disk:
File 1 Ordered:</p>
<ul>
<li>cc + appearance: 3</li>
<li>dd+ appearance: 8</li>
<li>xx + appearance: 9</li>
<li>Index 1</li>
<li>bloomfilter 1</li>
</ul>
<p>First query in unOrdered file</p>
<blockquote>
<p>Client 1 &ndash; 1. Read key: Aa + appearance &ndash;&gt; <code>Memory</code> &ndash;2. Read key: Aa + appearance &ndash;&gt;<code>Sorted List</code>(Aa + appearance value: 3)</p>
</blockquote>
<p>return result if it exists</p>
<p>if not, query in Order File start from lastest.</p>
<p>use <strong>BloomFilter</strong> to search the key, query the next file if not exists; otherwise use <strong>index</strong> to find the value for the key.</p>
<hr>
<p>SSTable = Sorted String Table</p>
<p>Sorted List = Skip List</p>
<hr>
<h3 id="complete-write-process">Complete Write process</h3>
<p><a id="markdown-complete-write-process" name="complete-write-process"></a></p>
<p>Client 1 &ndash; Write key: Aa + appearance value: 3 &ndash;&gt; <code>Memory</code> (file 0, file 1..) &ndash;Append key: Aa + appearance value: 3 &ndash;&gt; <code>Skip List</code> (unordered) &ndash;&gt; <code>SSTable 1 (Ordered in Disk)</code></p>
<blockquote>
<p>How to read/write key: value from 1PB file</p>
</blockquote>
<h3 id="sharding">Sharding</h3>
<p><a id="markdown-sharding" name="sharding"></a></p>
<ul>
<li>
<p>Horizontal Sharding</p>
<ul>
<li>Consistent Hash(row key: name)</li>
</ul>
</li>
<li>
<p>multiple machine</p>
<ul>
<li>Master has HashMap(key, server address)</li>
<li>Slave</li>
</ul>
</li>
</ul>
<blockquote>
<p>How to read in BigTable with multi-server</p>
</blockquote>
<p>client &ndash; 1. Read key &ndash;&gt; <code>BigTable Master</code> &ndash; 2. Get the row key form key, Use the row key to get server id = 1 &ndash;&gt; client</p>
<p>client &ndash;3. read key &ndash;&gt; <code>Slave Server 1</code> &ndash;4. return value &ndash;&gt; client</p>
<blockquote>
<p>How to write BigTable</p>
</blockquote>
<h3 id="write-a-key">write a key</h3>
<p><a id="markdown-write-a-key" name="write-a-key"></a></p>
<p>client &ndash; 1. Write key &ndash;&gt; <code>BigTable Master</code> &ndash; 2. Get the row key form key, Use the row key to get server id = 1 &ndash;&gt; client</p>
<p>client &ndash;3. Write key, value &ndash;&gt; <code>Slave Server 1</code> &ndash;4. Done &ndash;&gt; client</p>
<p>Memory</p>
<ul>
<li>Write Ahead Log</li>
<li>save the data into memory</li>
</ul>
<p>Disk</p>
<ul>
<li>SkipList &ndash;&gt; full</li>
<li>write to SSTable</li>
</ul>
<blockquote>
<p>Too many data in Slave Server local disk</p>
</blockquote>
<h3 id="save-data-in-gfs">save data in GFS</h3>
<p><a id="markdown-save-data-in-gfs" name="save-data-in-gfs"></a></p>
<p>Table Server = Store Tablet Slave Server</p>
<p>client &ndash;&gt; <code>Tablet Server 1</code> in <code>BigTable</code> &ndash;&gt; GFS</p>
<blockquote>
<p>Read and write the same key at the same time</p>
</blockquote>
<h3 id="distributed-lock">distributed lock</h3>
<p><a id="markdown-distributed-lock" name="distributed-lock"></a></p>
<ul>
<li>Zookeeper</li>
</ul>
<h4 id="write-a-key-with-distributed-lock">write a key with distributed lock</h4>
<p><a id="markdown-write-a-key-with-distributed-lock" name="write-a-key-with-distributed-lock"></a></p>
<p>client 1 &ndash; 1. Write key and lock the key&ndash;&gt; <code>Lock Server</code> &ndash; 2. Get the row key form key &ndash;&gt; client 1 &ndash;3. key value &ndash;&gt;<code>Tablet Server 1</code> &ndash;4. Done&ndash;&gt; client 1</p>
<p>client 1 &ndash; 5. unlock key&ndash;&gt; <code>Lock Server</code></p>
<p>client 2 &ndash; 1. Read key and lock the key&ndash;&gt; <code>Lock Server</code> &ndash; 2. key is locked &ndash;&gt; client 2</p>
<h4 id="advantage-distribute-lock">Advantage Distribute Lock</h4>
<p><a id="markdown-advantage-distribute-lock" name="advantage-distribute-lock"></a></p>
<ul>
<li>the metadata is store on the Lock</li>
<li>master don&rsquo;t need store MetaData</li>
</ul>
<h3 id="write-with-lock">Write with lock</h3>
<p><a id="markdown-write-with-lock" name="write-with-lock"></a></p>
<p><strong>client 1</strong> &ndash;&gt; 1. Write key and lock the key &ndash;&gt;<strong>Lock Server</strong>&ndash; 2. return Server Id&ndash;&gt;<strong>client 1</strong></p>
<p><strong>client 1</strong> &ndash;&gt; 3. key value &ndash;&gt;<strong>Tablet Server 1</strong>&ndash; 4. <code>write log</code> <key value>&ndash;&gt;<strong>Lock Disk</strong> &ndash; 6. write to GFS&ndash;&gt; <strong>GFS</strong></p>
<p><strong>Tablet Server 1</strong>&ndash; 5. <code>write key. value</code>&ndash;&gt;<strong>Memory</strong> &ndash; 6. write to GFS&ndash;&gt; <strong>GFS</strong></p>
<h3 id="read-with-lock">Read with lock</h3>
<p><a id="markdown-read-with-lock" name="read-with-lock"></a></p>
<p><strong>client 1</strong> &ndash;&gt; 1. Read key and lock the key &ndash;&gt;<strong>Lock Server</strong>&ndash; 2. return Server Id&ndash;&gt;<strong>client 1</strong></p>
<p><strong>client 1</strong> &ndash;&gt; 3. Read key &ndash;&gt;<strong>Tablet Server 1</strong>&ndash; 4. Check memory, Bloom Filter, index on each sstable,  &ndash;&gt;<strong>Memory</strong></p>
<p><strong>Tablet Server 1</strong>&ndash; 5. Binary search on sstable to find the value&ndash;&gt;<strong>GFS</strong></p>
<figure><img src="/images/system9.png"
         alt="image"/><figcaption>
            <h4>send coupon</h4>
        </figcaption>
</figure>

</div>
    <div class="post-footer">
        <div class="info">
            
            <span class="separator"><a class="tag" href="/tags/system-design/">System design</a><a class="tag" href="/tags/java/">java</a><a class="tag" href="/tags/interview/">interview</a><a class="tag" href="/tags/sde/">SDE</a><a class="tag" href="/tags/distributed-file-system/">Distributed File System</a><a class="tag" href="/tags/bigtable/">Bigtable</a></span>
        </div>
    </div>

    
</div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="/js/medium-zoom.min.83cb1dd5fea8d42d87d1e601a07faa73089ad0ef9ccfe5daf6041289ebcc4e46.js"
        integrity="sha256-g8sd1f6o1C2H0eYBoH&#43;qcwia0O&#43;cz&#43;Xa9gQSievMTkY="
        crossorigin="anonymous"></script>
<script async defer src="//latest.js"></script>
<noscript><img src="//noscript.gif" alt=""/></noscript>

</body>

</html>
