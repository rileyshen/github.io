<!DOCTYPE html>
<html  dir="ltr" lang="en" data-theme=""><head>
    <title> Riley Shen | spring learning code 3 </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.83.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description"
        content="spring learning code">
    <meta name="google-site-verification" content="Nac1UrFTdr1E1F48JLe7XQhIbKn2_WtF4VnJI8KOtew" />
    

    
    
    
    <link rel="stylesheet" href="/css/main.min.a7c9793b97840076bef76d2743ee1c90b13bd21c18674076a0cccd5dd54c723b.css" integrity="sha256-p8l5O5eEAHa&#43;920nQ&#43;4ckLE70hwYZ0B2oMzNXdVMcjs="
        crossorigin="anonymous" type="text/css">
    
    
    <link rel="stylesheet" href="/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css"
        integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS&#43;yuWSR4=" crossorigin="anonymous" type="text/css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
        integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
        crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">

    <link rel="canonical" href="/post/spring3/">

    <link rel="preconnect" href="https://fonts.gstatic.com">



    
    
    
    
    <script type="text/javascript" src="/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js"
        integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin="anonymous"></script>


    
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://rileyshen.github.io/images/site-feature-image.png"/>

<meta name="twitter:title" content="spring learning code 3"/>
<meta name="twitter:description" content="spring learning code"/>


    
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,500;1,600;1,700&display=swap"
        rel="stylesheet">

</head><body><div class="sidebar animated fadeInDown ">
    <div class="logo-title">
        <div class="title">
            <img src="/images/profileS.jpg" alt="profile picture">
            <h3 title=""><a href="/">I&#39;m Riley Shen</a></h3>
            <div class="description">
                <p><br>Riley likes to push her limits <br>and always keep learning new things. <br>She shares her weekly learnings <br>because "if you can't explain it simply,<br>it means you didn't understand it well enough".<br></p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="mailto:ripple.shen31@gmail.com" rel="me" aria-label="e-mail">
                    <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://github.com/rileyshen" rel="me" aria-label="GitHub">
                    <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy;  Riley Shen 2023 </div>
    </div>
</div>
<div class="main">
    <div class="page-top  animated fadeInDown ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Home</a></li>
        
            
            <li><a 
                   href="/post/"
                        
                   title="">Posts</a></li>
        
            
            <li><a 
                   href="/about/"
                        
                   title="">About Me</a></li>
        
            
            <li><a 
                   href="/contact/"
                        
                   title="">Contact</a></li>
        
        
        
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
<div class="post  animated fadeInDown ">
    <div class="post-content">
        
        <div class="post-title">
            <h2>spring learning code 3</h2>
            
            <div class="info">
                <em class="fas fa-calendar-day"></em>
                <span class="date">
                    Thu, Apr 16, 2020
                    </span>
                <em class="fas fa-stopwatch"></em>
                <span class="reading-time">12-minute read</span>
            </div>
            
        </div>

        <p>This is my learning note about how Spring core features like IoC, AOP works, with Code Examples .</p>
<!-- TOC -->
<ul>
<li><a href="#spring-transactionacid" >spring Transaction（ACID</a>
<ul>
<li><a href="#%E8%BD%AC%E8%B4%A6%E7%8E%AF%E5%A2%83" >转账环境</a>
<ul>
<li><a href="#%E7%BB%8F%E5%85%B8%E5%9C%BA%E6%99%AF-%E9%93%B6%E8%A1%8C%E8%BD%AC%E8%B4%A6" >经典场景： 银行转账</a></li>
<li><a href="#%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98" >&lt;em&gt;&lt;strong&gt;事务解决问题&lt;/strong&gt;&lt;/em&gt;</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C-%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE" >事务操作 （声明式事务管理参数配置）</a></li>
<li><a href="#%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C-%E5%AE%8C%E5%85%A8%E6%B3%A8%E8%A7%A3%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86" >事务操作 （完全注解声明式事务管理）</a></li>
</ul>
</li>
<li><a href="#spring5-%E6%96%B0%E5%8A%9F%E8%83%BD" >spring5 新功能</a>
<ul>
<li><a href="#%E8%87%AA%E5%B8%A6%E9%80%9A%E7%94%A8%E7%9A%84%E6%97%A5%E5%BF%97%E5%B0%81%E8%A3%85" >自带通用的日志封装</a></li>
<li><a href="#junit5" >JUnit5</a></li>
<li><a href="#webflux" >Webflux</a></li>
</ul>
</li>
<li><a href="#spring-v10-dispatcherservlet" >Spring V1.0 DispatcherServlet</a></li>
<li><a href="#spring-ioc-di-mvc-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86" >Spring IoC， DI, MVC 的工作原理</a>
<ul>
<li><a href="#%E9%81%B5%E5%BE%AA%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E5%8E%9F%E5%88%99" >遵循单一职责原则</a></li>
<li><a href="#min-%E7%89%88%E6%9C%AC-spring-%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" >MIN 版本 Spring 基本实现思路</a></li>
<li><a href="#%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%B1%BB%E5%AE%9E%E7%8E%B0%E4%B8%89%E4%B8%AA%E6%96%B9%E6%B3%95" >新建一个类，实现三个方法</a></li>
</ul>
</li>
<li><a href="#spring-i" >Spring I</a></li>
<li><a href="#from-servlet-to-applicatoincontext" >from Servlet to ApplicatoinContext</a>
<ul>
<li><a href="#spring-ioc" >Spring IOC</a></li>
</ul>
</li>
<li><a href="#here-is-a-case" >here is a case</a></li>
</ul>
<!-- /TOC -->
<h2 id="spring-transactionacid">spring Transaction（ACID)</h2>
<p><a id="markdown-spring-transaction%EF%BC%88acid" name="spring-transaction%EF%BC%88acid"></a></p>
<ul>
<li><em><strong>Atomicity 原子性(</strong></em></li>
<li><em><strong>Consistency 一致性</strong></em></li>
<li><em><strong>Isolateion 隔离性</strong></em></li>
<li><em><strong>Durability 持久性</strong></em></li>
</ul>
<h3 id="转账环境">转账环境</h3>
<p><a id="markdown-%E8%BD%AC%E8%B4%A6%E7%8E%AF%E5%A2%83" name="%E8%BD%AC%E8%B4%A6%E7%8E%AF%E5%A2%83"></a></p>
<h4 id="经典场景-银行转账">经典场景： 银行转账</h4>
<p><a id="markdown-%E7%BB%8F%E5%85%B8%E5%9C%BA%E6%99%AF%EF%BC%9A-%E9%93%B6%E8%A1%8C%E8%BD%AC%E8%B4%A6" name="%E7%BB%8F%E5%85%B8%E5%9C%BA%E6%99%AF%EF%BC%9A-%E9%93%B6%E8%A1%8C%E8%BD%AC%E8%B4%A6"></a></p>
<ul>
<li>
<p>lucy 转账 100 给 mary</p>
</li>
<li>
<p>lucy 少 100， mary 多 100</p>
</li>
<li>
<p><em><strong>Dao： 数据库操作，不写业务</strong></em></p>
<ul>
<li>多钱方法</li>
<li>少钱方法</li>
</ul>
</li>
<li>
<p><em><strong>Service： 业务操作</strong></em></p>
<ul>
<li>创建转账方法</li>
<li>调用 dao 两个方法</li>
</ul>
</li>
<li>
<p><em><strong>project step：</strong></em></p>
</li>
<li>
<ol>
<li>创建数据库表， 添加记录</li>
</ol>
</li>
</ul>
<figure><img src="/images/spring41.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>

<ul>
<li>
<ol start="2">
<li>创建 Service， 搭建 dao， 完成对象创建和注入关系</li>
</ol>
<ul>
<li>service 注入 dao， 在 dao 注入 jdbcTemplate， 在 JdbcTemplate 注入 DataSource</li>
</ul>
</li>
</ul>
<p><strong>service</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserDao</span> <span class="n">userDao</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p><strong>UserDaoImpl</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDaoImpl</span> <span class="kd">implements</span> <span class="n">UserDao</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p><strong>bean.xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="c">&lt;!--</span>    <span class="nx">引入外部属性文件</span><span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="nx">context</span><span class="o">:</span><span class="nx">property</span><span class="o">-</span><span class="nx">placeholder</span> <span class="nx">location</span><span class="o">=</span><span class="s2">&#34;jdbc.properties&#34;</span><span class="o">/&gt;</span>


<span class="c">&lt;!--</span><span class="mf">4.1</span> <span class="nx">开启组件扫描</span><span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="nx">context</span><span class="o">:</span><span class="nx">component</span><span class="o">-</span><span class="nx">scan</span> <span class="nx">base</span><span class="o">-</span><span class="kr">package</span><span class="o">=</span><span class="s2">&#34;com.learn&#34;</span><span class="o">/&gt;</span>


    <span class="c">&lt;!--</span><span class="nx">数据库连接池</span><span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="nx">bean</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;dataSource&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;com.alibaba.druid.pool.DruidDataSource&#34;</span> <span class="nx">destroy</span><span class="o">-</span><span class="nx">method</span><span class="o">=</span><span class="s2">&#34;close&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">property</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;url&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;${prop.url}&#34;</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="nx">property</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;username&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;${prop.userName}&#34;</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="nx">property</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;password&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;${prop.password}&#34;</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="nx">property</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;driverClassName&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;${prop.driverClass}&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="err">/bean&gt;</span>


    <span class="c">&lt;!--</span><span class="nx">JdbcTemplate</span> <span class="nx">对象</span><span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="nx">bean</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;jdbcTemplate&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;org.springframework.jdbc.core.JdbcTemplate&#34;</span><span class="o">&gt;</span>

        <span class="c">&lt;!--</span><span class="nx">set方法注入dataSource</span><span class="o">--&gt;</span>
        <span class="o">&lt;</span><span class="nx">property</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;dataSource&#34;</span> <span class="nx">ref</span><span class="o">=</span><span class="s2">&#34;dataSource&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="err">/bean&gt;</span>


<span class="o">&lt;</span><span class="err">/beans&gt;</span>
</code></pre></div><ul>
<li>
<ol start="3">
<li>在 dao 创建两个方法，多钱少钱， 在 service 创建方法 （转账的方法）</li>
</ol>
</li>
<li>
<ol start="4">
<li>发生错误， 比如转账到一半断电，产生 lucy 钱少了， mary 没到账</li>
</ol>
</li>
</ul>
<h4 id="事务解决问题"><em><strong>事务解决问题</strong></em></h4>
<p><a id="markdown-***%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98***" name="***%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98***"></a></p>
<ul>
<li>
<ol>
<li>开启事务： 业务层（javaEE 三层结构）</li>
</ol>
</li>
<li>
<ol start="2">
<li>Sping 进行事务管理操作</li>
</ol>
</li>
<li>2.1 编程式管理： 一般开发中不用</li>
</ul>
<figure><img src="/images/spring42.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>

<ul>
<li>
<p>2.2 声明式事务管理 （开发中使用）</p>
<ul>
<li>注解方式 （开发中）</li>
<li>xml 配置方式</li>
</ul>
</li>
<li>
<p>3.spring 进行声明式事务管理，底层使用 AOP 原理</p>
</li>
<li>
<p>4.spring 事务管理 API</p>
</li>
<li>
<p>4.1 提供一个接口，代表事务管理器，这个接口针对不同的框架提供不同的实体类</p>
</li>
</ul>
<p><strong>PlatformTransactionManager -&gt; DataSourceTransactionManager</strong>
<figure><img src="/images/spring43.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</p>
<figure><img src="/images/spring44.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>

<ul>
<li>
<p>4.2 开启事务注解
<figure><img src="/images/spring45.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</p>
</li>
<li>
<p>5.service 类上面 （获取 service 类里面方法上面） 添加事务注解</p>
</li>
<li>
<p>5.1 @Transactional 可以加到类或者某个方法上面
<figure><img src="/images/spring46.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</p>
</li>
</ul>
<h3 id="事务操作-声明式事务管理参数配置">事务操作 （声明式事务管理参数配置）</h3>
<p><a id="markdown-%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C-%EF%BC%88%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%EF%BC%89" name="%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C-%EF%BC%88%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%EF%BC%89"></a></p>
<ul>
<li>
<ol start="0">
<li>事务方法 ： 对数据库数据进行变化的操作</li>
</ol>
</li>
<li>
<ol>
<li>service 类上面添加注解 @Transactional</li>
</ol>
</li>
<li>
<ol start="2">
<li>propagation ： 事务传播行为：有事务的方法调用没事务的方法，或者反过来 或者两个方法都有事务 就是事务传播行为</li>
</ol>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">propogation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">,</span> <span class="n">isolation</span> <span class="o">=</span> <span class="n">Isolation</span><span class="o">.</span><span class="na">REPEATABLE_READ</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// call update method
</span><span class="c1"></span>    <span class="n">update</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">()</span> <span class="o">{</span>

<span class="o">}</span>
</code></pre></div><ul>
<li>
<ol start="3">
<li>isolation： 事务隔离级别 : 多事务操作直接不会产生影响，不考虑隔离性产生很多问题
解决三个读问题： 脏读，不可重复读，虚读</li>
</ol>
</li>
<li>
<p>3.1 脏读： 一个未提交事务读取到另一个未提交事务的数据</p>
</li>
<li>
<p>3.2 不可重复读： 一个未提交事务读取到另一个提交事务修改数据</p>
</li>
<li>
<p>3.3 虚读： 一个未提交事务读取到另一个提交事务添加数据</p>
</li>
<li>
<p>3.4 <strong>READ UNCOMMITTED</strong>(读未提交) ：无法解决 3 问题</p>
</li>
<li>
<p>3.5 <strong>READ COMMITTED</strong>(读已提交) ：解决 <strong>脏读</strong>问题</p>
</li>
<li>
<p>3.6 <strong>REPEATABLE READ</strong>(可重复度) ：解决 <strong>脏读</strong>  <strong>不可重复读</strong> 问题</p>
</li>
<li>
<p>3.7 <strong>SERIALIZABLE</strong>(串行化) ：解决<strong>脏读</strong>  <strong>不可重复读</strong> <strong>虚读</strong>问题</p>
</li>
<li>
<ol start="4">
<li>timeout： 超时</li>
</ol>
</li>
<li>
<ol start="5">
<li>readOnly ： 是否只读</li>
</ol>
</li>
<li>
<ol start="6">
<li>rollbackFor ： 回滚</li>
</ol>
</li>
<li>
<ol start="7">
<li>norollbackFor</li>
</ol>
</li>
</ul>
<h3 id="事务操作-完全注解声明式事务管理">事务操作 （完全注解声明式事务管理）</h3>
<p><a id="markdown-%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C-%EF%BC%88%E5%AE%8C%E5%85%A8%E6%B3%A8%E8%A7%A3%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%EF%BC%89" name="%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C-%EF%BC%88%E5%AE%8C%E5%85%A8%E6%B3%A8%E8%A7%A3%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%EF%BC%89"></a></p>
<ul>
<li>
<ol>
<li>创建配置类， 使用配置类替代 xml 配置文件
<figure><img src="/images/spring47.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</li>
</ol>
</li>
</ul>
<h2 id="spring5-新功能">spring5 新功能</h2>
<p><a id="markdown-spring5-%E6%96%B0%E5%8A%9F%E8%83%BD" name="spring5-%E6%96%B0%E5%8A%9F%E8%83%BD"></a></p>
<h3 id="自带通用的日志封装">自带通用的日志封装</h3>
<p><a id="markdown-%E8%87%AA%E5%B8%A6%E9%80%9A%E7%94%A8%E7%9A%84%E6%97%A5%E5%BF%97%E5%B0%81%E8%A3%85" name="%E8%87%AA%E5%B8%A6%E9%80%9A%E7%94%A8%E7%9A%84%E6%97%A5%E5%BF%97%E5%B0%81%E8%A3%85"></a></p>
<ul>
<li>
<ol>
<li>整合 Log4j2</li>
</ol>
</li>
<li>
<ol start="2">
<li>引入 jar 包</li>
</ol>
</li>
<li>
<p>2.1 <em><strong>log4j-api</strong></em></p>
</li>
<li>
<p>2.2 <em><strong>log4j-core</strong></em></p>
</li>
<li>
<p>2.3 <em><strong>log4j-slf4j-impl</strong></em></p>
</li>
<li>
<p>2.4 <em><strong>slf4j-api</strong></em></p>
</li>
<li>
<ol start="3">
<li>创建 log4j2.xml 配置
<figure><img src="/images/spring48.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</li>
</ol>
</li>
</ul>
<h3 id="junit5">JUnit5</h3>
<p><a id="markdown-junit5" name="junit5"></a></p>
<ul>
<li>
<ol>
<li>test</li>
</ol>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="s">&#34;classpath:bean1.xml&#34;</span><span class="o">)</span>
<span class="c1">//   ApplicationContext context = new ClassPathXmlApplicationContext(&#34;bean1.xml&#34;);
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JTest4</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><ul>
<li>
<ol start="2">
<li>整合 JUnit5</li>
</ol>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">SpringExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="s">&#34;classpath:bean1.xml&#34;</span><span class="o">)</span>
<span class="c1">//   ApplicationContext context = new ClassPathXmlApplicationContext(&#34;bean1.xml&#34;);
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JTest4</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>



<span class="o">+</span> <span class="n">2</span><span class="o">.</span> <span class="n">JUnit5</span> <span class="n">复合注解</span>

<span class="err">```</span><span class="n">java</span>

<span class="nd">@SpringJunitConfig</span><span class="o">(</span><span class="n">lacation</span><span class="o">=</span><span class="s">&#34;classpath:bean1.xml&#34;</span><span class="o">)</span>
<span class="c1">//   ApplicationContext context = new ClassPathXmlApplicationContext(&#34;bean1.xml&#34;);
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JTest4</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="webflux">Webflux</h3>
<p><a id="markdown-webflux" name="webflux"></a></p>
<figure><img src="/images/spring51.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>

<ul>
<li>
<ol>
<li>响应式编程： Reacter 实现</li>
</ol>
</li>
<li>
<p>1.1 Reacter 两个核心类， Mono 和 Flux， 实现接口 Publisher。 Flux 对象实现发布者，返回 N 个元素； Mono 实现发布者，返回 0 或者 1 个元素</p>
</li>
<li>
<p>1.2 Mono 和 Flux 都是数据流的发布者，都可以发出三种数据信号： <em><strong>元素值</strong></em>， <em><strong>错误信号</strong></em>， <em><strong>完成信号</strong></em>， <em><strong>错误信号</strong></em>， <em><strong>完成信号</strong></em> 都代表终止信号</p>
</li>
<li>
<p>1.3 引入依赖： Reactor-core</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">        <span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">io</span><span class="o">.</span><span class="na">projectreactor</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">reactor</span><span class="o">-</span><span class="n">core</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="n">3</span><span class="o">.</span><span class="na">4</span><span class="o">.</span><span class="na">13</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</code></pre></div><ul>
<li>
<p>1.3 调用 just 或
者其他方法只是声明数据流，数据流并没有发出，只有进行订阅之后才会触发数据流
<figure><img src="/images/spring49.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</p>
</li>
<li>
<p>1.4 操作符： map 元素映射为新元素； flatMap 元素映射为流</p>
</li>
<li>
<ol start="2">
<li>SpringWebflux 执行流程和核心 api
SpringWebflux 基于 Reactor， 默认容器是 Netty， Netty 是高性能 NIO 框架，异步非阻塞的框架</li>
</ol>
</li>
<li>
<p>2.1 Netty
阻塞状态 Socket -》 InputStream -》 read（） -》 Thread</p>
</li>
</ul>
<p>非阻塞 NIO 状态
<figure><img src="/images/spring50.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</p>
<ul>
<li>
<p>2.2 SpringWebflux 核心控制器 DispatchHandler， 实现接口 WebHandler, 负责请求的处理</p>
<ul>
<li><strong>HanddlerMapping : 请求查询处理的方法</strong></li>
<li><strong>HandlerAdapter： 真正负责请求处理</strong></li>
<li><strong>HandlerResultHandler： 响应结果处理</strong></li>
</ul>
</li>
<li>
<p>2.3 函数式编程，两个接口： RouterFunction 和 HandlerFunction</p>
</li>
<li>
<ol start="3">
<li>SpringWebflux (基于注解)</li>
</ol>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">webflux</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="n">2</span><span class="o">.</span><span class="na">4</span><span class="o">.</span><span class="na">1</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</code></pre></div><ul>
<li>3.1 配置启动端口号</li>
</ul>
<blockquote>
<p>resources -&gt; application.properties -&gt; server.port = 8081</p>
</blockquote>
<ul>
<li>3.2 创建包和相关类
<figure><img src="/images/spring52.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>
</li>
</ul>
<figure><img src="/images/spring53.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>

<figure><img src="/images/spring52.png"
         alt="image"/><figcaption>
            <h4>spring Transaction</h4>
        </figcaption>
</figure>

<ul>
<li>
<ol start="4">
<li>SpringWebflux (基于函数)</li>
</ol>
</li>
</ul>
<!-- Optional -->
<!-- ## License -->
<!-- This project is open source and available under the [... License](). -->
<!-- You don't have to include all sections - just the one's relevant to your project -->
<h2 id="spring-v10-dispatcherservlet">Spring V1.0 DispatcherServlet</h2>
<p><a id="markdown-spring-v1.0-dispatcherservlet" name="spring-v1.0-dispatcherservlet"></a></p>
<h2 id="spring-ioc-di-mvc-的工作原理">Spring IoC， DI, MVC 的工作原理</h2>
<p><a id="markdown-spring-ioc%EF%BC%8C-di%2C-mvc-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86" name="spring-ioc%EF%BC%8C-di%2C-mvc-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"></a></p>
<h3 id="遵循单一职责原则">遵循单一职责原则</h3>
<p><a id="markdown-%E9%81%B5%E5%BE%AA%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E5%8E%9F%E5%88%99" name="%E9%81%B5%E5%BE%AA%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E5%8E%9F%E5%88%99"></a></p>
<h3 id="min-版本-spring-基本实现思路">MIN 版本 Spring 基本实现思路</h3>
<p><a id="markdown-min-%E7%89%88%E6%9C%AC-spring-%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" name="min-%E7%89%88%E6%9C%AC-spring-%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"></a></p>
<ol>
<li>配置阶段
<ul>
<li>配置 web.xml |    <em>DispatcherServlet</em></li>
<li>设定 init-param | <em>contextConfigLocation = classpath:application.xml</em></li>
<li>设定 url-pattern | /*</li>
<li>配置 Annotation | <em>@Controller @Service @Autowrited @RequestMapping</em></li>
</ul>
<hr>
</li>
<li>初始化阶段
<ul>
<li>调用init（）方法  | <em>加载配置文件</em></li>
<li>IOC容器初始化 | *Map&lt;String, Object&gt;</li>
<li>扫描相关的类  | scan-package=&ldquo;com.gupaoedu&rdquo;
IOC  + 创建实例化并保存至容器    | <em>通过反射机制将类实例化放入IOC容器中</em>
DI  + 进行DI操作    | <em>扫描IOC容器中的实例，给没有赋值的属性自动赋值</em>
MVC  + 初始化HandlerMapping  | <em>将一个URL和一个Method进行一对一的关联映射Map&lt;String, Method&gt;</em></li>
</ul>
</li>
</ol>
<hr>
<ol start="3">
<li>
<p>运行阶段</p>
<ul>
<li>调用doPost()/doGet() | <em>web容器调用doPost/doGet方法，获得request/response对象</em></li>
<li>匹配HandlerMapping | <em>从request对象中获得用户输入的url，找到对应的Method</em></li>
<li>反射调用method.invoker() | <em>利用反射调用方法并返回结果</em></li>
<li>response.getWrite().write() | <em>将返回结果输出到游览器</em></li>
</ul>
<hr>
</li>
</ol>
<h3 id="新建一个类实现三个方法">新建一个类，实现三个方法</h3>
<p><a id="markdown-%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%B1%BB%EF%BC%8C%E5%AE%9E%E7%8E%B0%E4%B8%89%E4%B8%AA%E6%96%B9%E6%B3%95" name="%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%B1%BB%EF%BC%8C%E5%AE%9E%E7%8E%B0%E4%B8%89%E4%B8%AA%E6%96%B9%E6%B3%95"></a></p>
<details>
<summary> 代码折叠 </summary>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">GPDispatchServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="err">，</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">doPost</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">resp</span><span class="o">);</span>
        <span class="o">}</span>

        
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="err">，</span> <span class="n">IOException</span> <span class="o">{</span>

            <span class="o">&lt;!--</span> <span class="n">6</span><span class="o">.</span><span class="na">根据URL委派给具体的调用的方法</span> <span class="o">--&gt;</span>
            <span class="n">doDispatch</span><span class="o">();</span>
           
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">ServletConfig</span> <span class="n">config</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>
          <span class="o">&lt;!--</span> <span class="n">1</span><span class="o">.</span><span class="na">初始化方法init</span> <span class="o">--&gt;</span>
          <span class="o">&lt;!--</span><span class="n">1</span><span class="o">.</span> <span class="n">加载配置文件</span> <span class="o">--&gt;</span>
          <span class="n">doLoadConfig</span><span class="o">();</span>


          <span class="o">&lt;!--</span> <span class="n">2</span><span class="o">.</span><span class="na">扫描相关的类</span> <span class="o">--&gt;</span>
          <span class="n">doScanner</span><span class="o">();</span>


          <span class="o">&lt;!--</span> <span class="n">Ioc功能</span> <span class="o">--&gt;</span>
          <span class="o">&lt;!--</span> <span class="n">3</span><span class="o">.</span><span class="na">初始化Ioc容器</span><span class="err">，</span><span class="n">将扫描的类进行实例化</span><span class="err">，</span><span class="n">缓存到Ioc容器中</span> <span class="o">--&gt;</span>
          <span class="n">doInstance</span><span class="o">();</span>


         <span class="o">&lt;!--</span> <span class="n">DI功能</span> <span class="o">--&gt;</span>
          <span class="o">&lt;!--</span><span class="n">4</span><span class="o">.</span><span class="na">完成依赖注入</span>  <span class="o">--&gt;</span>
          <span class="n">doAutowired</span><span class="o">();</span>

        <span class="o">&lt;!--</span> <span class="n">MVC功能</span> <span class="o">--&gt;</span>
          <span class="o">&lt;!--</span> <span class="n">5</span><span class="o">.</span><span class="na">初始化HandlerMapping</span> <span class="o">--&gt;</span>
          <span class="n">doInitHandlerMapping</span><span class="o">();</span>
           
           <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printLn</span><span class="o">(</span><span class="s">&#34;GP sTRING Framework is init.&#34;</span><span class="o">)</span>
     
        <span class="o">}</span>
        <span class="c1">//根据contextConfigLocation的classpath找到对应的配置文件
</span><span class="c1"></span>        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doLoadConfig</span><span class="o">(</span><span class="n">String</span> <span class="n">contextConfigLocatoin</span><span class="o">)</span>
            <span class="n">InputString</span> <span class="n">is</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">.</span>
    <span class="o">}</span>
</code></pre></div></details>
<h2 id="spring">Spring</h2>
<p><a id="markdown-spring-i" name="spring-i"></a>I</p>
<p><strong>工厂模式，原型，单例（工厂怎么把对象创建出来，交给用户）</strong></p>
<h2 id="from-servlet-to-applicatoincontext">from Servlet to ApplicatoinContext</h2>
<p><a id="markdown-from-servlet-to-applicatoincontext" name="from-servlet-to-applicatoincontext"></a></p>
<p><img src="https://cdn.jsdelivr.net/gh/gyl-coder/blogImgs/images/spring/ioc-aop/image-20200411114146872.png" alt=""></p>
<h3 id="1-spring-ioc">1. Spring IOC</h3>
<p><a id="markdown-spring-ioc" name="spring-ioc"></a></p>
<p><strong>without IOC</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/gyl-coder/blogImgs/images/spring/ioc-aop/image-20200411115607696.png" alt=""></p>
<p><strong>when we need a new Impl, problem occurs</strong>
<img src="https://cdn.jsdelivr.net/gh/gyl-coder/blogImgs/images/spring/ioc-aop/image-20200411120144353.png" alt=""></p>
<p><strong>use IOC, we save lots of time for adjusting code</strong>
<img src="https://cdn.jsdelivr.net/gh/gyl-coder/blogImgs/images/spring/ioc-aop/image-20200411120751016.png" alt=""></p>
<h2 id="here-is-a-case">here is a case</h2>
<p><a id="markdown-here-is-a-case" name="here-is-a-case"></a></p>
<p>Transfer Funds to Other Bank&rsquo;s Account:  A sent money to B account</p>
<p><strong>without IOC</strong></p>
<p><strong>table</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">name    varcher     255 username
money   int         255 balance
cardNo  varcher     255 bank account
</code></pre></div><p><strong>call flow</strong></p>
<p><code>Transfer page</code>     <em>// page <code>transfer</code> botton, send ajax requirement to TransferServlet</em></p>
<p>⇕  ⇕</p>
<p><code>TransferServlet</code>    //  servlet instance is initialized, invokes its Service layer method： TransferService transferService = newTransferServiceImpl();</p>
<p>⇕  ⇕</p>
<p><code>TransferService</code> // service class create Dao instance as singleton, invokes its Dao layer method： AccountDao accountDao = new JdbcAccountDaoImpl();</p>
<p>⇕  ⇕</p>
<p><code>AccountDao</code>  // Dao provides multiple Impl</p>
<p>↓&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;  ↓ 
<code>JdbcAccountDaoImpl</code>   <code>MybatisAccountDaoImpl</code></p>
<p><strong>core code</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;transerServlet&#34;</span><span class="o">,</span> <span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">&#34;/transferServlet&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
    <span class="c1">// create service instance
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">TransferService</span> <span class="n">transferService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransferServiceImpl</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOE</span> <span class="o">{</span>
        <span class="n">doPost</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">resp</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOE</span> <span class="o">{</span>

        <span class="n">req</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">&#34;UTF-8&#34;</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">fromCardNo</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;fromCardNo&#34;</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">toCardNo</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;toCardNo&#34;</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">moneyStr</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;money&#34;</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">money</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">moneyStr</span><span class="o">);</span>

        <span class="n">Result</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Result</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// invoke service method
</span><span class="c1"></span>            <span class="n">transferService</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="n">fromCardNo</span><span class="o">,</span><span class="n">toCardNo</span><span class="o">,</span><span class="n">money</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;200&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;201&#34;</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">// response
</span><span class="c1"></span>        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&#34;application/json;charset=utf-8&#34;</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">print</span><span class="o">(</span><span class="n">JsonUtils</span><span class="o">.</span><span class="na">object2Json</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TransferService</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">String</span> <span class="n">fromCardNo</span><span class="o">,</span> <span class="n">String</span> <span class="n">toCardNo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServiceImpl</span> <span class="kd">implements</span> <span class="n">TransferService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">AccountDao</span> <span class="n">accountDao</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JdbcAccountDaoImpl</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">String</span> <span class="n">fromCardNo</span><span class="o">,</span> <span class="n">String</span> <span class="n">toCardNo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
            <span class="n">Account</span> <span class="n">from</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">queryAccountByCardNo</span><span class="o">(</span><span class="n">fromCardNo</span><span class="o">);</span>
            <span class="n">Account</span> <span class="n">to</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">queryAccountByCardNo</span><span class="o">(</span><span class="n">toCardNo</span><span class="o">);</span>

            <span class="n">from</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()-</span><span class="n">money</span><span class="o">);</span>
            <span class="n">to</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">to</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()+</span><span class="n">money</span><span class="o">);</span>

            <span class="n">accountDao</span><span class="o">.</span><span class="na">updateAccountByCardNo</span><span class="o">(</span><span class="n">to</span><span class="o">);</span>
            <span class="n">accountDao</span><span class="o">.</span><span class="na">updateAccountByCardNo</span><span class="o">(</span><span class="n">from</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountDao</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * get account by query accountNo
</span><span class="cm">     * @param cardNo
</span><span class="cm">     * @return
</span><span class="cm">     * @throws Exception
</span><span class="cm">     */</span>
    <span class="n">Account</span> <span class="nf">queryAccountByCardNo</span><span class="o">(</span><span class="n">String</span> <span class="n">cardNo</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * up aacount information
</span><span class="cm">     * @param account
</span><span class="cm">     * @return
</span><span class="cm">     * @throws Exception
</span><span class="cm">     */</span>
    <span class="kt">int</span> <span class="nf">updateAccountByCardNo</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcAccountDaoImpl</span> <span class="kd">implements</span> <span class="n">AccountDao</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">queryAccountByCardNo</span><span class="o">(</span><span class="n">String</span> <span class="n">cardNo</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        
        <span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">DruidUtils</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select * from account where cardNo=?&#34;</span><span class="o">;</span>
        <span class="n">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">1</span><span class="o">,</span><span class="n">cardNo</span><span class="o">);</span>
        <span class="n">ResultSet</span> <span class="n">resultSet</span> <span class="o">=</span> <span class="n">preparedStatement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>

        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Account</span><span class="o">();</span>
        <span class="k">while</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setCardNo</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;cardNo&#34;</span><span class="o">));</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;money&#34;</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="n">resultSet</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">updateAccountByCardNo</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        
        <span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">DruidUtils</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;update account set money=? where cardNo=?&#34;</span><span class="o">;</span>
        <span class="n">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">1</span><span class="o">,</span><span class="n">account</span><span class="o">.</span><span class="na">getMoney</span><span class="o">());</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">2</span><span class="o">,</span><span class="n">account</span><span class="o">.</span><span class="na">getCardNo</span><span class="o">());</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">preparedStatement</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>

        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>analysis:</strong></p>
<p><code>Transfer page</code></p>
<p>⇕  ⇕</p>
<p><code>TransferServlet</code>    //  public class TransferServlet extends HttpServlet { TransferService transferService = newTransferServiceImpl(); }</p>
<p>⇕  ⇕</p>
<p>interface: <code>TransferService</code> // public class TransferServiceImpl implements TransferService {
impl: <code>TransferServiceImpl</code>   // private AccountDao accountDao = new JdbcAccountDaoImpl();</p>
<p>⇕  ⇕</p>
<p>interface:<code>AccountDao</code><br>
impl: <code>JdbcAccountDaoImpl</code></p>
<p><strong>P1:in service level New define the references to DAO to the concrete implementations as that will make it tightly coupled, not easy in different implementation scenarios, which will lead to modify service code.</strong></p>
<p><strong>P2:serivice layer miss TransactionStatus. And data error may occur in transferring process, cause serious damage.</strong></p>
<hr>
<p><strong>solution</strong></p>
<p><em><strong>P1: new tight coupled problem</strong></em>
<em><strong>solution &ndash;Using Reflection to instantiate the object in factory pattern</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServiceImpl</span> <span class="kd">implements</span> <span class="n">TransferService</span> <span class="o">{</span>

    <span class="c1">// private AccountDao accountDao = new JdbcAccountDaoImpl();
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">AccountDao</span> <span class="n">accountDao</span><span class="err">；</span>

    <span class="c1">// @Override
</span><span class="c1"></span>    <span class="c1">// public void transfer(String fromCardNo, String toCardNo, int money) throws Exception {
</span><span class="c1"></span>    <span class="c1">//         Account from = accountDao.queryAccountByCardNo(fromCardNo);
</span><span class="c1"></span>    <span class="c1">//         Account to = accountDao.queryAccountByCardNo(toCardNo);
</span><span class="c1"></span>
    <span class="c1">//         from.setMoney(from.getMoney()-money);
</span><span class="c1"></span>    <span class="c1">//         to.setMoney(to.getMoney()+money);
</span><span class="c1"></span>
    <span class="c1">//         accountDao.updateAccountByCardNo(to);
</span><span class="c1"></span>    <span class="c1">//         accountDao.updateAccountByCardNo(from);
</span><span class="c1"></span>    <span class="c1">// }
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAccountDao</span><span class="o">(</span><span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accountDao</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><p>Method injection, allows to inject a dependency right at the point of use
when you have mutiple implementation, Method injection is a good choice</p>
<p><em><strong>before:</strong></em>
<code>TransferServiceImpl</code>
↓
new
↓
<code>JdbcAccountDaoImpl</code></p>
<hr>
<p><em><strong>now:</strong></em>
<code>TransferServiceImpl</code>
↓</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">factory read xml file, 
use reflection to instantiate the object,
defines an interface for creating objects
</code></pre></div><p>↑</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">xml:
com.test.dao.JdbcAccountDaoImpl
com.test.service.TransferServiceImpl
</code></pre></div><hr>
<p><em><strong>code</strong></em></p>
<p><em><strong>define bean.xml file</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">&#34;1.0&#34;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span> <span class="o">?&gt;</span>

<span class="o">&lt;!--</span><span class="n">each</span> <span class="n">bean</span> <span class="n">represent</span> <span class="n">a</span> <span class="n">class</span><span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">beans</span><span class="o">&gt;</span>
    
    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;accountDao&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.dao.impl.JdbcAccountDaoImpl&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;ConnectionUtils&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;connectionUtils&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;transferService&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.service.impl.TransferServiceImpl&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;!--</span><span class="n">set</span><span class="o">+</span> <span class="n">name</span><span class="o">,</span> <span class="n">Method</span> <span class="n">injectione</span> <span class="o">--&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;AccountDao&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;accountDao&#34;</span><span class="o">&gt;&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">beans</span><span class="o">&gt;</span>
</code></pre></div><p><em><strong>define BeanFactory</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/* 
</span><span class="cm">* factory class
</span><span class="cm">* task1: read xml, use reflection to instantiate the object, store in the map
</span><span class="cm">* task2: provide interfaces for creating objects (id)
</span><span class="cm">*/</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanFactory</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span> <span class="c1">// store object
</span><span class="c1"></span>

    <span class="cm">/* 
</span><span class="cm">    * read xml, use reflection to instantiate the object, store in the map
</span><span class="cm">    */</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="c1">// load xml
</span><span class="c1"></span>        <span class="n">InputStream</span> <span class="n">resourceAsStream</span> <span class="o">=</span> <span class="n">BeanFactory</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&#34;beans.xml&#34;</span><span class="o">)</span>
        <span class="c1">// read xml
</span><span class="c1"></span>        <span class="n">SAXReader</span> <span class="n">saxReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SAXReader</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Document</span> <span class="n">document</span> <span class="o">=</span> <span class="n">saxReader</span><span class="o">.</span><span class="na">getRootElement</span><span class="o">();</span>
            <span class="n">Element</span> <span class="n">rootElement</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="na">getRootElement</span><span class="o">();</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Element</span><span class="o">&gt;</span> <span class="n">beanList</span> <span class="o">=</span> <span class="n">rootElement</span><span class="o">.</span><span class="na">selectNodes</span><span class="o">(</span><span class="s">&#34;//bean&#34;</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">beanList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">Element</span> <span class="n">element</span> <span class="o">=</span>  <span class="n">beanList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="c1">// get bean id 和 class property
</span><span class="c1"></span>                <span class="n">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">attributeValue</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">);</span>        <span class="c1">// accountDao
</span><span class="c1"></span>                <span class="n">String</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">attributeValue</span><span class="o">(</span><span class="s">&#34;class&#34;</span><span class="o">);</span>  <span class="c1">// com.test.dao.impl.JdbcAccountDaoImpl
</span><span class="c1"></span>                <span class="c1">// use reflection to instantiate the object
</span><span class="c1"></span>                <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">aClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
                <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">aClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

                <span class="c1">// store in the map
</span><span class="c1"></span>                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">o</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// pass property of the bean into Oject
</span><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Element</span><span class="o">&gt;</span> <span class="n">propertyList</span> <span class="o">=</span> <span class="n">rootElement</span><span class="o">.</span><span class="na">selectNodes</span><span class="o">(</span><span class="s">&#34;//property&#34;</span><span class="o">);</span>
        <span class="c1">// read property, get super element
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">propertyList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">Element</span> <span class="n">element</span> <span class="o">=</span> <span class="n">propertyList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span> <span class="c1">//&lt;property name=&#34;AccountDao&#34; ref=&#34;accountDao&#34;&gt;&lt;/property&gt;
</span><span class="c1"></span>            <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">attributeValue</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">attributeValue</span><span class="o">(</span><span class="s">&#34;ref&#34;</span><span class="o">);</span>

            <span class="c1">// find parent
</span><span class="c1"></span>            <span class="n">Element</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getParent</span><span class="o">();</span>

            <span class="c1">// call parent element reflection
</span><span class="c1"></span>            <span class="n">String</span> <span class="n">parentId</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">attributeValue</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">);</span>
            <span class="n">Object</span> <span class="n">parentObject</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">parentId</span><span class="o">);</span>
            <span class="c1">// search all the methods
</span><span class="c1"></span>            <span class="n">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">parentObject</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethods</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">methods</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">methods</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&#34;set&#34;</span> <span class="o">+</span> <span class="n">name</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// setAccountDao(AccountDao accountDao)
</span><span class="c1"></span>                    <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">parentObject</span><span class="o">,</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ref</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="c1">// put parentObject back into map
</span><span class="c1"></span>            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">parentId</span><span class="o">,</span> <span class="n">parentObject</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">DocumentException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/* 
</span><span class="cm">    * provide interfaces for creating objects (id) 
</span><span class="cm">    * @param id
</span><span class="cm">    * @return
</span><span class="cm">    */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">getBean</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;transerServlet&#34;</span><span class="o">,</span> <span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">&#34;/transferServlet&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
    <span class="c1">// create service instance
</span><span class="c1"></span>    <span class="c1">// private TransferService transferService = new TransferServiceImpl();
</span><span class="c1"></span>
    <span class="c1">// get service object through BeanFactory
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">TransferService</span> <span class="n">transferService</span> <span class="o">=</span> <span class="o">(</span><span class="n">TransferService</span><span class="o">)</span> <span class="n">BeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;transferService&#34;</span><span class="o">);</span>

    
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServiceImpl</span> <span class="kd">implements</span> <span class="n">TransferService</span> <span class="o">{</span>
        <span class="c1">// get Dao object through BeanFactory
</span><span class="c1"></span>        <span class="c1">// private AccountDao accountDao = (AccountDao) BeanFactory.getBean(&#34;accountDao&#34;);
</span><span class="c1"></span>
        <span class="c1">// better way
</span><span class="c1"></span>        <span class="kd">private</span> <span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAccountDao</span><span class="o">(</span><span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accountDao</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="o">}</span>

</code></pre></div><p><em><strong>P2 TransactionStatus</strong></em>
make one wrong transaction</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">accountDao</span><span class="o">.</span><span class="na">updateAccountByCardNo</span><span class="o">(</span><span class="n">to</span><span class="o">);</span>
<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">/</span><span class="n">0</span><span class="o">;</span>
<span class="n">accountDao</span><span class="o">.</span><span class="na">updateAccountByCardNo</span><span class="o">(</span><span class="n">from</span><span class="o">);</span>

</code></pre></div><p>run the application, click transfer button(A sent $100 to B), get an error, however, when checking the database,</p>
<p><strong>B get $100, but A is still have the same amount of money!!!</strong></p>
<p><strong>solution</strong></p>
<ul>
<li>executing multiple UPDATE statement in one connection</li>
<li>put tranaction in service layer</li>
</ul>
<p><em><strong>TransactionStatus code</strong></em>
<em><strong>add ConnectionUtils</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="cm">/**
</span><span class="cm"> * get connection
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionUtils</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Connection</span><span class="o">&gt;</span> <span class="n">threadLocal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;&gt;();</span> <span class="c1">// store current threadlocal
</span><span class="c1"></span>
    <span class="cm">/**
</span><span class="cm">     * connection from thread
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Connection</span> <span class="nf">getCurrentThreadConn</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
       
        <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// get connection
</span><span class="c1"></span>            <span class="n">connection</span> <span class="o">=</span> <span class="n">DruidUtils</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getConnection</span><span class="o">();</span>
            <span class="c1">// put into threadlocal
</span><span class="c1"></span>            <span class="n">threadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">connection</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><em><strong>add TransactionManager</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionManager</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">ConnectionUtils</span> <span class="n">connectionUtils</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setConnectionUtils</span><span class="o">(</span><span class="n">ConnectionUtils</span> <span class="n">connectionUtils</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">connectionUtils</span> <span class="o">=</span> <span class="n">connectionUtils</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// begin transaction
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">beginTransaction</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getCurrentThreadConn</span><span class="o">().</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// commit transaction
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getCurrentThreadConn</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// rollback
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rollback</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getCurrentThreadConn</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><em><strong>add ProxyFactory</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyFactory</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">TransactionManager</span> <span class="n">transactionManager</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTransactionManager</span><span class="o">(</span><span class="n">TransactionManager</span> <span class="n">transactionManager</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">transactionManager</span> <span class="o">=</span> <span class="n">transactionManager</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/* 
</span><span class="cm">    Jdk Dynamic Proxy
</span><span class="cm">    @param obj
</span><span class="cm">    @return proxy object
</span><span class="cm">    */</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getJdkProxy</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// get proxy object
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">(),</span> <span class="k">new</span> <span class="n">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                     <span class="n">transactionManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
                     <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
                    <span class="c1">// 
</span><span class="c1"></span>                    <span class="n">transactionManager</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="c1">// 
</span><span class="c1"></span>                    <span class="n">transactionManager</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                    <span class="c1">// throw e can be caught by servlet
</span><span class="c1"></span>                    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">result</span><span class="o">;</span>

                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="cm">/* 
</span><span class="cm">    * cglib get Dynamic Proxy
</span><span class="cm">    @param obj
</span><span class="cm">    @return proxy object
</span><span class="cm">    */</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getCglibProxy</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// get proxy object
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">Enhancer</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span>  <span class="k">new</span> <span class="n">MethodInterceptor</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">intercept</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">objects</span><span class="o">,</span> <span class="n">MethodProxy</span> <span class="n">methodProxy</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                     <span class="n">transactionManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
                     <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span><span class="n">objects</span><span class="o">);</span>
                    <span class="c1">// 
</span><span class="c1"></span>                    <span class="n">transactionManager</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="c1">// 
</span><span class="c1"></span>                    <span class="n">transactionManager</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                    <span class="c1">// throw e can be caught by servlet
</span><span class="c1"></span>                    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">result</span><span class="o">;</span>

                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><em><strong>modify beans.xml</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">&#34;1.0&#34;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span> <span class="o">?&gt;</span>

<span class="o">&lt;!--</span><span class="n">each</span> <span class="n">bean</span> <span class="n">represent</span> <span class="n">a</span> <span class="n">class</span><span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">beans</span><span class="o">&gt;</span>
    
    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;accountDao&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.dao.impl.JdbcAccountDaoImpl&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;ConnectionUtils&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;connectionUtils&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;transferService&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.service.impl.TransferServiceImpl&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;!--</span><span class="n">set</span><span class="o">+</span> <span class="n">name</span><span class="o">,</span> <span class="n">Method</span> <span class="n">injectione</span> <span class="o">--&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;AccountDao&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;accountDao&#34;</span><span class="o">&gt;&lt;/</span><span class="n">property</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

<span class="o">&lt;!--</span><span class="n">add</span> <span class="n">three</span> <span class="k">new</span> <span class="n">bean</span><span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;connectionUtils&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.utils.ConnectionUtils&#34;</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>

<span class="o">&lt;!--</span><span class="n">transactionManager</span> <span class="n">bean</span><span class="o">--&gt;</span>
 <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;transactionManager&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.utils.TransactionManager&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;ConnectionUtils&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;connectionUtils&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>
 <span class="o">&lt;!--</span><span class="n">ProxyFactory</span><span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;proxyFactory&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;com.test.factory.ProxyFactory&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;TransactionManager&#34;</span> <span class="n">ref</span><span class="o">=</span><span class="s">&#34;transactionManager&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>   
<span class="o">&lt;/</span><span class="n">beans</span><span class="o">&gt;</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcAccountDaoImpl</span> <span class="kd">implements</span> <span class="n">AccountDao</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">ConnectionUtils</span> <span class="n">connectionUtils</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setConnecionUtils</span><span class="o">(</span><span class="n">ConnectionUtils</span> <span class="n">connecionUtils</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">connectionUtils</span> <span class="o">=</span> <span class="n">connectionUtils</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">queryAccountByCardNo</span><span class="o">(</span><span class="n">String</span> <span class="n">cardNo</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        
        <span class="c1">// Connection con = DruidUtils.getInstance().getConnection();
</span><span class="c1"></span>        <span class="c1">// get connection from threadlocal
</span><span class="c1"></span>        <span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getCurrentThreadConn</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select * from account where cardNo=?&#34;</span><span class="o">;</span>
        <span class="n">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">1</span><span class="o">,</span><span class="n">cardNo</span><span class="o">);</span>
        <span class="n">ResultSet</span> <span class="n">resultSet</span> <span class="o">=</span> <span class="n">preparedStatement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>

        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Account</span><span class="o">();</span>
        <span class="k">while</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setCardNo</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;cardNo&#34;</span><span class="o">));</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
            <span class="n">account</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;money&#34;</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="n">resultSet</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">updateAccountByCardNo</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        
        <span class="c1">// Connection con = DruidUtils.getInstance().getConnection();
</span><span class="c1"></span>        <span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getCurrentThreadConn</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;update account set money=? where cardNo=?&#34;</span><span class="o">;</span>
        <span class="n">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">1</span><span class="o">,</span><span class="n">account</span><span class="o">.</span><span class="na">getMoney</span><span class="o">());</span>
        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">2</span><span class="o">,</span><span class="n">account</span><span class="o">.</span><span class="na">getCardNo</span><span class="o">());</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">preparedStatement</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>

        <span class="n">preparedStatement</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="c1">// con.close();
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><em><strong>modify TransferServlet</strong></em></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;transerServlet&#34;</span><span class="o">,</span> <span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">&#34;/transferServlet&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
    <span class="c1">// create service instance
</span><span class="c1"></span>    <span class="c1">// private TransferService transferService = new TransferServiceImpl();
</span><span class="c1"></span>
    <span class="c1">// get service object through BeanFactory
</span><span class="c1"></span>    <span class="c1">// private TransferService transferService = (TransferService) BeanFactory.getBean(&#34;transferService&#34;);
</span><span class="c1"></span>
    <span class="c1">// get proxy object from factory
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">ProxyFactory</span> <span class="n">proxyFactory</span> <span class="o">=</span> <span class="o">(</span><span class="n">ProxyFactory</span><span class="o">)</span> <span class="n">BeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;proxyFactory&#34;</span><span class="o">);</span>
    <span class="kd">private</span> <span class="n">TransferService</span> <span class="n">transferService</span> <span class="o">=</span> <span class="o">(</span><span class="n">TransferService</span><span class="o">)</span> <span class="n">proxyFactory</span><span class="o">.</span><span class="na">getProxy</span><span class="o">(</span><span class="n">BeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;transferService&#34;</span><span class="o">));</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">doPost</span><span class="o">(</span><span class="n">req</span><span class="o">,</span><span class="n">resp</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>

        
        <span class="n">req</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">&#34;UTF-8&#34;</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">fromCardNo</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;fromCardNo&#34;</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">toCardNo</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;toCardNo&#34;</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">moneyStr</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;money&#34;</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">money</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">moneyStr</span><span class="o">);</span>

        <span class="n">Result</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Result</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>

            <span class="c1">// 2. call service method
</span><span class="c1"></span>            <span class="n">transferService</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="n">fromCardNo</span><span class="o">,</span><span class="n">toCardNo</span><span class="o">,</span><span class="n">money</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;200&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;201&#34;</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">// 
</span><span class="c1"></span>        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&#34;application/json;charset=utf-8&#34;</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">print</span><span class="o">(</span><span class="n">JsonUtils</span><span class="o">.</span><span class="na">object2Json</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><em><strong>p2 problem solved</strong></em></p>
<p><em><strong>Q: why use proxy for transferServiceImpl?</strong></em></p>
<p>without proxy, all transtation relate code would be put in the TransferServiceImpl</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferServiceImpl</span> <span class="kd">implements</span> <span class="n">TransferService</span> <span class="o">{</span>

   
    <span class="kd">private</span> <span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">;</span>

   

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAccountDao</span><span class="o">(</span><span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accountDao</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">String</span> <span class="n">fromCardNo</span><span class="o">,</span> <span class="n">String</span> <span class="n">toCardNo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="k">try</span><span class="o">{</span>
            
            <span class="n">TransactionManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">beginTransaction</span><span class="o">();*/</span>

            <span class="n">Account</span> <span class="n">from</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">queryAccountByCardNo</span><span class="o">(</span><span class="n">fromCardNo</span><span class="o">);</span>
            <span class="n">Account</span> <span class="n">to</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">queryAccountByCardNo</span><span class="o">(</span><span class="n">toCardNo</span><span class="o">);</span>

            <span class="n">from</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()-</span><span class="n">money</span><span class="o">);</span>
            <span class="n">to</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">to</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()+</span><span class="n">money</span><span class="o">);</span>

            <span class="n">accountDao</span><span class="o">.</span><span class="na">updateAccountByCardNo</span><span class="o">(</span><span class="n">to</span><span class="o">);</span>
            <span class="c1">// make a error to test
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">1</span><span class="o">/</span><span class="n">0</span><span class="o">;</span>
            <span class="n">accountDao</span><span class="o">.</span><span class="na">updateAccountByCardNo</span><span class="o">(</span><span class="n">from</span><span class="o">);</span>
            
            <span class="n">TransactionManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            
            <span class="n">TransactionManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
            
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>we can see the transaction and Impl have become a tight couple, if there are multiple Impl need transaction method, we need add the same codes on every single method. Using proxy way to realize transaction management is a AOP</p>
<hr>
<h4 id="ok-its-time-for-spring1-hahahugoshortcode-s14-hbhb">Ok, It&rsquo;s time for <a href="https://rileyshen.github.io/post/spring1/" >spring1 </a></h4>
<p><a id="markdown-ok%2C-it's-time-for-spring1" name="ok%2C-it's-time-for-spring1"></a></p>
<h4 id="ok-its-time-for-spring2-hahahugoshortcode-s15-hbhb">Ok, It&rsquo;s time for <a href="https://rileyshen.github.io/post/spring2/" >spring2 </a></h4>
<p><a id="markdown-ok%2C-it's-time-for-spring2" name="ok%2C-it's-time-for-spring2"></a></p>
<h4 id="ok-its-time-for-spring-mvchahahugoshortcode-s16-hbhb">Ok, It&rsquo;s time for <a href="https://rileyshen.github.io/post/springmvc/" >spring mvc</a></h4>
<p><a id="markdown-ok%2C-it's-time-for-spring-mvc" name="ok%2C-it's-time-for-spring-mvc"></a>
<a id="markdown-ok%2C-it's-time-for-spring-mvc" name="ok%2C-it's-time-for-spring-mvc"></a></p></div>
    <div class="post-footer">
        <div class="info">
            
            <span class="separator"><a class="tag" href="/tags/crud/">CRUD</a><a class="tag" href="/tags/ioc/">IOC</a><a class="tag" href="/tags/aop/">AOP</a><a class="tag" href="/tags/spring5/">Spring5</a></span>
        </div>
    </div>

    
</div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="/js/medium-zoom.min.83cb1dd5fea8d42d87d1e601a07faa73089ad0ef9ccfe5daf6041289ebcc4e46.js"
        integrity="sha256-g8sd1f6o1C2H0eYBoH&#43;qcwia0O&#43;cz&#43;Xa9gQSievMTkY="
        crossorigin="anonymous"></script>
<script async defer src="//latest.js"></script>
<noscript><img src="//noscript.gif" alt=""/></noscript>

</body>

</html>
