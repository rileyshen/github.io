<!DOCTYPE html>
<html  dir="ltr" lang="en" data-theme=""><head>
    <title> Riley Shen | DDD in real project 1 </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.83.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description"
        content="
Riley likes to push her limits 
and always keep learning new things. 
She shares her weekly learnings 
because &#34;if you can&#39;t explain it simply,
it means you didn&#39;t understand it well enough&#34;.
">
    <meta name="google-site-verification" content="Nac1UrFTdr1E1F48JLe7XQhIbKn2_WtF4VnJI8KOtew" />
    

    
    
    
    <link rel="stylesheet" href="/css/main.min.a7c9793b97840076bef76d2743ee1c90b13bd21c18674076a0cccd5dd54c723b.css" integrity="sha256-p8l5O5eEAHa&#43;920nQ&#43;4ckLE70hwYZ0B2oMzNXdVMcjs="
        crossorigin="anonymous" type="text/css">
    
    
    <link rel="stylesheet" href="/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css"
        integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS&#43;yuWSR4=" crossorigin="anonymous" type="text/css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
        integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
        crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">

    <link rel="canonical" href="/post/ddd/">

    <link rel="preconnect" href="https://fonts.gstatic.com">



    
    
    
    
    <script type="text/javascript" src="/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js"
        integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin="anonymous"></script>


    
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://rileyshen.github.io/images/site-feature-image.png"/>

<meta name="twitter:title" content="DDD in real project 1"/>
<meta name="twitter:description" content="DDD in real project"/>


    
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,500;1,600;1,700&display=swap"
        rel="stylesheet">

</head><body><div class="sidebar animated fadeInDown ">
    <div class="logo-title">
        <div class="title">
            <img src="/images/profileS.jpg" alt="profile picture">
            <h3 title=""><a href="/">I&#39;m Riley Shen</a></h3>
            <div class="description">
                <p><br>Riley likes to push her limits <br>and always keep learning new things. <br>She shares her weekly learnings <br>because "if you can't explain it simply,<br>it means you didn't understand it well enough".<br></p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="mailto:ripple.shen31@gmail.com" rel="me" aria-label="e-mail">
                    <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://github.com/rileyshen" rel="me" aria-label="GitHub">
                    <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy;  Riley Shen 2023 </div>
    </div>
</div>
<div class="main">
    <div class="page-top  animated fadeInDown ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Home</a></li>
        
            
            <li><a 
                   href="/post/"
                        
                   title="">Posts</a></li>
        
            
            <li><a 
                   href="/about/"
                        
                   title="">About Me</a></li>
        
            
            <li><a 
                   href="/contact/"
                        
                   title="">Contact</a></li>
        
        
        
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
<div class="post  animated fadeInDown ">
    <div class="post-content">
        
        <div class="post-title">
            <h2>DDD in real project 1</h2>
            
            <div class="info">
                <em class="fas fa-calendar-day"></em>
                <span class="date">
                    Wed, Mar 1, 2023
                    </span>
                <em class="fas fa-stopwatch"></em>
                <span class="reading-time">8-minute read</span>
            </div>
            
        </div>

        <p>DDD in real project</p>
<h2 id="understand-ddd">understand DDD</h2>
<p>Data Model in data layer，Domain Model in domain layer, Repository is the one connect6 these two。</p>
<p><code>Adapter(controller scheduler consumer)</code>&mdash;&mdash;&ndash; &gt; <code>VO(View Object)</code> <br>
|
<code>App(service executor)</code> &mdash;&mdash;&mdash;&mdash;-&gt; <code>DTO(Data Transfer Object)</code>
|   |
|   <code>Domain(gateway model ability)</code>&mdash;&mdash;&mdash;&mdash;-&gt; <code>Entiry</code>
|   <code>Infratructure(gateway impl , mapper, config)</code>&mdash;&mdash;&mdash;&mdash;-&gt; <code>DO</code></p>
<ul>
<li>DDD structure</li>
</ul>
<ul>
<li>
<p>xxx-application</p>
</li>
<li>
<p>xxx-common</p>
</li>
<li>
<p>xxx-domain</p>
</li>
<li>
<p>xxx-infrastructure</p>
</li>
<li>
<p>xxx-interfaces</p>
</li>
<li>
<p>xxx-rpc</p>
</li>
</ul>
<h2 id="step1-use-prc-to-test-first">STEP1: use PRC to test first</h2>
<h3 id="rpc">RPC</h3>
<p>Dubbo &ndash; implements Serializable</p>
<p>Create a table first to test CRUD operation.</p>
<h4 id="1-create-a-activity-table">1. Create a activity table</h4>
<blockquote>
<p>CREATE TABLE <code>activity</code></p>
</blockquote>
<h4 id="2-pom-file-configuration">2. POM file configuration</h4>
<ul>
<li>
<p>xxx-application，应用层，引用：domain</p>
</li>
<li>
<p>xxx-common，通用包，引用：无</p>
</li>
<li>
<p>xxx-domain，领域层，引用：infrastructure</p>
</li>
<li>
<p>xxx-infrastructure，基础层，引用：无</p>
</li>
<li>
<p>xxx-interfaces，接口层，引用：application、rpc,</p>
</li>
<li>
<p>xxx-rpc，RPC接口定义层，引用：common</p>
</li>
</ul>
<p>interface的package 是 war， 还需要用 starter-web , 别的都是 jar</p>
<h4 id="3-mybatis">3. Mybatis</h4>
<ul>
<li>
<p>put related dependencie in lottery-interfaces pom.xml</p>
</li>
<li>
<p>yml file</p>
</li>
</ul>
<h4 id="4-dubbo">4. Dubbo</h4>
<ul>
<li>put related dependencie in lottery-interfaces pom.xml</li>
<li>yml file</li>
</ul>
<h4 id="5-define-and-develop-rpc-interface">5. Define and develop RPC interface</h4>
<p><strong>lottery/rpc structure</strong></p>
<ul>
<li>dto
<ul>
<li>ActivityDto implements Serializable
<ul>
<li>mapping to mybatis</li>
</ul>
</li>
</ul>
</li>
<li>req
<ul>
<li>ActivityReq implements Serializable</li>
<li>(use activityId as example): get set</li>
</ul>
</li>
<li>res
<ul>
<li>ActivityRes implements Serializable</li>
<li>Field (Result, ActivityDto) : Result from common package, including String 200 code</li>
</ul>
</li>
<li>IActivityBooth.java
<ul>
<li>interface</li>
<li>method: return ActivityRes; pemerater(ActivityReq req)</li>
</ul>
</li>
<li>ActivityBooth</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="o">+</span> <span class="nd">@Service</span>
<span class="o">+</span> <span class="n">ActivityBooth</span><span class="o">.</span><span class="na">java</span>
    <span class="o">+</span>  <span class="nd">@Resource</span>
    <span class="o">+</span> <span class="kd">private</span> <span class="n">IActivityDao</span> <span class="n">activityDao</span><span class="o">;</span>

    <span class="o">+</span>  <span class="nd">@Override</span>
    <span class="o">+</span> <span class="kd">public</span> <span class="n">ActivityRes</span> <span class="nf">queryActivityById</span><span class="o">(</span><span class="n">ActivityReq</span> <span class="n">req</span><span class="o">)</span> 
    <span class="o">+</span>  <span class="k">return</span> <span class="k">new</span> <span class="n">ActivityRes</span>

 <span class="nd">@Service</span> <span class="n">is</span> <span class="n">comimg</span> <span class="n">from</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">Service</span><span class="o">,</span> <span class="n">it</span> <span class="n">means</span> <span class="k">this</span> <span class="kd">class</span> <span class="nc">would</span> <span class="n">be</span> <span class="n">managed</span> <span class="n">by</span> <span class="n">Dubbo</span>
</code></pre></div><h4 id="6-build-a-test-project-and-call-rpc">6. Build a test project and call RPC</h4>
<h3 id="test-rpc">Test RPC</h3>
<ul>
<li>
<p>install first, the root and rpc module Lifecycle need install first</p>
</li>
<li>
<p>ApiTest</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
 
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ApiTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Reference</span><span class="o">(</span><span class="n">interfaceClass</span> <span class="o">=</span> <span class="n">IActivityBooth</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&#34;dubbo://127.0.0.1:20880&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">IActivityBooth</span> <span class="n">activityBooth</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test_rpc</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">ActivityReq</span> <span class="n">req</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActivityReq</span><span class="o">();</span>
        <span class="n">req</span><span class="o">.</span><span class="na">setActivityId</span><span class="o">(</span><span class="n">100001L</span><span class="o">);</span>
        <span class="n">ActivityRes</span> <span class="n">result</span> <span class="o">=</span> <span class="n">activityBooth</span><span class="o">.</span><span class="na">queryActivityById</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;result：{}&#34;</span><span class="o">,</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div><hr>
<p><a href="https://pic2.zhimg.com/v2-93a7e4f3d3bda78cf8ba33411a5d3e2d_r.jpg"  target="_blank" >DTO DO, Entity</a></p>
<ul>
<li>Data Object, only used to map to the table</li>
<li>Entity, dont need serialize and persistent</li>
<li>DTO, lies in the input and output parameters that adapt to different business scenarios</li>
</ul>
<h2 id="ddd-model-another-structure">DDD model another structure</h2>
<ul>
<li>
<p>lottery-common：公共包</p>
</li>
<li>
<p>lottery-interfaces：接口层，依赖公共包lottery-common</p>
<ul>
<li>功能 ： 处理用户发送的restful请求或者解析用户输入的配置文件，将信息传递给应用层</li>
<li>服务组成 ： 接口服务</li>
</ul>
</li>
<li>
<p>lottery-domain：领域层，不依赖其他任何模块</p>
<ul>
<li>功能 ：操作转换领域中的跨实体或者值对象</li>
<li>服务组成 ： 领域服务 - &ndash;1）封装核心业务逻辑</li>
</ul>
</li>
<li>
<p>lottery-infrastructure：基础设施层，依赖领域层lottery-domain</p>
<ul>
<li>功能 ： 提供资源服务，数据库，缓存邓，降低外部资源对系统业务逻辑的影响，为系统解耦</li>
<li>服务组成 ： 基础服务 &ndash; 仓储服务 &ndash;1）实现方式IOC 2）功能： 领域服务和应用服务通过调用仓储服务，实现持久化数据对象或者直接访问资源</li>
</ul>
</li>
<li>
<p>lottery-application：应用层，向上依赖接口层lottery-interfaces、向下依赖领域层lottery-domain和基础设施层lottery-infrastructure</p>
<ul>
<li>功能 ：1. 应用和用户行为 2. 负责服务的组合编排转发 3.处理业务用例的执行顺序和结果的拼装</li>
<li>服务组成 ： 1. 应用服务 ： 对基础层的缓存，文件等数据直接出操作。2. 领域事件服务 ： 领域事件发布和订阅，通过事务总线和消息队列进行异步数据传输，实现服务直接解耦</li>
</ul>
</li>
<li>
<p>lottery-bootstrap: 启动（打包），只依赖应用层lottery-application（因为应用层会整合掉其他所有的模块包）</p>
</li>
<li>
<p>xxx-application，应用层，引用：domain</p>
</li>
<li>
<p>xxx-common，通用包，引用：无</p>
</li>
<li>
<p>xxx-domain，领域层，引用：infrastructure</p>
</li>
<li>
<p>xxx-infrastructure，基础层，引用：无</p>
</li>
<li>
<p>xxx-interfaces，接口层，引用：application、rpc,</p>
</li>
<li>
<p>xxx-rpc，RPC接口定义层，引用：common</p>
</li>
</ul>
<h2 id="step2-design-database-and-tables">STEP2: design database and tables</h2>
<ol>
<li>
<p>in business level; the lottery system, as a link in the marketing activity platform, takes over the link of the activity playing method, bonus consumption, prize distribution and other systems to help the entire business complete user activity.</p>
</li>
<li>
<p>as a part of strategic design, need consider segregation principle; activities, algorithms, rules, policies, users, orders and other fields.</p>
</li>
<li>
<p>Introduce table design; according to the definition of each module in the domain driver, design the database table, which corresponds to the activity table, lottery policy configuration table, access rule engine table, user lottery ticket record table, and the data structure of these tables Other tables that run, such as: record the number of user participation, etc.</p>
</li>
</ol>
<h3 id="a-lottery-drawing-process">A lottery drawing process</h3>
<ul>
<li>run a customer lottery
<ul>
<li>
<p>query activity bill</p>
<ul>
<li>query activity info  &ndash;&gt; SQL <code>Activity</code></li>
<li>query user take activity account &ndash;&gt; SQL <code>UserTakeActivityCount</code></li>
<li>encapsulation  &ndash;&gt; <code>ActivityBillVO</code></li>
</ul>
</li>
<li>
<p>auth info</p>
<ul>
<li>verify info status</li>
<li>verify info time</li>
<li>verify info product quentity stock</li>
<li>verify users&rsquo;s remaining participation times</li>
</ul>
</li>
<li>
<p>Product Quantity Stock decrease &ndash;&gt; SQL <code>Activity</code></p>
</li>
<li>
<p>record users activity info &ndash;&gt; partition, declarative transaction management</p>
<ul>
<li>
<p>reduce users' participate time</p>
<ul>
<li>user first time participate &ndash;&gt; SQL <code>UserTakeActivityCount</code></li>
<li>user non-first time participate &ndash;&gt; SQL <code>UserTakeActivityCount</code></li>
</ul>
</li>
<li>
<p>insert redeem award info &ndash;&gt; use <code>UUID</code> as the only index, to provent redeem the award repeatly <code>uuid = uid + &quot;_&quot; + acvitityId + &quot;_&quot; + userTakeActivity.getTakeCount() </code> &ndash;&gt; SQL <code>UserTakeActivity</code></p>
</li>
</ul>
</li>
<li>
<p>sql encapsulation &ndash;&gt; strategy id , activity id</p>
</li>
</ul>
</li>
</ul>
<h3 id="lotterysql">lottery.sql</h3>
<h4 id="database-lottery"><strong>database lottery</strong></h4>
<h5 id="tables">tables</h5>
<blockquote>
<p>activity</p>
</blockquote>
<blockquote>
<p>award</p>
</blockquote>
<blockquote>
<p>strategy</p>
</blockquote>
<blockquote>
<p>strategy_detail</p>
</blockquote>
<h4 id="database-lottery_01"><strong>database lottery_01</strong></h4>
<h5 id="tables-1">tables</h5>
<blockquote>
<p>user_take_activity (分库不分表)</p>
</blockquote>
<blockquote>
<p>user_take_activity_count (分库不分表)</p>
</blockquote>
<blockquote>
<p>user_strategy_export_001 (分库分表)</p>
</blockquote>
<blockquote>
<p>user_strategy_export_002</p>
</blockquote>
<p>&hellip;</p>
<h4 id="database-lottery_02"><strong>database lottery_02</strong></h4>
<h5 id="tables-2">tables</h5>
<blockquote>
<p>user_take_activity</p>
</blockquote>
<blockquote>
<p>user_take_activity_count</p>
</blockquote>
<blockquote>
<p>user_strategy_export_001</p>
</blockquote>
<blockquote>
<p>user_strategy_export_002</p>
</blockquote>
<p>&hellip;</p>
<hr>
<p>database and tables design thinking:</p>
<ol>
<li>
<p>Access frequency: For frequently accessed data, Data size: For a large amount of data, Data type, different types of data, Data range, it can be stored in a separate database or table to improve read and write performance.</p>
</li>
<li>
<p>The main purpose of partition is: data sharing, improving QPS/TPS, sharing pressure, and improving scalability.</p>
</li>
</ol>
<p>For example, if the read and write performance of the database is degraded, or the amount of data in a single table is too large, then you need to consider partition.</p>
<p>avoiding the performance bottleneck of a single database and improving the performance and scalability of the system.  can also solve the limitation of database storage capacity and improve the storage capacity of the database.</p>
<h2 id="in-addition-the-cost-of-database-management-and-maintenance-will-also-increase-therefore-when-considering-partition-you-need-to-carefully-weigh-the-pros-and-cons-to-determine-whether-it-is-really-necessary-to-perform-partition-operations">In addition, the cost of database management and maintenance will also increase. Therefore, when considering partition, you need to carefully weigh the pros and cons to determine whether it is really necessary to perform partition operations</h2>
<h2 id="step3-lottery-strategy-module">STEP3: lottery strategy module</h2>
<hr>
<p>主要是奖品的发放流程</p>
<ul>
<li>award
<ul>
<li>model
<ul>
<li>req
<ul>
<li>GoodsReq</li>
<li>奖品发货信息</li>
<li>award id，  award name, award content, orderId, user id, shippingaddress, String extInfo</li>
</ul>
</li>
<li>res
<ul>
<li>DistributionRes</li>
<li>商品配送结果</li>
<li>user id, 编码, 描述, 结算单ID</li>
</ul>
</li>
<li>vo
<ul>
<li>ShippingAddress</li>
</ul>
</li>
</ul>
</li>
<li>repository
<ul>
<li>impl</li>
<li>IAwardRepository</li>
<li>对分库分表中的用户中奖纪录操作
<ul>
<li>AwardRepository</li>
</ul>
</li>
</ul>
</li>
<li>service
<ul>
<li>
<p>factory</p>
<ul>
<li>
<p>factory</p>
<ul>
<li>GoodsConfig
<ul>
<li>各类发奖奖品配置类</li>
<li>为了工厂发配做准备， 所以这个类要放入3个分配方法</li>
<li>@Resource</li>
<li>private DescGoods descGoods</li>
<li>&hellip;</li>
<li>把几个分配方式放入map里面调用</li>
<li>Map&lt;Integer, IDistributionGoods&gt; goodsMap = new ConcurrentHashMap&lt;&gt;()</li>
<li>goodsMap.put(Constants.AwardType.DESC.getCode(), descGoods);</li>
</ul>
</li>
<li>DistributionGoodsFactory
<ul>
<li>IDistributionGoods getDistributionGoodsService(Integer awardType)</li>
<li>return goodsMap.get(awardType)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>goods</p>
<ul>
<li>impl
<ul>
<li>CouponGoods
<ul>
<li>// 更新用户领奖结果</li>
<li>getDistributionGoodsName()
<ul>
<li>return Constants.AwardType.PhysicalGoods.getCode()</li>
<li>return Constants.AwardType.RedeemCodeGoods.getCode()</li>
</ul>
</li>
</ul>
</li>
<li>DesGoods</li>
<li>PhysicalGoods</li>
<li>RedeemGoods</li>
</ul>
</li>
<li>IDistributionGoods
<ul>
<li>DistributionRes doDistribution(GoodsReq req)</li>
<li>getDistributionGoodsName();</li>
</ul>
</li>
<li>DistributionBase
<ul>
<li>更新分库分表中，用户个人的抽奖记录表中奖品发奖状态</li>
<li>void updateUserAwardState(String uId, String orderId, String awardId, Integer awardState, String awardStateInfo)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="step4-modify-ddd">STEP4: modify DDD</h2>
<ul>
<li>
<p>domain</p>
<ul>
<li>activity
<ul>
<li>model</li>
<li>repository</li>
<li>service</li>
</ul>
</li>
<li>award
<ul>
<li>model</li>
<li>repository
<ul>
<li>IAwardRepository</li>
</ul>
</li>
<li>service</li>
</ul>
</li>
<li>strategy
<ul>
<li>model</li>
<li>repository
<ul>
<li>IStrategyRepository</li>
</ul>
</li>
<li>service</li>
</ul>
</li>
</ul>
</li>
<li>
<p>infrastruture</p>
<ul>
<li>
<p>dao</p>
<ul>
<li>IStrategyDao.java</li>
<li>IStrategyDetail.java</li>
<li>IAwardDao.java</li>
</ul>
</li>
<li>
<p>po</p>
<ul>
<li>Award.java</li>
<li>StrategyDetail.java</li>
<li>Strategy.java</li>
</ul>
</li>
<li>
<p>repository</p>
<ul>
<li>AwardRepository</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">cn.itedus.lottery.domain.award.repository.IAwardRepository</span><span class="o">;</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AwardRepository</span> <span class="kd">implements</span> <span class="n">IAwardRepository</span> <span class="o">{</span>

<span class="o">}</span>
</code></pre></div><ul>
<li>StrategyRepository</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StrategyRepository</span> <span class="kd">implements</span> <span class="n">IStrategyRepository</span> <span class="o">{</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h2 id="step5-activity">STEP5: activity</h2>
<p>the domain layer domain defines the storage interface, and the base layer infrastructure implements the respository interface.</p>
<p>The functions that the activity domain layer needs to provide include: activity creation, activity status processing, and user claim activity operation.</p>
<p>The operation of event creation mainly uses transactions, because when the event system provides the operation background to create an event, it needs to include: event information, prize information, policy information, policy details, and other additional extended content, all of which need to be under one transaction Carry out storage.</p>
<p>Review of activity status, [1 Edit, 2 Review, 3 Cancel review, 4 Pass, 5 Run (worker scan status after review passed), 6 Reject, 7 Close, 8 Open], here we will use the state in the design mode mode is processed.</p>
<ul>
<li>domain
<ul>
<li>
<p>activity</p>
<ul>
<li>
<p>repository</p>
<ul>
<li>IActivityRepository</li>
</ul>
</li>
<li>
<p>service</p>
<ul>
<li>deploy
<ul>
<li>
<p>impl</p>
<ul>
<li>ActivityDeployImpl</li>
</ul>
<p>// 这个类需要引入.activity.model 中vo， aggregates的类</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActivityDeployImpl</span> <span class="kd">implements</span> <span class="n">IActivityDeploy</span> <span class="o">{</span>

<span class="nd">@Resource</span>
<span class="kd">private</span> <span class="n">IActivityRepository</span> <span class="n">activityRepository</span><span class="o">;</span>

<span class="nd">@Transactional</span><span class="o">(</span><span class="n">rollbackFor</span> <span class="o">=</span> <span class="n">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">createActivity</span><span class="o">(</span><span class="n">ActivityConfigReq</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>

<span class="o">}</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateActivity</span><span class="o">(</span><span class="n">ActivityConfigReq</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// TODD
</span><span class="c1"></span><span class="o">}</span>
<span class="o">}</span>
</code></pre></div></li>
<li>
<p>IActivityDeploy</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IActivityDeploy</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">createActivity</span><span class="o">(</span><span class="n">ActivityConfigReq</span> <span class="n">req</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">updateActivity</span><span class="o">(</span><span class="n">ActivityConfigReq</span> <span class="n">req</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></li>
<li>partake</li>
<li>stateflow</li>
</ul>
</li>
<li>
<p>model</p>
<ul>
<li>vo
<ul>
<li>ActivityVO
<ul>
<li>private Integer state</li>
</ul>
</li>
<li>AlterStateVO
<ul>
<li>/** 活动ID */</li>
<li>private Long activityId;</li>
<li>/** 更新前状态 */</li>
<li>private Integer beforeState;</li>
<li>/** 更新后状态 */</li>
<li>private Integer afterState;</li>
</ul>
</li>
<li>AwardVO</li>
<li>StrategyDetailVO</li>
<li>StrategyVO</li>
</ul>
</li>
<li>aggregates
<ul>
<li>ActivityConfigRich</li>
<li>import model.vo.ActivityVO</li>
<li>import model.vo.AwardVO;</li>
<li>import model.vo.StrategyVO;</li>
<li>construction (ActivityVO activity, StrategyVO strategy, List<AwardVO> awardList)</li>
</ul>
</li>
<li>req
<ul>
<li>ActivityConfigReq
<ul>
<li>Long activityId</li>
<li>ActivityConfigRich ctivityConfigRich</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>ActivityDeployImpl</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActivityDeployImpl</span> <span class="kd">implements</span> <span class="n">IActivityDeploy</span> <span class="o">{</span>

<span class="nd">@Resource</span>
<span class="kd">private</span> <span class="n">IActivityRepository</span> <span class="n">activityRepository</span><span class="o">;</span>

<span class="nd">@Transactional</span><span class="o">(</span><span class="n">rollbackFor</span> <span class="o">=</span> <span class="n">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">createActivity</span><span class="o">(</span><span class="n">ActivityConfigReq</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ActivityConfigRich</span> <span class="n">activityConfigRich</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getActivityConfigRich</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 添加活动配置
</span><span class="c1"></span>        <span class="n">ActivityVO</span> <span class="n">activity</span> <span class="o">=</span> <span class="n">activityConfigRich</span><span class="o">.</span><span class="na">getActivity</span><span class="o">();</span>
        <span class="n">activityRepository</span><span class="o">.</span><span class="na">addActivity</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>

        <span class="c1">// 添加奖品配置
</span><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">AwardVO</span><span class="o">&gt;</span> <span class="n">awardList</span> <span class="o">=</span> <span class="n">activityConfigRich</span><span class="o">.</span><span class="na">getAwardList</span><span class="o">();</span>
        <span class="n">activityRepository</span><span class="o">.</span><span class="na">addAward</span><span class="o">(</span><span class="n">awardList</span><span class="o">);</span>

        <span class="c1">// 添加策略配置
</span><span class="c1"></span>        <span class="c1">// 添加策略详细配置
</span><span class="c1"></span>    <span class="o">}</span>
<span class="o">}</span>

<span class="o">}</span>
</code></pre></div><h3 id="-stateflow逻辑解释">+ stateflow逻辑解释</h3>
<p>arraignment, checkPass, checkRefuse, checkRevoke, close, open, doing</p>
<ul>
<li>stateflow
<ul>
<li>IStateHandler : provide outer service</li>
<li>AbstractState</li>
</ul>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractState</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">protected</span> <span class="n">IActivityRepository</span> <span class="n">activityRepository</span><span class="o">;</span>

    <span class="c1">//活动提审
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Result</span> <span class="nf">arraignment</span><span class="o">(</span><span class="n">Long</span> <span class="n">activityId</span><span class="o">,</span> <span class="n">Enum</span><span class="o">&lt;</span><span class="n">Constants</span><span class="o">.</span><span class="na">ActivityState</span><span class="o">&gt;</span> <span class="n">currentState</span><span class="o">);</span>

    <span class="c1">//审核通过
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Result</span> <span class="nf">checkPass</span><span class="o">(</span><span class="n">Long</span> <span class="n">activityId</span><span class="o">,</span> <span class="n">Enum</span><span class="o">&lt;</span><span class="n">Constants</span><span class="o">.</span><span class="na">ActivityState</span><span class="o">&gt;</span> <span class="n">currentState</span><span class="o">);</span>

    <span class="c1">// 审核拒绝
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Result</span> <span class="nf">checkRefuse</span><span class="o">(</span><span class="n">Long</span> <span class="n">activityId</span><span class="o">,</span> <span class="n">Enum</span><span class="o">&lt;</span><span class="n">Constants</span><span class="o">.</span><span class="na">ActivityState</span><span class="o">&gt;</span> <span class="n">currentState</span><span class="o">);</span>

    
    <span class="c1">// 撤审撤销
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Result</span> <span class="nf">checkRevoke</span><span class="o">(</span><span class="n">Long</span> <span class="n">activityId</span><span class="o">,</span> <span class="n">Enum</span><span class="o">&lt;</span><span class="n">Constants</span><span class="o">.</span><span class="na">ActivityState</span><span class="o">&gt;</span> <span class="n">currentState</span><span class="o">);</span>

    <span class="c1">// 活动关闭
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Result</span> <span class="nf">close</span><span class="o">(</span><span class="n">Long</span> <span class="n">activityId</span><span class="o">,</span> <span class="n">Enum</span><span class="o">&lt;</span><span class="n">Constants</span><span class="o">.</span><span class="na">ActivityState</span><span class="o">&gt;</span> <span class="n">currentState</span><span class="o">);</span>

    
    <span class="c1">// 活动开启
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Result</span> <span class="nf">open</span><span class="o">(</span><span class="n">Long</span> <span class="n">activityId</span><span class="o">,</span> <span class="n">Enum</span><span class="o">&lt;</span><span class="n">Constants</span><span class="o">.</span><span class="na">ActivityState</span><span class="o">&gt;</span> <span class="n">currentState</span><span class="o">);</span>


    <span class="c1">// 活动执行
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Result</span> <span class="nf">doing</span><span class="o">(</span><span class="n">Long</span> <span class="n">activityId</span><span class="o">,</span> <span class="n">Enum</span><span class="o">&lt;</span><span class="n">Constants</span><span class="o">.</span><span class="na">ActivityState</span><span class="o">&gt;</span> <span class="n">currentState</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>状态接口，因为比如拒绝了后后面的状态不同，所以就需要有不同的状态的类</p>
<ul>
<li>stateflow
<ul>
<li>IStateHandler : provide outer service</li>
<li>AbstractState</li>
<li>event
<ul>
<li>CloseState extend AbstractState</li>
<li>7个状态</li>
<li>优化掉原本需要在各个流程节点中的转换使用 ifelse 的场景，这样操作以后也可以更加方便你进行扩展。当然其实这里还可以使用如工作流的方式进行处理</li>
</ul>
</li>
<li>StateConfig : 把状态放入map里面，状态流转配置抽象类</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Resource</span>
<span class="kd">private</span> <span class="n">ArraignmentState</span> <span class="n">arraignmentState</span><span class="o">;</span>

<span class="o">....</span>
<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Enum</span><span class="o">&lt;</span><span class="n">Constants</span><span class="o">.</span><span class="na">ActivityState</span><span class="o">&gt;,</span> <span class="n">AbstractState</span><span class="o">&gt;</span> <span class="n">stateGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

<span class="n">PostConstruct</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">stateGroup</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">ActivityState</span><span class="o">.</span><span class="na">ARRAIGNMENT</span><span class="o">,</span> <span class="n">arraignmentState</span><span class="o">);</span>
    <span class="n">stateGroup</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">ActivityState</span><span class="o">.</span><span class="na">CLOSE</span><span class="o">,</span> <span class="n">closeState</span><span class="o">);</span>

</code></pre></div><ul>
<li>impl
<ul>
<li>StateHandlerImpl extends StateConfig implements IStateHandler</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">Result</span> <span class="nf">arraignment</span><span class="o">(</span><span class="n">Long</span> <span class="n">activityId</span><span class="o">,</span> <span class="n">Enum</span><span class="o">&lt;</span><span class="n">Constants</span><span class="o">.</span><span class="na">ActivityState</span><span class="o">&gt;</span> <span class="n">currentStatus</span><span class="o">)</span> <span class="o">{</span>
<span class="k">return</span> <span class="n">stateGroup</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">currentStatus</span><span class="o">).</span><span class="na">arraignment</span><span class="o">(</span><span class="n">activityId</span><span class="o">,</span> <span class="n">currentStatus</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="activity-test">activity test</h3>
<p>用一个 init() 方法里面，new 一个 ActivityVO activity,. StrategyVO , StrategyDetailVO strategyDetail_01 ,  StrategyDetailVO strategyDetail_02 设置好相关信息</p>
<p>用test_createActivity()， activityDeploy.createActivity(new ActivityConfigReq(activityId, activityConfigRich));</p>
<h3 id="模板抽奖流程">模板抽奖流程</h3>
<figure><img src="/images/ddd1.png"
         alt="image"/><figcaption>
            <h4>通用业务结构</h4>
        </figcaption>
</figure>

<h2 id="step6-id-generate">STEP6: ID generate</h2>
<ul>
<li>ID generate
<ul>
<li>distribution
<ul>
<li>snowflake
<ul>
<li>pros
<ul>
<li>Long type, eary to ooperate,It is 64-bit long, it is half the size of UUIDs</li>
</ul>
<ul>
<li></li>
</ul>
</li>
<li>cons</li>
</ul>
</li>
<li>Redis ID
<ul>
<li>pros
<ul>
<li>not rely on database</li>
<li>sorted id</li>
</ul>
</li>
<li>cons
<ul>
<li>need Redis</li>
<li>In order to generate a unique id, it is troublesome to maintain a Redis cluster</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>nonDistribution
<ul>
<li>UUID
<ul>
<li>pros
<ul>
<li>easy</li>
<li>Unique across every table, every database, every server.</li>
<li>Allows easy merging of records from different databases.</li>
<li>Allows easy distribution of databases across multiple servers</li>
</ul>
</li>
<li>cons
<ul>
<li>non-sequential</li>
<li>stored as string, can have bad query performance</li>
<li>a bit more storage needed</li>
<li>unreadable</li>
</ul>
</li>
</ul>
</li>
<li>Sequential ID
<ul>
<li>
<p>pros</p>
<ul>
<li>easy</li>
<li>Predictable</li>
</ul>
</li>
<li>
<p>cons</p>
<ul>
<li>primary keys are very often exposed to the user</li>
<li>Different database migrations</li>
<li>only generated by master server has the risk of a single point of failure</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul></div>
    <div class="post-footer">
        <div class="info">
            
            <span class="separator"><a class="tag" href="/tags/java/">java</a><a class="tag" href="/tags/ddd/">DDD</a><a class="tag" href="/tags/project/">project</a></span>
        </div>
    </div>

    
</div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="/js/medium-zoom.min.83cb1dd5fea8d42d87d1e601a07faa73089ad0ef9ccfe5daf6041289ebcc4e46.js"
        integrity="sha256-g8sd1f6o1C2H0eYBoH&#43;qcwia0O&#43;cz&#43;Xa9gQSievMTkY="
        crossorigin="anonymous"></script>
<script async defer src="//latest.js"></script>
<noscript><img src="//noscript.gif" alt=""/></noscript>

</body>

</html>
