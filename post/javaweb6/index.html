<!DOCTYPE html>
<html  dir="ltr" lang="en" data-theme=""><head>
    <title> Riley Shen | java web project--learning through building 6 </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.83.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description"
        content="a full-stack web application for users to understand java web system">
    <meta name="google-site-verification" content="Nac1UrFTdr1E1F48JLe7XQhIbKn2_WtF4VnJI8KOtew" />
    

    
    
    
    <link rel="stylesheet" href="/css/main.min.a7c9793b97840076bef76d2743ee1c90b13bd21c18674076a0cccd5dd54c723b.css" integrity="sha256-p8l5O5eEAHa&#43;920nQ&#43;4ckLE70hwYZ0B2oMzNXdVMcjs="
        crossorigin="anonymous" type="text/css">
    
    
    <link rel="stylesheet" href="/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css"
        integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS&#43;yuWSR4=" crossorigin="anonymous" type="text/css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
        integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
        crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">

    <link rel="canonical" href="/post/javaweb6/">

    <link rel="preconnect" href="https://fonts.gstatic.com">



    
    
    
    
    <script type="text/javascript" src="/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js"
        integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin="anonymous"></script>


    
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://rileyshen.github.io/images/site-feature-image.png"/>

<meta name="twitter:title" content="java web project--learning through building 6"/>
<meta name="twitter:description" content="a full-stack web application for users to understand java web system"/>


    
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,500;1,600;1,700&display=swap"
        rel="stylesheet">

</head><body><div class="sidebar animated fadeInDown ">
    <div class="logo-title">
        <div class="title">
            <img src="/images/profileS.jpg" alt="profile picture">
            <h3 title=""><a href="/">I&#39;m Riley Shen</a></h3>
            <div class="description">
                <p><br>Riley likes to push her limits <br>and always keep learning new things. <br>She shares her weekly learnings <br>because "if you can't explain it simply,<br>it means you didn't understand it well enough".<br></p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="mailto:ripple.shen31@gmail.com" rel="me" aria-label="e-mail">
                    <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://github.com/rileyshen" rel="me" aria-label="GitHub">
                    <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy;  Riley Shen 2022 </div>
    </div>
</div>
<div class="main">
    <div class="page-top  animated fadeInDown ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Home</a></li>
        
            
            <li><a 
                   href="/post/"
                        
                   title="">Posts</a></li>
        
            
            <li><a 
                   href="/about/"
                        
                   title="">About Me</a></li>
        
            
            <li><a 
                   href="/contact/"
                        
                   title="">Contact</a></li>
        
        
        
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
<div class="post  animated fadeInDown ">
    <div class="post-content">
        
        <div class="post-title">
            <h2>java web project--learning through building 6</h2>
            
            <div class="info">
                <em class="fas fa-calendar-day"></em>
                <span class="date">
                    Tue, Jan 12, 2021
                    </span>
                <em class="fas fa-stopwatch"></em>
                <span class="reading-time">5-minute read</span>
            </div>
            
        </div>

        <p>a full-stack web application for users to understand java web system</p>
<!-- TOC -->
<ul>
<li><a href="#htmlcss" >HTML/CSS</a>
<ul>
<li><a href="#%E8%B6%85%E9%93%BE%E6%8E%A5" >超链接</a></li>
</ul>
</li>
<li><a href="#form-tag" >form tag</a>
<ul>
<li><a href="#t1-design-a-form-with-head-3-rows-3-cols-with-frame" >&lt;em&gt;&lt;strong&gt;t1: design a form with head, 3 rows 3 cols with frame&lt;/strong&gt;&lt;/em&gt;</a></li>
<li><a href="#t2-modify-the-form-width-heightformat-align-cellspacing" >&lt;em&gt;&lt;strong&gt;t2: modify the form width, height，format align, cellspacing&lt;/strong&gt;&lt;/em&gt;</a></li>
<li><a href="#5-row-5-col-the-first-row-and-col-a-cell-can-span-2-cols" >&lt;em&gt;&lt;strong&gt;5 row 5 col, the first row and col A cell can span 2 cols&lt;/strong&gt;&lt;/em&gt;</a></li>
<li><a href="#the-second-row-first-col-cell-spans-2-row-the-forth-row-and-forth-col-cell-spans-two-rows-and-2-cols" >&lt;em&gt;&lt;strong&gt;the second row first col cell spans 2 row, the forth row and forth col cell spans two rows and 2 cols&lt;/strong&gt;&lt;/em&gt;</a></li>
</ul>
</li>
<li><a href="#form" >form</a>
<ul>
<li><a href="#t1-create-a--register-form-inlucing-the-username-password-gender-hobbiesmultiple-nationsroll-down-hidden-field" >&lt;em&gt;&lt;strong&gt;t1: create a  register form, inlucing the username, password, gender, hobbiesmultiple, nationsroll down hidden field&lt;/strong&gt;&lt;/em&gt;</a></li>
</ul>
</li>
<li><a href="#jquery" >jQuery</a>
<ul>
<li><a href="#attr" >attr</a></li>
<li><a href="#prop-checked-readonly-selected-disabled" >prop checked, readOnly, selected, disabled</a></li>
<li><a href="#xml" >xml</a></li>
</ul>
</li>
<li><a href="#servlet" >Servlet</a>
<ul>
<li><a href="#httpservlet" >HttpServlet</a></li>
<li><a href="#" >/</a></li>
<li><a href="#garbled-languagee" >garbled languagee</a></li>
</ul>
</li>
<li><a href="#javaee-three-tier-system-decouple" >JavaEE three-tier system, decouple</a></li>
<li><a href="#servlet-thymeleaf" >servlet thymeleaf</a>
<ul>
<li><a href="#index" >index</a></li>
<li><a href="#thymeleaf-%E8%A7%86%E5%9B%BE%E6%A8%A1%E6%9D%BF%E6%8A%80%E6%9C%AF" >Thymeleaf 视图模板技术</a></li>
<li><a href="#viewbaseservlet" >ViewBaseServlet</a></li>
<li><a href="#templateengine-%E7%94%A8%E6%B3%95" >TemplateEngine 用法</a></li>
<li><a href="#index-thif--thless-%E7%94%A8%E6%B3%95" >index th:if &amp;amp;&amp;amp; th:less 用法</a></li>
<li><a href="#webservleteditdo-putget-%E9%97%AE%E9%A2%98" >@WebServlet&amp;quot;/edit.do&amp;quot; put/get 问题</a></li>
</ul>
</li>
<li><a href="#%E5%BC%95%E8%BF%9B-dispatchservlet-%E5%90%8E%E4%BB%A3%E7%A0%81%E6%94%B9%E5%8F%98" >引进 dispatchServlet 后代码改变</a>
<ul>
<li><a href="#servlets-%E5%90%88%E5%B9%B6" >servlets 合并</a></li>
<li><a href="#%E5%8F%8D%E5%B0%84%E6%96%B9%E6%B3%95%E8%BF%99%E6%A0%B7%E5%8F%AF%E4%BB%A5%E5%A2%9E%E5%8A%A0%E6%9B%B4%E5%A4%9A%E7%9A%84-method%E8%80%8C%E4%B8%8D%E7%94%A8-switch-%E6%9D%A5%E5%A2%9E%E5%8A%A0%E4%BB%A3%E7%A0%81" >反射方法，这样可以增加更多的 method，而不用 switch 来增加代码</a></li>
<li><a href="#dispatcherservlet-%E5%BC%95%E5%85%A5" >dispatcherServlet 引入</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E6%8E%A7%E5%88%B6%E5%99%A8%E7%BB%9F%E4%B8%80%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0" >核心控制器统一获取参数</a></li>
</ul>
</li>
<li><a href="#mvc-service-%E5%92%8C-dao-%E8%AF%A6%E7%BB%86%E5%8C%BA%E5%88%86" >mvc service 和 dao 详细区分</a></li>
<li><a href="#mvc-ioc-%E8%80%A6%E5%90%88%E9%97%AE%E9%A2%98" >mvc ioc 耦合问题</a>
<ul>
<li><a href="#-%E8%80%A6%E5%90%88%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5" >&#43; 耦合/依赖注入</a></li>
<li><a href="#2-%E9%85%8D%E7%BD%AE-bean-%E5%B7%A5%E5%8E%82%E5%AE%9E%E7%8E%B0%E6%A0%B9%E6%8D%AE-id-%E8%8E%B7%E5%BE%97%E4%B8%80%E4%B8%AA%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD" >&lt;strong&gt;2. 配置 bean 工厂，实现根据 id 获得一个类的功能&lt;/strong&gt;</a></li>
<li><a href="#3-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0-bean-%E5%B7%A5%E5%8E%82" >&lt;strong&gt;3. 配置方法实现 bean 工厂&lt;/strong&gt;</a></li>
</ul>
</li>
<li><a href="#ioc---%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%AC--di---%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5" >IOC - 控制反转 / DI - 依赖注入</a>
<ul>
<li><a href="#%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%AC" >&lt;strong&gt;控制反转&lt;/strong&gt;</a></li>
<li><a href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5" >&lt;strong&gt;依赖注入&lt;/strong&gt;</a></li>
</ul>
</li>
<li><a href="#qqzone-%E4%B8%9A%E5%8A%A1%E9%9C%80%E6%B1%82" >QQZone 业务需求</a></li>
<li><a href="#three-tier-system-of-the-project" >three-tier system of the project</a>
<ul>
<li><a href="#sp1-create-sql-forms" >sp1. create sql forms</a></li>
<li><a href="#sp2-javebean-user-id-username-password-email" >sp2. JaveBean User id, username, password, email</a></li>
<li><a href="#sp3-jdbcutils" >sp3. JdbcUtils</a></li>
<li><a href="#sp4-basedao" >sp4. BaseDao</a></li>
<li><a href="#sp5-userdao--test" >sp5. UserDao &amp;amp;&amp;amp; test</a></li>
<li><a href="#sp6-userservice--test" >sp6. UserService &amp;amp;&amp;amp; test</a></li>
<li><a href="#sp7-web" >sp7. web</a></li>
</ul>
</li>
<li><a href="#file-upload-and-download" >file upload and download</a>
<ul>
<li><a href="#file-upload" >file upload</a></li>
<li><a href="#commos-fileuploadjar" >commos-fileupload.jar</a></li>
<li><a href="#fileupload" >fileupload</a></li>
<li><a href="#file-download" >file download</a></li>
</ul>
</li>
<li><a href="#cookie--session" >Cookie &amp;amp;&amp;amp; Session</a>
<ul>
<li><a href="#use-cookie-to-save-users-information" >use Cookie to save user&amp;rsquo;s information</a></li>
<li><a href="#session-to-invalidate-the-user-infomation" >Session to invalidate the user infomation</a></li>
</ul>
</li>
<li><a href="#order-module" >Order module</a>
<ul>
<li><a href="#order-page" >Order page</a></li>
</ul>
</li>
<li><a href="#filter" >Filter</a>
<ul>
<li><a href="#%E8%BF%87%E6%BB%A4%E5%99%A8-filter" >过滤器 Filter</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86" >事务管理</a>
<ul>
<li><a href="#%E6%B6%89%E5%8F%8A%E5%88%B0%E7%9A%84%E7%BB%84%E4%BB%B6" >涉及到的组件</a></li>
<li><a href="#threadlocal" >ThreadLocal</a></li>
<li><a href="#threadlocal-and-filter-manage-transactions" >ThreadLocal and Filter manage transactions</a></li>
<li><a href="#modify-jdbcutils" >modify JdbcUtils</a></li>
<li><a href="#basedao" >BaseDao</a></li>
<li><a href="#filter-add-try-catch-to-service" >Filter add try-catch to Service</a></li>
<li><a href="#throw-new-runexception-in-baseservlet-to-filter" >throw new RunException in BaseServlet to Filter</a></li>
<li><a href="#tomcat-display-error-page" >tomcat display error page</a></li>
</ul>
</li>
<li><a href="#listener" >listener</a>
<ul>
<li><a href="#contextloaderlistener" >ContextLoaderListener</a></li>
</ul>
</li>
<li><a href="#json" >JSON</a>
<ul>
<li><a href="#json--javabean" >JSON &amp;amp;&amp;amp; JavaBean</a></li>
<li><a href="#json--list" >JSON &amp;amp;&amp;amp; List</a></li>
<li><a href="#json--map" >JSON &amp;amp;&amp;amp; Map</a></li>
</ul>
</li>
<li><a href="#ajax" >AJAX</a></li>
<li><a href="#use-ajax-invalidate-the-username" >use AJAX invalidate the username</a></li>
<li><a href="#use-ajax-to-add-the-item-to-the-cart" >use AJAX to add the item to the cart</a></li>
</ul>
<!-- /TOC -->
<h3 id="filter">Filter</h3>
<p><a id="markdown-filter" name="filter"></a></p>
<figure><img src="/images/jwb9.png"
         alt="image"/><figcaption>
            <h4>servlets</h4>
        </figcaption>
</figure>

<blockquote>
<p>A -&gt;B -&gt; C demo3.service() -&gt; C -&gt; B -&gt; A</p>
</blockquote>
<h4 id="过滤器-filter">过滤器 Filter</h4>
<p><a id="markdown-%E8%BF%87%E6%BB%A4%E5%99%A8-filter" name="%E8%BF%87%E6%BB%A4%E5%99%A8-filter"></a></p>
<ul>
<li>
<p>Filter 也属于 Servlet 规范</p>
</li>
<li>
<p>Filter 开发步骤：新建类实现 Filter 接口，然后实现其中的三个方法：init、doFilter、destroy<br>
配置 Filter，可以用注解@WebFilter，也可以使用 xml 文件 <filter> <filter-mapping></p>
</li>
<li>
<p>Filter 在配置时，和 servlet 一样，也可以配置通配符，例如 @WebFilter(&quot;*.do&quot;)表示拦截所有以.do 结尾的请求</p>
</li>
<li>
<p>过滤器链</p>
<ul>
<li>执行的顺序依次是： A B C demo03 C2 B2 A2</li>
<li>如果采取的是注解的方式进行配置，那么过滤器链的拦截顺序是按照全类名的先后顺序排序的</li>
<li>如果采取的是 xml 的方式进行配置，那么按照配置的先后顺序进行排序</li>
</ul>
</li>
</ul>
<p>chorme:                                                               tomcat</p>
<ul>
<li>http://ip:port/project/resource  〰️ ▶️ Filter                         target rescouce
.                                                             authorized   ▶️   html, jsp, Servlet</li>
</ul>
<p>.                                 ◀️ 〰️ unauthorized</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@WebFilter</span><span class="o">(</span><span class="n">filterName</span> <span class="o">=</span><span class="s">&#34;ManagerFilter&#34;</span><span class="o">,</span> <span class="n">urlPatterns</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;/pages/manager/*&#34;</span><span class="o">,</span> <span class="s">&#34;/manager/bookServlet&#34;</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdminFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>
<span class="cm">/**
</span><span class="cm">* doFilter method
</span><span class="cm">*/</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">servletRequest</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">servletResponse</span><span class="o">,</span> <span class="n">FilterChain</span>
<span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
<span class="n">HttpServletRequest</span> <span class="n">httpServletRequest</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">servletRequest</span><span class="o">;</span>
<span class="n">HttpSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
<span class="n">Object</span> <span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">&#34;user&#34;</span><span class="o">);</span>
<span class="c1">// 
</span><span class="c1"></span><span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="n">servletRequest</span><span class="o">.</span><span class="na">getRequestDispatcher</span><span class="o">(</span><span class="s">&#34;/login.jsp&#34;</span><span class="o">).</span><span class="na">forward</span><span class="o">(</span><span class="n">servletRequest</span><span class="o">,</span><span class="n">servletResponse</span><span class="o">);</span>
<span class="k">return</span><span class="o">;</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="c1">// 
</span><span class="c1"></span><span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">servletRequest</span><span class="o">,</span><span class="n">servletResponse</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="事务管理">事务管理</h3>
<p><a id="markdown-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86" name="%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86"></a></p>
<h4 id="涉及到的组件">涉及到的组件</h4>
<p><a id="markdown-%E6%B6%89%E5%8F%8A%E5%88%B0%E7%9A%84%E7%BB%84%E4%BB%B6" name="%E6%B6%89%E5%8F%8A%E5%88%B0%E7%9A%84%E7%BB%84%E4%BB%B6"></a></p>
<ul>
<li>OpenSessionInViewFilter</li>
<li>TransactionManager</li>
<li>ThreadLocal</li>
<li>ConnUtil</li>
<li>BaseDAO</li>
</ul>
<h4 id="threadlocal">ThreadLocal</h4>
<p><a id="markdown-threadlocal" name="threadlocal"></a></p>
<ul>
<li>get() , set(obj)</li>
<li>ThreadLocal 称之为本地线程 。 我们可以通过 set 方法在当前线程上存储数据、通过 get 方法在当前线程上获取数据</li>
<li>set 方法源码分析：</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span> <span class="c1">//获取当前的线程
</span><span class="c1"></span>         <span class="n">ThreadLocalMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">getMap</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>    <span class="c1">//每一个线程都维护各自的一个容器（ThreadLocalMap）
</span><span class="c1"></span>         <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
             <span class="n">map</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>          <span class="c1">//这里的key对应的是ThreadLocal，因为我们的组件中需要传输（共享）的对象可能会有多个（不止Connection）
</span><span class="c1"></span>         <span class="k">else</span>
             <span class="n">createMap</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>           <span class="c1">//默认情况下map是没有初始化的，那么第一次往其中添加数据时，会去初始化
</span><span class="c1"></span>     <span class="o">}</span>
</code></pre></div><ul>
<li>get 方法源码分析</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">     <span class="kd">public</span> <span class="n">T</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span> <span class="c1">//获取当前的线程
</span><span class="c1"></span>         <span class="n">ThreadLocalMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">getMap</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>    <span class="c1">//获取和这个线程（企业）相关的ThreadLocalMap（也就是工作纽带的集合）
</span><span class="c1"></span>         <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">ThreadLocalMap</span><span class="o">.</span><span class="na">Entry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">getEntry</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>   <span class="c1">//this指的是ThreadLocal对象，通过它才能知道是哪一个工作纽带
</span><span class="c1"></span>             <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                 <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
                 <span class="n">T</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span><span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>     <span class="c1">//entry.value就可以获取到工具箱了
</span><span class="c1"></span>                 <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
             <span class="o">}</span>
         <span class="o">}</span>
         <span class="k">return</span> <span class="n">setInitialValue</span><span class="o">();</span>
     <span class="o">}</span>
</code></pre></div><figure><img src="/images/jwb10.png"
         alt="image"/><figcaption>
            <h4>servlets</h4>
        </figcaption>
</figure>

<figure><img src="/images/jwb11.png"
         alt="image"/><figcaption>
            <h4>servlets</h4>
        </figcaption>
</figure>

<figure><img src="/images/jwb12.png"
         alt="image"/><figcaption>
            <h4>servlets</h4>
        </figcaption>
</figure>

<h4 id="threadlocal-and-filter-manage-transactions">ThreadLocal and Filter manage transactions</h4>
<p><a id="markdown-threadlocal-and-filter-manage-transactions" name="threadlocal-and-filter-manage-transactions"></a></p>
<h4 id="modify-jdbcutils">modify JdbcUtils</h4>
<p><a id="markdown-modify-jdbcutils" name="modify-jdbcutils"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Connection</span><span class="o">&gt;</span> <span class="n">conns</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;&gt;();</span>
<span class="c1">//  Connection conn = null;
</span><span class="c1"></span><span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">conns</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</code></pre></div><h4 id="basedao">BaseDao</h4>
<p><a id="markdown-basedao" name="basedao"></a></p>
<h4 id="filter-add-try-catch-to-service">Filter add try-catch to Service</h4>
<p><a id="markdown-filter-add-try-catch-to-service" name="filter-add-try-catch-to-service"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@WebFilter</span><span class="o">(</span><span class="n">filterName</span> <span class="o">=</span><span class="s">&#34;TransactionFilter&#34;</span><span class="o">,</span> <span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">&#34;/*&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">servletRequest</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">servletResponse</span><span class="o">,</span> <span class="n">FilterChain</span>
<span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
<span class="k">try</span> <span class="o">{</span>
<span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">servletRequest</span><span class="o">,</span><span class="n">servletResponse</span><span class="o">);</span>
<span class="n">JdbcUtils</span><span class="o">.</span><span class="na">commitAndClose</span><span class="o">();</span><span class="c1">// 提交事务
</span><span class="c1"></span><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="n">JdbcUtils</span><span class="o">.</span><span class="na">rollbackAndClose</span><span class="o">();</span><span class="c1">//回滚事务
</span><span class="c1"></span><span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>
<span class="o">}</span>

</code></pre></div><h4 id="throw-new-runexception-in-baseservlet-to-filter">throw new RunException() in BaseServlet to Filter</h4>
<p><a id="markdown-throw-new-runexception-in-baseservlet-to-filter" name="throw-new-runexception-in-baseservlet-to-filter"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
<span class="k">try</span> <span class="o">{</span>
<span class="c1">// 
</span><span class="c1"></span><span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="n">action</span><span class="o">,</span> <span class="n">HttpServletRequest</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
<span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="c1">// System.out.println(method);
</span><span class="c1">// 
</span><span class="c1"></span><span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">req</span><span class="o">,</span> <span class="n">resp</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span><span class="c1">// throw new RunException Filter 
</span><span class="c1"></span><span class="o">}</span>
<span class="o">}</span>

</code></pre></div><h4 id="tomcat-display-error-page">tomcat display error page</h4>
<p><a id="markdown-tomcat-display-error-page" name="tomcat-display-error-page"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="o">&lt;</span><span class="n">error</span><span class="o">-</span><span class="n">page</span><span class="o">&gt;</span>
<span class="o">&lt;!--</span><span class="n">error</span><span class="o">-</span><span class="n">code</span> <span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">error</span><span class="o">-</span><span class="n">code</span><span class="o">&gt;</span><span class="n">500</span><span class="o">&lt;/</span><span class="n">error</span><span class="o">-</span><span class="n">code</span><span class="o">&gt;</span>
<span class="o">&lt;!--</span><span class="n">location</span><span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">location</span><span class="o">&gt;/</span><span class="n">pages</span><span class="o">/</span><span class="n">error</span><span class="o">/</span><span class="n">error500</span><span class="o">.</span><span class="na">jsp</span><span class="o">&lt;/</span><span class="n">location</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">error</span><span class="o">-</span><span class="n">page</span><span class="o">&gt;</span>
<span class="o">&lt;!--</span><span class="n">error</span><span class="o">-</span><span class="n">page</span> <span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">error</span><span class="o">-</span><span class="n">page</span><span class="o">&gt;</span>
<span class="o">&lt;!--</span><span class="n">error</span><span class="o">-</span><span class="n">code</span> <span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">error</span><span class="o">-</span><span class="n">code</span><span class="o">&gt;</span><span class="n">404</span><span class="o">&lt;/</span><span class="n">error</span><span class="o">-</span><span class="n">code</span><span class="o">&gt;</span>
<span class="o">&lt;!--</span><span class="n">location</span> <span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">location</span><span class="o">&gt;/</span><span class="n">pages</span><span class="o">/</span><span class="n">error</span><span class="o">/</span><span class="n">error404</span><span class="o">.</span><span class="na">jsp</span><span class="o">&lt;/</span><span class="n">location</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">error</span><span class="o">-</span><span class="n">page</span><span class="o">&gt;</span>
</code></pre></div><h3 id="listener">listener</h3>
<p><a id="markdown-listener" name="listener"></a></p>
<ul>
<li>ServletContextListener - 监听 ServletContext 对象的创建和销毁的过程</li>
<li>HttpSessionListener - 监听 HttpSession 对象的创建和销毁的过程</li>
<li>ServletRequestListener - 监听 ServletRequest 对象的创建和销毁的过程</li>
<li>ServletContextAttributeListener - 监听 ServletContext 的保存作用域的改动(add,remove,replace)</li>
<li>HttpSessionAttributeListener - 监听 HttpSession 的保存作用域的改动(add,remove,replace)</li>
<li>ServletRequestAttributeListener - 监听 ServletRequest 的保存作用域的改动(add,remove,replace)</li>
<li>HttpSessionBindingListener - 监听某个对象在 Session 域中的创建与移除</li>
<li>HttpSessionActivationListener - 监听某个对象在 Session 域中的序列化和反序列化</li>
</ul>
<h4 id="contextloaderlistener">ContextLoaderListener</h4>
<p><a id="markdown-contextloaderlistener" name="contextloaderlistener"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="c1">//监听上下文启动，在上下文启动的时候去创建IOC容器,然后将其保存到application作用域
</span><span class="c1">//后面中央控制器再从application作用域中去获取IOC容器
</span><span class="c1"></span><span class="nd">@WebListener</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContextLoaderListener</span> <span class="kd">implements</span> <span class="n">ServletContextListener</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextInitialized</span><span class="o">(</span><span class="n">ServletContextEvent</span> <span class="n">servletContextEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//1.获取ServletContext对象
</span><span class="c1"></span>        <span class="n">ServletContext</span> <span class="n">application</span> <span class="o">=</span> <span class="n">servletContextEvent</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">();</span>
        <span class="c1">//2.获取上下文的初始化参数
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="na">getInitParameter</span><span class="o">(</span><span class="s">&#34;contextConfigLocation&#34;</span><span class="o">);</span>
        <span class="c1">//3.创建IOC容器
</span><span class="c1"></span>        <span class="n">BeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
        <span class="c1">//4.将IOC容器保存到application作用域
</span><span class="c1"></span>        <span class="n">application</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&#34;beanFactory&#34;</span><span class="o">,</span><span class="n">beanFactory</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextDestroyed</span><span class="o">(</span><span class="n">ServletContextEvent</span> <span class="n">servletContextEvent</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><figure><img src="/images/jwb13.png"
         alt="image"/><figcaption>
            <h4>servlets</h4>
        </figcaption>
</figure>

<h3 id="json">JSON</h3>
<p><a id="markdown-json" name="json"></a></p>
<h4 id="json--javabean">JSON &amp;&amp; JavaBean</h4>
<p><a id="markdown-json-%26%26-javabean" name="json-%26%26-javabean"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="n">1</span><span class="o">,</span><span class="s">&#34;AA&#34;</span><span class="o">);</span>
<span class="n">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">();</span>
<span class="n">String</span> <span class="n">personJsonString</span> <span class="o">=</span> <span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">personJsonString</span><span class="o">);</span>

<span class="n">Person</span> <span class="n">person1</span> <span class="o">=</span> <span class="n">gson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">personJsonString</span><span class="o">,</span> <span class="n">Person</span><span class="o">.</span><span class="na">class</span>
</code></pre></div><h4 id="json--list">JSON &amp;&amp; List</h4>
<p><a id="markdown-json-%26%26-list" name="json-%26%26-list"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">personList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="s">&#34;AA&#34;</span><span class="o">));</span>
<span class="n">personList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="s">&#34;BB&#34;</span><span class="o">));</span>

<span class="n">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">();</span>
<span class="c1">// transfer to json string
</span><span class="c1"></span><span class="n">String</span> <span class="n">personJsonString</span> <span class="o">=</span> <span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">personList</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">personJsonString</span><span class="o">);</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">gson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">personJsonString</span><span class="o">,</span> <span class="k">new</span> <span class="n">PersonListType</span><span class="o">().</span><span class="na">getType</span><span class="o">());</span>
</code></pre></div><h4 id="json--map">JSON &amp;&amp; Map</h4>
<p><a id="markdown-json-%26%26-map" name="json-%26%26-map"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;()</span>
<span class="n">personList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="s">&#34;AA&#34;</span><span class="o">));</span>
<span class="n">personList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="s">&#34;BB&#34;</span><span class="o">));</span>

<span class="n">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">();</span>
<span class="c1">// transfer to json string
</span><span class="c1"></span><span class="n">String</span> <span class="n">personJsonString</span> <span class="o">=</span> <span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">personMap</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">personJsonString</span><span class="o">);</span>

<span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personMap2</span> <span class="o">=</span> <span class="n">gson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">personJsonString</span><span class="o">,</span> <span class="k">new</span> <span class="n">TypeToken</span><span class="o">&lt;</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span><span class="n">Person</span><span class="o">&gt;&gt;(){}.</span><span class="na">getType</span><span class="o">());</span>
</code></pre></div><h3 id="ajax">AJAX</h3>
<p><a id="markdown-ajax" name="ajax"></a></p>
<h3 id="use-ajax-invalidate-the-username">use AJAX invalidate the username</h3>
<p><a id="markdown-use-ajax-invalidate-the-username" name="use-ajax-invalidate-the-username"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">ajaxExistsUsername</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span>
<span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="c1">// get username
</span><span class="c1"></span><span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">);</span>
<span class="c1">//  userService.existsUsername();
</span><span class="c1"></span><span class="kt">boolean</span> <span class="n">existsUsername</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">existsUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
<span class="c1">// 
</span><span class="c1"></span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;existsUsername&#34;</span><span class="o">,</span><span class="n">existsUsername</span><span class="o">);</span>
<span class="n">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">();</span>
<span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">resultMap</span><span class="o">);</span>
<span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">$</span><span class="o">(</span><span class="s">&#34;#username&#34;</span><span class="o">).</span><span class="na">blur</span><span class="o">(</span><span class="n">function</span> <span class="o">()</span> <span class="o">{</span>
<span class="c1">//1 get username
</span><span class="c1"></span><span class="n">var</span> <span class="n">username</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
<span class="n">$</span><span class="o">.</span><span class="na">getJSON</span><span class="o">(</span><span class="s">&#34;http://localhost:8080/book/userServlet&#34;</span><span class="o">,</span><span class="s">&#34;action=ajaxExistsUsername&amp;username=&#34;</span> <span class="o">+</span>
<span class="n">username</span><span class="o">,</span><span class="n">function</span> <span class="o">(</span><span class="n">data</span><span class="o">)</span> <span class="o">{</span>
<span class="k">if</span> <span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">existsUsername</span><span class="o">)</span> <span class="o">{</span>
<span class="n">$</span><span class="o">(</span><span class="s">&#34;span.errorMsg&#34;</span><span class="o">).</span><span class="na">text</span><span class="o">(</span><span class="s">&#34;xxxx！&#34;</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="n">$</span><span class="o">(</span><span class="s">&#34;span.errorMsg&#34;</span><span class="o">).</span><span class="na">text</span><span class="o">(</span><span class="s">&#34;xxxx！&#34;</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">});</span>
<span class="o">});</span>
</code></pre></div><h3 id="use-ajax-to-add-the-item-to-the-cart">use AJAX to add the item to the cart</h3>
<p><a id="markdown-use-ajax-to-add-the-item-to-the-cart" name="use-ajax-to-add-the-item-to-the-cart"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">addItem</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>

<span class="c1">//        System.out.println(&#34;bookId: &#34; + request.getParameter(&#34;id&#34;));
</span><span class="c1"></span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;request head reference value: &#34;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">&#34;Referer&#34;</span><span class="o">));</span>
<span class="c1">//        2.1 : 获取请求的参数，商品编号
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">WebUtils</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">),</span> <span class="n">0</span><span class="o">);</span>
<span class="c1">//        2.2： 调用bookService.queryBookById(id): Book得到图书的信息
</span><span class="c1"></span>        <span class="n">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="n">bookService</span><span class="o">.</span><span class="na">queryBookById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
<span class="c1">//        2.3： 把图书信息，转换成CartItem商品项
</span><span class="c1"></span>        <span class="n">CartItem</span> <span class="n">cartItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CartItem</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">book</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">1</span><span class="o">,</span> <span class="n">book</span><span class="o">.</span><span class="na">getPrice</span><span class="o">(),</span> <span class="n">book</span><span class="o">.</span><span class="na">getPrice</span><span class="o">());</span>
<span class="c1">//        2.4: 调用Cart.addItem(CartItem);添加商品项
</span><span class="c1"></span>        <span class="n">Cart</span> <span class="n">cart</span> <span class="o">=</span> <span class="o">(</span><span class="n">Cart</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">&#34;cart&#34;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cart</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cart</span><span class="o">();</span>
            <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&#34;cart&#34;</span><span class="o">,</span> <span class="n">cart</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">cart</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="n">cartItem</span><span class="o">);</span>

<span class="c1">//        2.5: 重定向回商品列表页面
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">cart</span><span class="o">);</span>
        <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&#34;lastName&#34;</span><span class="o">,</span> <span class="n">cartItem</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">());</span>

<span class="c1">//use AJAX to add the item to the cart
</span><span class="c1"></span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;();</span>
<span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;totalCount&#34;</span><span class="o">,</span> <span class="n">cart</span><span class="o">.</span><span class="na">getTotalCount</span><span class="o">());</span>
<span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;lastName&#34;</span><span class="o">,</span><span class="n">cartItem</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
<span class="n">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">();</span>
<span class="n">String</span> <span class="n">resultMapJsonString</span> <span class="o">=</span> <span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">resultMap</span><span class="o">);</span>
<span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">resultMapJsonString</span><span class="o">);</span>

    <span class="o">}</span>
</code></pre></div><hr>
<p><a href="https://rileyshen.github.io/post/javaweb2/" >javaweb2</a>
<a href="https://rileyshen.github.io/post/javaweb3/" >javaweb3</a>
<a href="https://rileyshen.github.io/post/javaweb4/" >javaweb4</a>
<a href="https://rileyshen.github.io/post/javaweb5/" >javaweb5</a>
<a href="https://rileyshen.github.io/post/spring/" >spring</a>
<a href="https://rileyshen.github.io/post/springmvc/" >springmvc</a></p></div>
    <div class="post-footer">
        <div class="info">
            
            <span class="separator"><a class="tag" href="/tags/javaee-project/">javaEE project</a><a class="tag" href="/tags/javaee-web/">javaEE web</a><a class="tag" href="/tags/three-tier-system/">Three-tier system</a><a class="tag" href="/tags/thymeleaf/">Thymeleaf</a><a class="tag" href="/tags/templateengine%2eprocess/">TemplateEngine.process</a></span>
        </div>
    </div>

    
</div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="/js/medium-zoom.min.83cb1dd5fea8d42d87d1e601a07faa73089ad0ef9ccfe5daf6041289ebcc4e46.js"
        integrity="sha256-g8sd1f6o1C2H0eYBoH&#43;qcwia0O&#43;cz&#43;Xa9gQSievMTkY="
        crossorigin="anonymous"></script>
<script async defer src="//latest.js"></script>
<noscript><img src="//noscript.gif" alt=""/></noscript>

</body>

</html>
